---
title: "Họ Việt"
author: "Duc Du, Nguyen Le Anh"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: lazyhtml_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
rm(list = ls(all.names = TRUE))
library(rmarkdown)
library(knitr)
library(markdown)
library(lazyrmd)

knitr::opts_chunk$set(echo = FALSE, 
                      cache=TRUE,
                      autodep = TRUE,
                      lazy = TRUE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE,
                      fig.width = 33,
                      fig.height = 49)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(data.table)
library(DT)
library(lubridate)
library(viridis)
library(sf)
library(ggpubr)
library(flextable)
library(scales)
library(ggtext)
library(glue)
library(geosphere)

options(scipen=999, digits = 3)
options(max.print=1000000)
```

```{r load data, message=FALSE, warning=FALSE}
load("data/hoviet.RData")
```

# Tổng họ Việt Nam

```{r, results='hide', message=FALSE, warning=FALSE}
data_ho_overall <- data_ho_overall %>%
  mutate(pro.pop=(songuoi/sum(songuoi))*100)

data_ho_top1000 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top1000 <- head(data_ho_top1000, n=1000)

data_ho_top500 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top500 <- head(data_ho_top500, n=500)

data_ho_top200 <- data_ho_overall %>%
  arrange(desc(pro.pop))
data_ho_top200 <- head(data_ho_top200, n=200)

data_ho_top150 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top150 <- data_ho_top150 %>% slice(101:150)

data_ho_top100 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top100 <- data_ho_top100 %>% slice(51:100)

data_ho_top50 <- data_ho_overall %>%
  arrange(desc(pro.pop))
data_ho_top50 <- head(data_ho_top50, n=50)

data_ho_top20 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top20 <- head(data_ho_top20, n=20)

data_ho_top10 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top10 <- head(data_ho_top10, n=10)
```

## Top 50 họ cao nhất cả nước

```{r, lazy=TRUE}
ggplot(data = data_ho_top50, aes(x = reorder(Ho, songuoi, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  geom_text(aes(label = paste(round(pro.pop, 1), "%", sep = ""), y = pro.pop + 1), size = 10) +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 40, by = 10)) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 30),
        axis.text.y = element_text(size = 30),
        plot.title = element_text(size = 45),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 50 họ có tỉ lệ cao nhất")
```

## Phân bố mật độ tỉ lệ từng họ

```{r}
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
dang_sf <- dat_sf %>% mutate(prop.dang=(sum(subset(., Ho=="Đặng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đặng")
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
ho_sf <- dat_sf %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
ha_sf <- dat_sf %>% mutate(prop.ha=(sum(subset(., Ho=="Hà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hà")
dao_sf <- dat_sf %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
luong_sf <- dat_sf %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
cao_sf <- dat_sf %>% mutate(prop.cao=(sum(subset(., Ho=="Cao")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cao")
lo_sf <- dat_sf %>% mutate(prop.lo=(sum(subset(., Ho=="Lò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lò")
lam_sf <- dat_sf %>% mutate(prop.lam=(sum(subset(., Ho=="Lâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lâm")
luu_sf <- dat_sf %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
ta_sf <- dat_sf %>% mutate(prop.ta=(sum(subset(., Ho=="Tạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tạ")
thach_sf <- dat_sf %>% mutate(prop.thach=(sum(subset(., Ho=="Thạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thạch")
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
y_sf <- dat_sf %>% mutate(prop.y=(sum(subset(., Ho=="Y")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Y")
vi_sf <- dat_sf %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
chu_sf <- dat_sf %>% mutate(prop.chu=(sum(subset(., Ho=="Chu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chu")
nong_sf <- dat_sf %>% mutate(prop.nong=(sum(subset(., Ho=="Nông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nông")
to_sf <- dat_sf %>% mutate(prop.to=(sum(subset(., Ho=="Tô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tô")
thai_sf <- dat_sf %>% mutate(prop.thai=(sum(subset(., Ho=="Thái")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thái")
chau_sf <- dat_sf %>% mutate(prop.chau=(sum(subset(., Ho=="Châu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Châu")
giang_sf <- dat_sf %>% mutate(prop.giang=(sum(subset(., Ho=="Giàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giàng")
vuong_sf <- dat_sf %>% mutate(prop.vuong=(sum(subset(., Ho=="Vương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vương")
h_sf <- dat_sf %>% mutate(prop.h=(sum(subset(., Ho=="H")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H")
quach_sf <- dat_sf %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
vang_sf <- dat_sf %>% mutate(prop.vang=(sum(subset(., Ho=="Vàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vàng")
danh_sf <- dat_sf %>% mutate(prop.danh=(sum(subset(., Ho=="Danh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Danh")
luong2_sf <- dat_sf %>% mutate(prop.luong2=(sum(subset(., Ho=="Lường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lường")
dam_sf <- dat_sf %>% mutate(prop.dam=(sum(subset(., Ho=="Đàm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đàm")
sung_sf <- dat_sf %>% mutate(prop.sung=(sum(subset(., Ho=="Sùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sùng")
thi_sf <- dat_sf %>% mutate(prop.thi=(sum(subset(., Ho=="Thị")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thị")
a_sf <- dat_sf %>% mutate(prop.a=(sum(subset(., Ho=="A")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="A")
```

```{r}
nguyen_his <- nguyen_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nguyen_sf$pro.pop), sd = sd(nguyen_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Nguyễn")

tran_his <- tran_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(tran_sf$pro.pop), sd = sd(tran_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Trần")

le_his <- le_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(le_sf$pro.pop), sd = sd(le_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lê")

pham_his <- pham_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(pham_sf$pro.pop), sd = sd(pham_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Phạm")

hoang_his <- hoang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(hoang_sf$pro.pop), sd = sd(hoang_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Hoàng")

bui_his <- bui_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(bui_sf$pro.pop), sd = sd(bui_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Bùi")

vu_his <- vu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vu_sf$pro.pop), sd = sd(vu_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vũ")

vo_his <- vo_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vo_sf$pro.pop), sd = sd(vo_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Võ")

phan_his <- phan_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phan_sf$pro.pop), sd = sd(phan_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Phan")

do_his <- do_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(do_sf$pro.pop), sd = sd(do_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đỗ")

huynh_his <- huynh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(huynh_sf$pro.pop), sd = sd(huynh_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Huỳnh")

dang_his <- dang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dang_sf$pro.pop), sd = sd(dang_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đặng")

ngo_his <- ngo_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ngo_sf$pro.pop), sd = sd(ngo_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Ngô")

truong_his <- truong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(truong_sf$pro.pop), sd = sd(truong_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Trương")

dinh_his <- dinh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dinh_sf$pro.pop), sd = sd(dinh_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đinh")

duong_his <- duong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(duong_sf$pro.pop), sd = sd(duong_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Dương")

ho_his <- ho_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ho_sf$pro.pop), sd = sd(ho_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Hồ")

ha_his <- ha_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ha_sf$pro.pop), sd = sd(ha_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Hà")

dao_his <- dao_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dao_sf$pro.pop), sd = sd(dao_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đào")

doan_his <- doan_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(doan_sf$pro.pop), sd = sd(doan_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đoàn")

ly_his <- ly_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ly_sf$pro.pop), sd = sd(ly_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lý")

trinh_his <- trinh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trinh_sf$pro.pop), sd = sd(trinh_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Trịnh")

mai_his <- mai_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(mai_sf$pro.pop), sd = sd(mai_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Mai")

luong_his <- luong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong_sf$pro.pop), sd = sd(luong_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lương")

cao_his <- cao_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(cao_sf$pro.pop), sd = sd(cao_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Cao")

lam_his <- lam_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lam_sf$pro.pop), sd = sd(lam_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lâm")

lo_his <- lo_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lo_sf$pro.pop), sd = sd(lo_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lò")

luu_his <- luu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luu_sf$pro.pop), sd = sd(luu_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lưu")

phung_his <- phung_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phung_sf$pro.pop), sd = sd(phung_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Phùng")

ta_his <- ta_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ta_sf$pro.pop), sd = sd(ta_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Tạ")

thach_his <- thach_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thach_sf$pro.pop), sd = sd(thach_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Thạch")

trieu_his <- trieu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trieu_sf$pro.pop), sd = sd(trieu_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Triệu")

y_his <- y_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(y_sf$pro.pop), sd = sd(y_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Y")

vi_his <- vi_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vi_sf$pro.pop), sd = sd(vi_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vi")

chu_his <- chu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chu_sf$pro.pop), sd = sd(chu_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Chu")

nong_his <- nong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nong_sf$pro.pop), sd = sd(nong_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Nông")

to_his <- to_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(to_sf$pro.pop), sd = sd(to_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Tô")

thai_his <- thai_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thai_sf$pro.pop), sd = sd(thai_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Thái")

chau_his <- chau_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chau_sf$pro.pop), sd = sd(chau_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Châu")

giang_his <- giang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(giang_sf$pro.pop), sd = sd(giang_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Giàng")

vuong_his <- vuong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vuong_sf$pro.pop), sd = sd(vuong_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vương")

h_his <- h_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(h_sf$pro.pop), sd = sd(h_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("H")

quach_his <- quach_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(quach_sf$pro.pop), sd = sd(quach_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Quách")

vang_his <- vang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vang_sf$pro.pop), sd = sd(vang_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vàng")

danh_his <- danh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(danh_sf$pro.pop), sd = sd(danh_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Danh")

luong2_his <- luong2_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong2_sf$pro.pop), sd = sd(luong2_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lường")

dam_his <- dam_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dam_sf$pro.pop), sd = sd(dam_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đàm")

sung_his <- sung_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(sung_sf$pro.pop), sd = sd(sung_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Sùng")

thi_his <- thi_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thi_sf$pro.pop), sd = sd(thi_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Thị")

a_his <- a_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(a_sf$pro.pop), sd = sd(a_sf$pro.pop))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("A")
```

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ggarrange(nguyen_his, tran_his, le_his, pham_his, hoang_his,
          bui_his, vu_his, vo_his, phan_his, do_his,
          huynh_his, dang_his, ngo_his, truong_his, dinh_his,
          ho_his, duong_his, ha_his, dao_his, ly_his,
          doan_his, trinh_his, mai_his, luong_his, cao_his,
          lo_his, lam_his, luu_his, phung_his, ta_his,
          thach_his, y_his, trieu_his, vi_his, chu_his,
          nong_his, to_his, thai_his, chau_his, giang_his,
          vuong_his, h_his, quach_his, vang_his, danh_his,
          luong2_his, dam_his, sung_his, thi_his, a_his,
          ncol = 5, nrow = 10)
```

## Phân bố mật độ từng họ

```{r}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
dang_sff <- dat_sff %>% mutate(prop.dang=(sum(subset(., Ho=="Đặng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đặng")
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
ho_sff <- dat_sff %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
ha_sff <- dat_sff %>% mutate(prop.ha=(sum(subset(., Ho=="Hà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hà")
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
cao_sff <- dat_sff %>% mutate(prop.cao=(sum(subset(., Ho=="Cao")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cao")
lo_sff <- dat_sff %>% mutate(prop.lo=(sum(subset(., Ho=="Lò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lò")
lam_sff <- dat_sff %>% mutate(prop.lam=(sum(subset(., Ho=="Lâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lâm")
luu_sff <- dat_sff %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
ta_sff <- dat_sff %>% mutate(prop.ta=(sum(subset(., Ho=="Tạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tạ")
thach_sff <- dat_sff %>% mutate(prop.thach=(sum(subset(., Ho=="Thạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thạch")
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
y_sff <- dat_sff %>% mutate(prop.y=(sum(subset(., Ho=="Y")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Y")
vi_sff <- dat_sff %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
chu_sff <- dat_sff %>% mutate(prop.chu=(sum(subset(., Ho=="Chu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chu")
nong_sff <- dat_sff %>% mutate(prop.nong=(sum(subset(., Ho=="Nông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nông")
to_sff <- dat_sff %>% mutate(prop.to=(sum(subset(., Ho=="Tô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tô")
thai_sff <- dat_sff %>% mutate(prop.thai=(sum(subset(., Ho=="Thái")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thái")
chau_sff <- dat_sff %>% mutate(prop.chau=(sum(subset(., Ho=="Châu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Châu")
giang_sff <- dat_sff %>% mutate(prop.giang=(sum(subset(., Ho=="Giàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giàng")
vuong_sff <- dat_sff %>% mutate(prop.vuong=(sum(subset(., Ho=="Vương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vương")
h_sff <- dat_sff %>% mutate(prop.h=(sum(subset(., Ho=="H")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H")
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
vang_sff <- dat_sff %>% mutate(prop.vang=(sum(subset(., Ho=="Vàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vàng")
danh_sff <- dat_sff %>% mutate(prop.danh=(sum(subset(., Ho=="Danh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Danh")
luong2_sff <- dat_sff %>% mutate(prop.luong2=(sum(subset(., Ho=="Lường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lường")
dam_sff <- dat_sff %>% mutate(prop.dam=(sum(subset(., Ho=="Đàm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đàm")
sung_sff <- dat_sff %>% mutate(prop.sung=(sum(subset(., Ho=="Sùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sùng")
thi_sff <- dat_sff %>% mutate(prop.thi=(sum(subset(., Ho=="Thị")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thị")
a_sff <- dat_sff %>% mutate(prop.a=(sum(subset(., Ho=="A")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="A")
```

```{r}
nguyen_hisf <- nguyen_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nguyen_sff$songuoi_km), sd = sd(nguyen_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Nguyễn")

tran_hisf <- tran_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(tran_sff$songuoi_km), sd = sd(tran_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Trần")

le_hisf <- le_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(le_sff$songuoi_km), sd = sd(le_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lê")

pham_hisf <- pham_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(pham_sff$songuoi_km), sd = sd(pham_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Phạm")

hoang_hisf <- hoang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(hoang_sff$songuoi_km), sd = sd(hoang_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Hoàng")

bui_hisf <- bui_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(bui_sff$songuoi_km), sd = sd(bui_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Bùi")

vu_hisf <- vu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vu_sff$songuoi_km), sd = sd(vu_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vũ")

vo_hisf <- vo_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vo_sff$songuoi_km), sd = sd(vo_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Võ")

phan_hisf <- phan_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phan_sff$songuoi_km), sd = sd(phan_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Phan")

do_hisf <- do_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(do_sff$songuoi_km), sd = sd(do_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đỗ")

huynh_hisf <- huynh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(huynh_sff$songuoi_km), sd = sd(huynh_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Huỳnh")

dang_hisf <- dang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dang_sff$songuoi_km), sd = sd(dang_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đặng")

ngo_hisf <- ngo_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ngo_sff$songuoi_km), sd = sd(ngo_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Ngô")

truong_hisf <- truong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(truong_sff$songuoi_km), sd = sd(truong_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Trương")

dinh_hisf <- dinh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dinh_sff$songuoi_km), sd = sd(dinh_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đinh")

duong_hisf <- duong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(duong_sff$songuoi_km), sd = sd(duong_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Dương")

ho_hisf <- ho_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ho_sff$songuoi_km), sd = sd(ho_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Hồ")

ha_hisf <- ha_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ha_sff$songuoi_km), sd = sd(ha_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Hà")

dao_hisf <- dao_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dao_sff$songuoi_km), sd = sd(dao_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đào")

doan_hisf <- doan_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(doan_sff$songuoi_km), sd = sd(doan_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đoàn")

ly_hisf <- ly_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ly_sff$songuoi_km), sd = sd(ly_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lý")

trinh_hisf <- trinh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trinh_sff$songuoi_km), sd = sd(trinh_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Trịnh")

mai_hisf <- mai_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(mai_sff$songuoi_km), sd = sd(mai_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Mai")

luong_hisf <- luong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong_sff$songuoi_km), sd = sd(luong_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lương")

cao_hisf <- cao_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(cao_sff$songuoi_km), sd = sd(cao_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Cao")

lam_hisf <- lam_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lam_sff$songuoi_km), sd = sd(lam_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lâm")

lo_hisf <- lo_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lo_sff$songuoi_km), sd = sd(lo_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lò")

luu_hisf <- luu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luu_sff$songuoi_km), sd = sd(luu_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lưu")

phung_hisf <- phung_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phung_sff$songuoi_km), sd = sd(phung_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Phùng")

ta_hisf <- ta_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ta_sff$songuoi_km), sd = sd(ta_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Tạ")

thach_hisf <- thach_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thach_sff$songuoi_km), sd = sd(thach_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Thạch")

trieu_hisf <- trieu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trieu_sff$songuoi_km), sd = sd(trieu_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Triệu")

y_hisf <- y_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(y_sff$songuoi_km), sd = sd(y_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Y")

vi_hisf <- vi_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vi_sff$songuoi_km), sd = sd(vi_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vi")

chu_hisf <- chu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chu_sff$songuoi_km), sd = sd(chu_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Chu")

nong_hisf <- nong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nong_sff$songuoi_km), sd = sd(nong_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Nông")

to_hisf <- to_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(to_sff$songuoi_km), sd = sd(to_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Tô")

thai_hisf <- thai_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thai_sff$songuoi_km), sd = sd(thai_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Thái")

chau_hisf <- chau_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chau_sff$songuoi_km), sd = sd(chau_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Châu")

giang_hisf <- giang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(giang_sff$songuoi_km), sd = sd(giang_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Giàng")

vuong_hisf <- vuong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vuong_sff$songuoi_km), sd = sd(vuong_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vương")

h_hisf <- h_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(h_sff$songuoi_km), sd = sd(h_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("H")

quach_hisf <- quach_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(quach_sff$songuoi_km), sd = sd(quach_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Quách")

vang_hisf <- vang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vang_sff$songuoi_km), sd = sd(vang_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Vàng")

danh_hisf <- danh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(danh_sff$songuoi_km), sd = sd(danh_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Danh")

luong2_hisf <- luong2_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong2_sff$songuoi_km), sd = sd(luong2_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Lường")

dam_hisf <- dam_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dam_sff$songuoi_km), sd = sd(dam_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Đàm")

sung_hisf <- sung_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(sung_sff$songuoi_km), sd = sd(sung_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Sùng")

thi_hisf <- thi_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thi_sff$songuoi_km), sd = sd(thi_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("Thị")

a_hisf <- a_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(a_sff$songuoi_km), sd = sd(a_sff$songuoi_km))) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 20)) +
  ggtitle("A")
```

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ggarrange(nguyen_hisf, tran_hisf, le_hisf, pham_hisf, hoang_hisf,
          bui_hisf, vu_hisf, vo_hisf, phan_hisf, do_hisf,
          huynh_hisf, dang_hisf, ngo_hisf, truong_hisf, dinh_hisf,
          ho_hisf, duong_hisf, ha_hisf, dao_hisf, ly_hisf,
          doan_hisf, trinh_hisf, mai_hisf, luong_hisf, cao_hisf,
          lo_hisf, lam_hisf, luu_hisf, phung_hisf, ta_hisf,
          thach_hisf, y_hisf, trieu_hisf, vi_hisf, chu_hisf,
          nong_hisf, to_hisf, thai_hisf, chau_hisf, giang_hisf,
          vuong_hisf, h_hisf, quach_hisf, vang_hisf, danh_hisf,
          luong2_hisf, dam_hisf, sung_hisf, thi_hisf, a_hisf,
          ncol = 5, nrow = 10)
```

## Top 200 họ phổ biến nhất Việt Nam theo cả nước và tỉnh

```{r}
data_ho_top200 <- data_ho_overall %>%
  mutate(pro.pop=round(pro.pop, 2)) %>%
  arrange(desc(pro.pop))
data_ho_top200 <- head(data_ho_top200, n=200)

songuoi<-as.matrix(dat_sf$songuoi)
NAME_1 <- dat_sf$NAME_1
Ho <- dat_sf$Ho
data_ho_tinh_sum <- aggregate(songuoi, data.frame(NAME_1, Ho), sum) %>% setDT() %>%
  rename(songuoi=V1)
data_ho_tinh_sum <- data_ho_tinh_sum %>%
  group_by(NAME_1) %>%
  mutate(danso=sum(songuoi)) %>% ungroup() %>%
  mutate(pro.pop=round((songuoi/danso)*100,2)) %>% 
  filter(Ho %in% data_ho_top200$Ho) %>%
  select(NAME_1, Ho, pro.pop)

data_ho_tinh_wide <- data_ho_tinh_sum %>% spread(NAME_1, pro.pop)

data_ho_top200 <- merge(data_ho_top200 %>% select(Ho, pro.pop), data_ho_tinh_wide, by="Ho")
data_ho_top200[is.na(data_ho_top200)] <- 0
data_ho_top200 <- data_ho_top200 %>%
  arrange(desc(pro.pop)) %>%
  rownames_to_column() %>%
  rename("TT"=rowname,
         "Họ"=Ho,
         "Cả nước (%)"=pro.pop)
```

```{r, fig.width=49, fig.height=33}
mycolor <- function(x) {
  output <- ifelse(x == 0, "#FFFFFF",
                   ifelse(x < 1, "#6baed6",
                          ifelse(x < 5, "#fee5d9",
                                 ifelse(x < 10, "#fcae91",
                                        ifelse(x < 30, "#fb6a4a",
                                               ifelse(x < 60, "#cb181d", "#FFFFFF"))))))
  return(output)
}

mytab_cum <- function(label) {
  ft <- flextable(data_ho_top200) %>%
    fontsize(size = 7, part = "all") %>%
    set_caption(caption = label) %>%
    set_table_properties(width=1, layout = "autofit")

h_header <- max( dim_pretty(ft, part = "header")$widths)

ft %>%
  bg(j=c(-1), bg = mycolor) %>%
  valign(valign = "center", part = "header") %>%
  height(height = h_header * 0.8, part = "header") %>%
  hrule(i = 1, rule = "exact", part = "all") %>%
  width(width = 49)
}

mytab_cum(label = NULL)
```

# Hệ thống sông ngòi cả nước

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=nguyen_plot, color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_text(data=river3, mapping=aes(label = nam), stat = "sf_coordinates", position = "identity", check_overlap = T) +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sông ngòi Việt Nam")
```

# Phân bố dòng họ cả nước {.tabset}

Về vấn đề xác định các dòng họ trước thế kỷ thứ 10.

Theo quan điểm của tác giả, các dòng họ liên quan tới vua trước thế kỷ thứ 10 như Mai, Khúc, Dương, Phùng, Ngô không có sự biến động lớn kiểu như đổi họ Lý sang Nguyễn hay Trần sang các dòng họ khác. Như thế phân bố dòng họ tương đối ổn định trong một khu vực nhỏ. Phân bố ở khu vực nhỏ là vì đã trải qua 1000 năm, nên các dòng họ của vua đời sau lấn át. Phân bố tương đối ổn định vì không gây ra xung đột với các đời vua sau, kiểu như Lê, Lý, Trần, Nguyễn... 

## Mai

Mai Hắc Đế (梅黑帝; 670 – 723). 

Dã sử kể rằng
Mai An Tiêm vốn là con nuôi của Hùng Vương thứ XVII, được vua quý mến gả mị nương tức là nàng Ba cho. Sau vì làm phật ý vua, An Tiêm bị đày ra đảo hoang, tương truyền nay là vùng Nga Sơn, Thanh Hóa. Tại đây, An Tiêm cùng vợ chăm chỉ làm ăn. Một hôm, An Tiêm nhặt được hạt giống cây lạ do chim mang tới, anh đem gieo trồng và cuối cùng gây được giống dưa hấu quý, nhiều người tìm đến trao đổi, tiếng đồn khắp xa gần. Vua biết tin, xuống chiếu gọi về cho phục chức cũ. An Tiêm được coi là ông tổ của nghề trồng dưa hấu tại Việt Nam.

Đền thờ Mai An Tiêm dưới chân núi Mai An Tiêm ở Nga Sơn
Ngày nay, tại xã Nga Phú, huyện Nga Sơn, có một dãy núi mang tên Mai An Tiêm, tương truyền chính là hòn đảo xưa kia vợ chồng An Tiêm đi đày. Dưới chân núi này có đền thờ ông và được nhân dân địa phương tổ chức lễ hội vào ngày 12 đến 15 tháng Ba âm lịch hàng năm.
Tên thật của Mai Hắc Đế (梅黑帝; 670 – 723) là Mai Thúc Loan (梅叔鸞), người lãnh đạo thành công cuộc khởi nghĩa chống lại sự chiếm đóng của nhà Đường ở Việt Nam và xưng Đế. 

Mai Thúc Loan sinh vào năm Canh Ngọ (670) tại thôn Ngọc Trừng, Hoan Châu, nay thuộc huyện Nam Đàn, Nghệ An. Theo Việt Điện U Linh (do Lý Tế Xuyên soạn năm 1329), cha của Mai Thúc Loan là Mai Hoàn, mẹ là Mai An Hòa nguyên gốc Lộc Hà, Hà Tĩnh, lưu lạc sang vùng Nam Đàn, Nghệ An.

Theo sách Việt Sử Tiêu Án (Ngô Thì Sĩ viết năm 1775), Mai Thúc Loan là người làng Hương Lãm, huyện Nam Đường, nay là thị trấn Nam Đàn, tỉnh Nghệ An, dân lập đền thờ ông ở thôn chợ Sa Nam
Dịch nghĩa phần nói về Mai Hắc Đế trong "Cựu Đường Thư, Liệt truyện 134, Hoạn quan, Quyển 184". 

Những năm đầu niên hiệu Khai Nguyên (713-741), thủ lĩnh An Nam là Mai Huyền Thành làm phản, tự xưng là "Vua Đen" (Hắc Đế), chiêu tập quân 32 châu, ngoài liên kết với các nước Lâm Ấp, Chân Lạp và Kim Lân, giữ vùng biển nam, quân số có đến 40 vạn, đánh phá phủ thành An Nam. Tháng 7, mùa thu năm Khai Nguyên thứ 10, (Hoàng đế) Đường Huyền Tông, ra lời chiếu sai hoạn quan Tả Giám môn Vệ tướng quân là Dương Tư Húc và quan Đô hộ là Quang Sở Khách đem quân dánh dẹp. Tư Húc đến Lĩnh Nam, chiêu mộ con em bọn thủ lĩnh ở đó, người và ngựa được hơn mười vạn, theo đường cũ của Mã Viện mà tiến đánh bất ngờ. Bọn Huyền Thành chợt nghe tin quân (của Tư Húc) đến, hoảng sợ không nghĩ được kế gì, liền bị quan quân bắt hoặc chém chết tại trận, giết hết phe đảng, dồn xác chết thành đống rồi rút quân về.
Cuộc khởi nghĩa nổ ra tại Rú Đụn, còn gọi là Hùng Sơn (Nghệ An). Mai Thúc Loan lên ngôi vua, lấy hiệu là Mai Hắc Đế. Theo Việt điện u linh, Mai Hắc Đế mang mệnh thủy tức là nước, mà nước được tượng trưng là màu đen. Vì vậy, ông lấy hiệu là Hắc Đế để hợp với mệnh của mình. Một số nguồn cũng cho hay, ông lấy hiệu là Mai Hắc Đế vì ông có màu da đen. Ông cho xây thành lũy, lập kinh đô Vạn An (thuộc thị trấn Nam Đàn hiện nay), tích cực rèn tập tướng sỹ. Cuộc nổi dậy của ông được hưởng ứng rộng rãi ở trong nước và có cả sự liên kết với Lâm Ấp và Chân Lạp.

Do phân bố dòng họ có dạng phân bố chuẩn. Xét trên sơ đồ phân bố dòng họ do Đức Dư tổng hợp theo dữ liệu của TCTK, chúng ta có thể khẳng định:
1- Sự kiện về dòng họ vua Mai Hắc Đế là có thật
2- Dòng họ của Mai Hắc Đế phát tích ở vùng Nga Sơn thuộc Thanh Hóa, nơi có đền thờ Mai An Tiêm. Vào thời Mai Hắc Đế vùng này là bờ biển. 

Có vẻ như dã sử về Mai An Tiêm có chứa ở trong nó một phần nào đó sự thật. Không biết sự thật ấy có liên quan tới Mai Hắc Đế không.
Về nguyên nhân cuộc khởi nghĩa do Mai Thúc Loan lãnh đạo là sự phản kháng chống lại sự áp bức của chính quyền đô hộ Phương Bắc, Nhà Hán. Cuộc khởi nghĩa có lẽ đã xảy ra, bắt đầu ở vùng có mỏ khai thác thiếc, thuộc khu vực Nghệ An, Thanh Hóa, Hòa Bình.
Thiếc có thể là mối liên hệ giữa các cuộc khởi nghĩa từ Mai Thúc Loan tới Ngô Quyền. Thậm chí có thể là từ Lý Bí. 

Trước hết chúng ta truy tìm ngược lại đồ cống nạp cho Nhà Đường. 
Trong truyện 西门庆择吉佳期　应伯爵追欢喜庆 có đề cập tới "Bạch Lạp"
”妇人因指道：“奴这床后茶叶箱内，还藏三四十斤沉香、二百斤白蜡、两罐子水银、八十斤胡椒。你明日都搬出来，替我卖了银子，凑著你盖房子使。
Dịch nghĩa 
"Người phụ nữ nói," Trong hộp trà phía sau chiếc giường này, vẫn còn ba 34 lạng trầm hương, 200 lạng 白蜡 (白蠟), hai lọ thủy ngân, và 80 lạng 胡椒 (hạt tiêu). Ngày mai anh bán lấy tiền cho em và cùng anh xây nhà.
Trong truyện 愿同穴一时丧礼盛　守孤灵半夜口脂香
có đoạn đề cập tới 白蜡 là 
”有二青衣官吏跪下，毡包内捧出一对金段、一根沉香、两根白蜡、一分绵纸。黄主事道：“此乃宋公致赙之仪。那两封，是两司八府官员办酒分资──两司官十二员、府官八员，计二十二分，共一百零六两。
dịch nghĩa 
"Có hai viên chức quỳ xuống dâng hai miếng vàng, một miếng trầm hương, hai miếng sáp trắng, và một mẩu giấy để trong túi nỉ. Sư Hoàng nói: "Đây là nghi thức của Tống gia. Hai bức thư đó là để cho hai vị quan và tám quan xử uống rượu, trả công. ... " 
Ngày nay từ Bạch Lạp 白蜡 (白蠟) đều được hiểu là sáp ong. Tuy nhiên với bối cảnh như các đoạn văn trên thì có thể Bạch Lạp 白蜡 là kim loại quý màu trắng. Bạc 银 và Gang Trắng 白铁 được dùng ở  Tây Hán, Tống và Thanh khá lâu trước Công Nguyên, vì thế không thể có sự nhầm lẫn về con chữ. Vậy có lẽ Bạch Lạp 白蜡 là thiếc. 
Tìm trong Thái Bình hoàn vũ kí 太平寰宇記 (quyển 171) dòng 65 trong https://ctext.org/wiki.pl?if=gb&chapter=185380
phần  維基 -> 太平寰宇記 -> 卷一百七十一 
với nội dung
土産
貢白蠟　紫緋　騏麟竭　無名異
dịch 
Thổ sản: cống gồm bạch lạp 貢白蠟 (sáp trắng), tử phi, sừng tê, và nhiều thứ lạ không biết tên. 
Xem ra 貢白蠟 cống bạch lạp ở trong mục cống thổ sản (sản vật từ đất) thì gần như hàm ý là cống quặng. 
Trong phân tích này chúng ta tạm cho 白蠟 là thiếc.  
Hợp kim thiếc với đồng khiến cho đồng cứng hơn. Như vậy thời kỳ nhà Đường đã tiến hành khai thác Thiếc ở các mỏ lộ thiên. Nếu vậy thì khả năng 白蠟 là thiếc được dùng để cống nạp. Cũng có thể do bị áp bức mà người dân ở khu vực này đã phản kháng khởi nghĩa. 

Chúng ta đi tìm hiểu nhu cầu luyện kim vào thời kỳ này. 
Tài liệu về vị trí của các mỏ thiếc lộ thiên và sa khoáng ở Vn
https://thuvienphapluat.vn/.../Quyet-dinh-05-2008-QD-BCT...
https://hieuluat.vn/.../quyet-dinh-956-qd-ttg-thu-tuong...

Mỏ thiếc Hồ Kín ở tọa độ (19.904399, 105.324138) Thường Xuân thuộc Thanh Hoa cách Lam Kinh khoảng 9km và đều năm bên bờ sông Chu.  
Các hạt bụi núi lửa nhỏ hơn một micron, nhỏ hơn độ dày của một sợi tóc người khoảng một trăm lần. Nhưng chúng rộng hơn một chút so với bước sóng của ánh sáng đỏ, vì vậy khi bị tán xạ, chúng sẽ hấp thụ ánh sáng đỏ trong khi cho phép các màu khác đi qua. Điều này dẫn đến Mặt Trăng có màu xanh và ánh sáng mặt trời không tới được bề mặt trái đất. Như thế bụi mịn làm thay đổi nhiệt độ trên bề mặt trái đất khiến cho đồng hồ sinh học bị thay đổi. Điều này dẫn đến mất mùa và bệnh tật. 
Vào thời điểm năm 536 đến 545 đã có các đợt phun trào núi lửa với tổng sức mạnh nhiều nghìn megatonne. Chính các đợt phun trào núi lửa này đã làm suy yếu nhà Lương, là nguyên nhân sâu xa dẫn đến cuộc khởi nghĩa của Lý Bí, và sự hình thành ra nhà nước Vạn Xuân.
Cuộc khai quật được tiến hành trong khoảng thời gian từ năm 1991 đến 2007 đã khám phá 10500 bộ xương thời Trung cổ tại chợ Spitalfields ở phía đông London (Anh). Sau khi tiến hành xác định tuổi xương bằng phương pháp carbon phóng xạ, các chuyên gia của Bảo tàng Khảo cổ học London đã đi đến kết luận "đó là hài cốt của những nạn nhân trong đợt phun trào núi lửa hồi thế kỷ 13" - một trong những thảm họa núi lửa lớn nhất 10 nghìn năm qua.

Các nhà khoa học nói rằng đợt phun trào lớn đến nỗi khí sulfur đã tạo ra một tấm màn sường mù khô che phủ tầng bình lưu của trái đất, ngăn chặn ánh sáng mặt trời, thay đổi khí quyển và làm mát bề mặt trái đất, gây ra nạn đói, bệnh dịch và chết chóc. Địa điểm núi lửa chưa rõ ở đâu nhưng sự ảnh hưởng là toàn cầu và sức mạnh của đợt phun mạnh hơn gấp 8 lần so với đợt phun trào của núi Krakatoa (Indonesia) hồi năm 1883.

Krakatau là một đảo núi lửa thuộc vành đai lửa Thái Bình Dương. Cấu trúc địa lý của đảo đã thay đổi ít nhất hai lần, sau hai vụ phun trào núi lửa vào năm 535 và năm 1883.
27 tháng 8 năm 1883, vụ phun của núi lửa Krakatoa (Krakatau) có sức nổ của một quả bom 200 megatonne, giết chết hơn 36 nghìn người và làm nhiệt độ bề mặt trên toàn Trái Đất giảm trung bình 0.6°C trong nhiều tháng liên tiếp. Dư chấn của vụ nổ cũng đã tạo nên một cơn sóng thần cao tới 30m gây ra tình trạng lạnh bất thường kéo dài 4 năm sau vụ nổ. Tuyết rơi kỷ lục đã được ghi nhận trên toàn thế giới.

Vào năm 2013 tại Colle Gnifetti Glacier trên dãy núi Alps của Thụy Sĩ người ta đã khoan lấy mẫu cột băng dài 72m. Cột băng có đã ghi lại sự hiện diện trong suốt 2000 năm về tình trạng bụi bặm từ núi lửa, bão cát Sahara và các hoạt động của con người rơi xuống trung tâm châu Âu. Nhóm nghiên cứu đã dùng tia laser cắt dọc theo chiều dài cột băng ra những lát băng mỏng 120 micron, ứng một vài ngày hoặc vài tuần tuyết rơi. Mỗi lát được phân tích ra khoảng một chục thành tố. Phương pháp tiếp cận này cho phép nhóm nghiên cứu xác định các cơn bão, phun trào núi lửa và ô nhiễm bụi chì chi tiết đến từng tháng hoặc thậm chí ít hơn, trong suốt 2000 năm qua. Laura Hartman, sinh viên tốt nghiệp Đại học UM đã tìm thấy hai hạt thủy tinh núi lửa cực nhỏ trong cột băng sâu 72m này. Lớp băng ứng với thời điểm mùa xuân năm 536. Qua nghiên cứu Laura và Kurbatov nhận thấy hai hạt thủy tin trên giống như các hạt thủy tinh núi lửa được tìm thấy trước đó trong các hồ và vũng than bùn ở châu Âu và trong lõi băng ở Greenland. Nhóm nghiên cứu cho rằng từ đầu năm 536 cho tới 541 đã có nhiều đợt phun trào núi lửa tại Iceland và tro núi lửa phủ đầy Bắc Bán Cầu. Lớp tro đã làm mờ mặt Trời trong trong nhiều tháng khiến cho nhiệt độ mùa hè giảm xuống bớt 1.5°C đến 2.5°C. Mười năm từ 536 tới 545 là thời kỳ lạnh nhất trong suốt 2000 năm qua. 

Để so sánh.  Vụ phun của núi lửa Krakatoa (Krakatau) năm 1883 có sức nổ của một quả bom 200 megatonne, giết chết hơn 36 nghìn người mà nhiệt độ bề mặt trên toàn Trái Đất chỉ giảm trung bình 0.6°C trong nhiều tháng, thì có thể thấy quy mô của các đợt phun trào núi lửa từ năm 536 cho tới 541 khiến cho nhiệt độ giảm bớt từ 1.5°C đến 2.5°C trong mười năm từ 536 tới 545 lớn đến thế nào.
Kết hợp với nhà sử học Kyle Harper nhóm nghiên cứu đã tìm thấy tương ứng sự kiện thay đổi thời tiết này với những sự kiện có trong các biên niên sử. Cụ thể biên niên sử của Gaelic Ailen có ghi "Mất mùa vào năm 536". Biên niên sử của Ulster cũng có ghi "mất mùa những năm 536–539". Biên niên sử của Inisfallen có ghi “Nhiệt độ thấp, thậm chí có tuyết trong mùa hè vào tháng 8 ở Trung Quốc. Mất mùa trên diện rộng”. Vào năm 541 cho tới 543 bệnh dịch hạch “Justinian” đã giết chết 35% –55% dân số và đẩy nhanh sự sụp đổ của Đế Chế Đông La Mã. Như vậy là sự kiện núi lửa phun vào các năm 536 cho tới 541 đã để lại hậu quả là mất mùa, đói rét, dịch bệnh ở khắp các vùng phía nửa Bắc Bán Cầu như Ireland, Scandinavia, Mesopotamia và Trung Quốc.

Sự ảnh hưởng này được ghi nhận lịch sử các triều đại thay đổi liên tục
• 549-551 -- Lương Giản Văn Đế: 2 năm
• 552-555 -- Lương Nguyên Đế: 3 năm
• 555-557 -- Lương Kính Đế: 2 năm
• 555-562 -- Lương Tuyên Đế: 7 năm
• 585-587 -- Lương Hiếu Tĩnh Đế: 2 năm

Như vậy do các vụ nổ phun núi lửa Krakatau và các núi lửa vùng Iceland từ năm 536 tới 546 mà đói rét đã tàn phá và làm suy yếu Phương Bắc. Chế độ đô hộ của Phương Bắc đối với Việt Nam trở nên tàn khốc hơn. Chính do đói rét tàn phá làm suy yếu Phương Bắc mà cuộc khởi nghĩa của Lý Nam Đế đã thành công, làm sống lại dân tộc Việt Nam. Đại Việt Sử Ký toàn thư viết “Tháng Giêng năm 544, Lý Nam Đế lên ngôi vua tự xưng là Nam Việt Đế, đóng đô tại Long Biên, dựng quốc hiệu là Vạn Xuân”. Cuộc khởi nghĩa của Lý Nam Đế bắt đầu từ năm 541, là thời điểm Nhà Lương bị mất mùa vì thời tiết thay đổi cục bộ do bụi tro núi lửa ở Bắc Âu. Phải 4 năm sau, mãi tới năm 545 nhà Lương mới điều được quân sang trấn áp. Tuy nhiên tới năm 550 đội quân Nhà Lương này đã bị đánh bại. Nhà nước Vạn Xuân tồn tại được khoảng 70 năm cho tới năm 602.

Dịch bệnh và mất mùa khiến Nhà Lương sụp đổ. Nhà Tùy lên thay, đưa quân sang đánh chiếm Vạn Xuân. Do ở xa khu vực núi lửa phun mà vào đầu những năm 600 kinh tế Trung Quốc đã hồi phục.  Kinh tế thế giới đình trệ đến tận năm 640 mới có tín hiệu hồi phục. Tín hiệu hồi phục là việc tìm thấy bụi chì tăng đột biến trong lõi băng, đánh dấu sự hồi sinh của hoạt động khai thác bạc làm tiền tệ. Đỉnh chì thứ hai, vào năm 660, đánh dấu việc sự gia tăng của thương mại. Việc sử dụng bạc với số lượng lớn cho thấy quy mô giao thương toàn cầu là lớn. Hai pho tượng Phật khổng lồ tại Bamiyan, nằm trên tuyến đường độc đạo giữa các dãy núi cao 4000m, nối liên Trung Á với Ấn Độ. Với quy mô và kích cỡ hai pho tượng, pho tượng cao 58m – tạc năm 507 – trước thời kỳ núi lửa phun, và pho tượng cao 38m – tạc năm 554 – sau khi kinh tế thế giới đã hồi phục, cho thấy song song với mở rộng giao thương buôn bán toàn cầu là sự bành trướng tôn giáo.
Lượng chì có trong không khí là chỉ số cho thấy gành luyện kim trên thế giới hồi phục. 
https://agupubs.onlinelibrary.wiley.com/.../2017GH000064

Như thế rất có thể do sự bóc lột của nhà Đường đã dẫn tới cuộc khởi nghĩa của Mai Thúc Loan. 
Tôi rất muốn khảo sát lại các sự kiện lịch sử trong khoảng thời gian từ năm 700 cho tới trước năm 1000. Tôi cho rằng dòng họ của các đời vua trong khoảng thời gian này tương đối ổn định, vì sự kiện tiêu diệt lẫn nhau gần như là không có. Như thế vùng đất nơi Đại Việt Sử Ký Toàn Thư ghi nhận là nơi phát tích một dòng vua sẽ xuất hiện mật độ dòng họ của vua là lớn nhất. Do có sự di dân nên tỷ lệ dòng họ ở vùng đất phía Nam mang tính trung bình. Do văn hóa làng xã nên, ngoại trừ Hà Nội, tỷ lệ dòng họ ở các vùng miền Bắc là rất ổn định. 

Đây là các sự liện liên quan tới các họ như Mai, Khúc, Dương, Kiều, Ngô, Đinh, Đỗ...   
A. Phần định danh. 
Và xã Đường Lâm ở Sơn Tây ngày nay là một địa danh mới chỉ xuất hiện sau 1945 trên cơ sở hợp nhất một số làng của tổng Cam Thịnh, còn Đường Lâm cổ - năm 669 thời Đường Cao Tông, cùng với 2 huyện An Viễn và Phúc Lộc thuộc châu Phúc Lộc, 757 thời Đường Túc Tông đổi thành quận Đường Lâm, 758 bỏ quận lập lại châu Phúc Lộc - thuộc vùng tây nam Châu Ái. "Tân Đường Thư" có ghi: trong tất cả các châu, quận An Nam chỉ có 2 vùng cống nạp bạch lạp (thiếc trắng) là Phong Châu và Đường Lâm. Từ Đèo Ngang trở ra chỉ có hai vùng có mỏ thiếc sa khoáng là Tuyên Quang (đời Đường thuộc Phong Châu) và mỏ thiếc Bù Me, gần núi Bù Chò thuộc các huyện Thường Xuân, Thọ Xuân (Tây Nam Thanh Hóa), một phần ăn sang Quỳ Hợp, Quế Phong miền Tây Nghệ An.
Xét về khả năng chỉ có vùng Tuyên Quang - Thái Nguyên và Thanh Hóa - Nghệ An có thể là Đường Lâm. 

A. Phần Sử Liệu

Đoạn viết sau là thể hiện của Đại Việt Sử Ký Toàn Thư.

Họ Mai Hắc Đế
Mai Thúc Loan 670 - 722, thôn Ngọc Trừng, Hoan Châu (nay thuộc huyện Nam Đàn, Nghệ An). Theo Việt điện u linh, cha của Mai Thúc Loan là Mai Hoàn, mẹ là Mai An Hòa nguyên gốc Lộc Hà, Hà Tĩnh, lưu lạc sang vùng Nam Đàn, Nghệ An. Theo sách Việt sử tiêu án, Mai Thúc Loan là người làng Hương Lãm, huyện Nam Đường, nay là thị trấn Nam Đàn, tỉnh Nghệ An, dân lập đền thờ ông ở thôn chợ Sa Nam. 
Năm 722, Mai Thúc Loan đánh Tống Bình (Hà Nội nay) xưng là Hắc Đế, bên ngoài liên kết với người Lâm Ấp, Chân Lạp, số quân nói là 30 vạn. Vua Đường sai nội thị tả giám môn vệ tướng quân là Dương Tư Húc và Đô hộ là Quang Sở Khách đánh dẹp yên được.

Họ Trương, Họ Cao.
Thành nằm ở vị trí giữa Thành Hà Nội và sông Tô Lịch, thuộc quận Ba Đình của Hà Nội hiện nay. Đại La ban đầu do Trương Bá Nghi đắp vào năm 767 và được tu bổ Triệu Xương năm 791, Trương Chu 824, Lý Nguyên Gia dời phủ trị tới bên sông Tô Lịch, đắp một cái thành nhỏ, gọi là La Thành. La Thành được Cao Biền cho đắp lại to lớn hơn. Theo sử cũ thì La Thành do Cao Biền cho đắp có chu vi 6.6km; cao 8.67m, chân thành rộng 8.33m.

Họ Phùng 
Năm 791, Phùng Hưng dấy binh vây đánh An Nam đô hộ phủ Cao Chính Bình. Phùng Hưng là người ở Đường Lâm thuộc huyện Phúc Lộc Giao Châu (Nay là xã Cam Lâm, huyện Ba Vì, tỉnh Hà Tây.)

Họ Ngô 
"Ngô Quyền sinh ngày 12 tháng 3 năm Đinh Tỵ (17 tháng 4 năm 898) trong một dòng họ hào trưởng có thế lực ở châu Đường Lâm, Ái Châu. Cha là Ngô Mân làm chức châu mục Đường Lâm."
"Một hào trưởng người Ái Châu (thuộc Thanh Hóa ngày nay) là Dương Đình Nghệ nuôi 3000 con nuôi, mưu đồ khôi phục. Ngô Quyền lớn lên làm nha tướng cho Dương Đình Nghệ, được Dương Đình Nghệ gả con gái cho và giao quyền cai quản Ái châu, đất bản bộ của họ Dương. Năm 931, Dương Đình Nghệ phát binh từ Thanh Hóa ra Bắc đánh đuổi quân Nam Hán, đánh bại Lý Tiến và quân cứu viện do Trần Bảo chỉ huy, chiếm giữ bờ cõi nước Việt, xưng là Tiết độ sứ. Năm 937, hào trưởng đất Phong Châu là Kiều Công Tiễn sát hại Dương Đình Nghệ, trở thành vị Tĩnh Hải quân Tiết độ sứ cuối cùng trong thời kì Tự chủ. Nhưng Công Tiễn lại không có chỗ dựa chính trị vững chắc, hành động tranh giành quyền lực của ông bị phản đối bởi nhiều thế lực địa phương và thậm chí nội bộ họ Kiều cũng chia rẽ trầm trọng. Bị cô lập, Công Tiễn vội vã cầu cứu nhà Nam Hán. Ngô Quyền nhanh chóng tập hợp lực lượng, kéo quân ra Bắc, giết chết Kiều Công Tiễn rồi chuẩn bị quyết chiến với quân Nam Hán. Thắng lợi của Ngô Quyền trên sông Bạch Đằng vào năm 938 đã đặt dấu chấm hết cho mọi âm mưu xâm lược Tĩnh Hải quân của nhà Nam Hán, đồng thời cũng kết thúc thời kì Bắc thuộc của Việt Nam. Năm 939, Ngô Quyền xưng vương, đóng đô ở Cổ Loa, lập ra nhà Ngô. Ngô Vương qua đời ở tuổi 47, trị vì được 6 năm. Sau cái chết của ông, nhà Ngô suy yếu nhanh chóng, không khống chế được các thế lực cát cứ địa phương và sụp đổ vào năm 965."

B. Phần phân tích phân bố dòng họ. 
Ở phần này chúng ta sử dụng CSDL về dòng họ trong số học sinh phổ thông của cả nước để truy tìm nơi phát tích của các dòng họ cổ xưa. Việc phân tích được thực hiện thông qua tỷ lệ phần trăm của các họ trong khu vực.
Chúng ta theo dõi dòng họ Dương thì thấy tâm mật độ dòng họ cao nhất là ở vùng Thái Nguyên và giảm dần theo khoảng cách tới tâm tăng lên. 

Họ Mai (Mai Hắc Đế 670 - 722)
Toàn quốc 0.86%, Miền Bắc 0.59%, Miền Trung 1.03%, Miền Nam 0.93%, Thái Nguyên 0.49%, Vĩnh Phúc 0.14%, Hà Nam 0.48%, Hưng Yên 0.5%, Hà Nội 0.36%, Ninh Bình 1.47%, Tuyên Quang 0.26%, Phú Thọ 0.44%, Hải Dương 0.38%, Nam Định 2.0%, Hòa Bình 0.14%, Thanh Hóa 2.4%, Nghệ An 0.38%, Đồng Nai 1.24%.
Kết hợp với sử liệu chúng ta thấy nơi phát tích dòng họ Mai, cụ thể là Mai Hắc Đế có thể là ở vùng từ Thanh Hóa tới Nam Định. 

Họ Dương (Dương Đình Nghệ 874 – 937)
Toàn quốc 1.4%, ở Miền Bắc là 1.65, Miền Trung 1.1%, Miền Nam 1.49, Thái Nguyên 6.19%, Vĩnh Phúc 2.69%, Hà Nam 1.8%, Hưng Yên 1.6%, Hà Nội 1.58%, Ninh Bình 1.34%, Tuyên Quang 1.4%, Phú Thọ 0.95%, Hải Dương 0.88%, Nam Định 0.68%, Hòa Bình 0.61%, Thanh Hóa 0.76%. Nghệ An 0.68%.
Dòng họ Dương có thể là ở vùng Thái Nguyên - Vĩnh Phúc. 
Vậy Đường Lâm <=> Tuyên Quang - Thái Nguyên 

Họ Ngô (Ngô Quyền 898-944)
Toàn quốc 1.66%, Miền Bắc là 1.7%, Miền Trung 1.64%, Miền Nam 1.49%, Thái Nguyên 2.24%, Hà Nội 2.14%, Vĩnh Phúc 1.48%, Hà Nam 2.21%, Hưng Yên 1.47%, Ninh Bình 0.91, Tuyên Quang 0.84, Phú Thọ 1.23%, Hải Dương 1.34%, Nam Định 2.2%, Hòa Bình 0.44%, Thanh Hóa 1.19%. 
Dòng họ Ngô có thể ở vùng thuộc tam giác Thái Nguyên - Hà Nội - Hà Nam. 
Đường Lâm <=> Tuyên Quang - Thái Nguyên 
Khả năng Ngô Quyền là người vùng Đường Lâm (Thái Nguyên) là rất lớn. Như thế việc Dương Đình Nghệ ở vùng đất Thanh Hóa xem ra không hợp lắm. Kết hợp thống kê lại với nhau chúng ta có thể nhận thấy có khả năng cả hai ông Dương Đình Nghệ và Ngô Quyền đều ở vùng đất Thái Nguyên.  

Vậy rõ ràng ở đây có một yếu tố gì đó, hoặc là Đại Việt Sử Ký Toàn Thư đã có sai sót về địa danh, hoặc là đã có một sự kiện chưa rõ nào đó.
Cấu trúc Làng Xã rất ổn định, việc cưỡng chế các vùng dân cư có tính lịch sử nhập vào với Hà Nội gây ra rất nhiều rắc rối cho thống kê này. Nếu có được phân bố chi tiết hơn tới Huyện thì chúng ta có thể nhận ra được vết của lịch sử.
Có bạn nào có dữ liệu thì cho tôi xin.
"Trong tất cả các châu, quận An Nam chỉ có 2 vùng cống nạp bạch lạp (thiếc trắng) là Phong Châu và Đường Lâm". 

Từ Đèo Ngang trở ra chỉ có hai vùng có mỏ thiếc sa khoáng là Tuyên Quang (đời Đường thuộc Phong Châu) và mỏ thiếc Bù Me, gần núi Bù Chò thuộc các huyện Thường Xuân, Thọ Xuân (Tây Nam Thanh Hóa), một phần ăn sang Quỳ Hợp, Quế Phong miền Tây Nghệ An.
Sơn Dương (Tuyên Quang) và Đại Từ (Thái Nguyên) là những vùng có nhiều mỏ thiếc lộ thiên. Nếu các dữ liệu chi tiết về dòng họ Ngô và Dương mà tạo ra phân bố với các tâm điểm ở hai vùng có mỏ thiếc, phía Thái Nguyên và Thanh Hóa, thì có thể phải xem lại vị trí của Đường Lâm nay.

Đường Lâm ở Sơn Tây ngày nay là một địa danh mới chỉ xuất hiện sau 1945 trên cơ sở hợp nhất một số làng của tổng Cam Thịnh, còn Đường Lâm cổ - năm 669 thời Đường Cao Tông, cùng với 2 huyện An Viễn và Phúc Lộc thuộc châu Phúc Lộc, 757 thời Đường Túc Tông đổi thành quận Đường Lâm, 758 bỏ quận lập lại châu Phúc Lộc - thuộc vùng tây nam Châu Ái. "Tân Đường Thư" có ghi: trong tất cả các châu, quận An Nam chỉ có 2 vùng cống nạp bạch lạp (thiếc trắng) là Phong Châu và Đường Lâm. Từ Đèo Ngang trở ra chỉ có hai vùng có mỏ thiếc sa khoáng là Tuyên Quang (đời Đường thuộc Phong Châu) và mỏ thiếc Bù Me, gần núi Bù Chò thuộc các huyện Thường Xuân, Thọ Xuân (Tây Nam Thanh Hóa), một phần ăn sang Quỳ Hợp, Quế Phong miền Tây Nghệ An.

Họ Dương đến Dương Đình Nghệ đã nhiều đời làm hào trưởng ở đất Dương Xá, Ái Châu. Khởi tổ họ Ngô là Ngô Nhật Đại quê ở Ái Châu, tham gia khởi nghĩa Mai Thúc Loan, khởi nghĩa thất bại quay về Ái Châu lập nghiệp, 5 đời sau sinh ra Ngô Quyền. Quê của Ngô Quyền cách quê của Dương Đình Nghệ chỉ khoảng 40km theo đường sông Chu, họ Ngô nhiều đời là châu mục khống chế cả một vùng biên viễn ngay sau lưng họ Dương, điều này lý giải vì sao Ngô Quyền quê ở Đường Lâm lại lấy con gái Dương Đình Nghệ, quê Dương Xá và được Dương Đình Nghệ tin tưởng giao luôn binh quyền ở Ái Châu, sau mới đem quân từ Ái Châu ra Đại La diệt Kiều Công Tiễn. Đinh Bộ Lĩnh, Lê Hoàn đều là cháu rể Dương Đình Nghệ.

Vậy có thể đưa ra kết luận "Các cuộc khởi nghĩa dẫn đến việc thiết lập các triều đại Vua ở Đại Việt liên quan tới việc chống lại sự áp bức bóc lột của phương Bắc trong việc khai mỏ thiếc". Tuy nhiên chúng ta cần phải có bằng chứng về việc khai thác thiếc vào thời kỳ từ năm 700 cho tới 900. Liệu có thể tìm ra được dấu vết khai mỏ không?



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mai, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mai_plot$centroid <- sf::st_transform(mai_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mai <- mai_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son" & NAME_2=="Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mai=as.numeric(round(prop.mai, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mai, area_km, songuoi_km, lng, lat, distm_km)

mai_peak <- mai_plot %>% filter(NAME_3=="Thi tran Nga Son" & NAME_2=="Nga Son")

datatable(mai, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, warning=FALSE, message=FALSE, lazy=TRUE}
ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mai_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mai")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
mai <- dat_sff %>% filter(Ho=="Mai") %>% st_as_sf(crs = 4326)
mai$centroid <- sf::st_transform(mai, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai <- mai %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_radius <- mai %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-mai_radius$distm_km
pro.pop<-mai_radius$pro.pop
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)

df <- data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(rank))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai")

plot_df
```



```{r, lazy=TRUE}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plotf <- mai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mai, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mai_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mai_plotf$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mai")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
mai <- dat_sff %>% filter(Ho=="Mai") %>% st_as_sf(crs = 4326)
mai$centroid <- sf::st_transform(mai, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai <- mai %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_radius <- mai %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-mai_radius$distm_km
songuoi_km<-mai_radius$songuoi_km
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-1300*exp(-(distm_km^2)/(2*100))

library(dplyr)
df <- data.frame(distm_km, rank, commune, estimate, songuoi_km)
df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai")

plot_df
```

## Phùng

Phùng (馮) là một họ cổ. Nó đứng thứ 27 trong danh sách các họ ở Trung Quốc đại lục ngày nay. 

Họ Phùng có nguồn gốc xa xưa là dân du mục ở Tân Cương. Vào khoảng 4000 năm về trước họ Phùng xuất hiện ở vùng Thiểm Tây như một quốc gia. 
https://www.newton.com.tw/wiki/%E9%A6%AE%E5%A7%93
https://kknews.cc/history/qq4j2r.html

Có thể đã có một dòng người di cư vào khoảng hơn 3000 năm về trước theo dòng sông Thao về tới được khu vực mà nay là Phùng Nguyên. Có lẽ Phùng Nguyên là nơi được coi là phát tích của họ Phùng. 

3000 năm về trước, Phùng Nguyên là một cái gò nhỏ ở cuối sông Thao trước khi gặp sông Đà. Theo thời gian do phù sa bồi lấp mà Phùng Nguyên trở thành đất liền. Ở đây người ta tìm thấy các di vật Nha Chương.

Dựa theo phân tích của Đức Dư về dòng họ ở Việt Nam 
https://duhongduc.shinyapps.io/HoViet/...
chúng ta có thể nhận thấy họ Phùng ở khu vực ngay chân núi Ba Vì. Đây là vùng đất cổ và là nơi các cơn mưa từ Ba Vì đổ xuống gây ngập lụt. Đó có thể là cội nguồn của truyền thuyết Sơn Tinh Thủy Tinh. 

Chúng ta có thể nhận thấy dòng họ Phùng chiếm vị trí sâu về phía chân núi, sau đó là họ Lý ở dải đất gần với biển hơn kéo dài từ vùng Đền Đô qua Từ Liêm, tiếp sau nữa là nhà Trần. 

Đây có thể là sự hình thành ra cấu trúc không gian văn hóa vua Hùng (phụ hệ) trong tổng thể văn hóa mẫu hệ ở đồng bằng Bắc Bộ.



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phung, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phung_plot$centroid <- sf::st_transform(phung_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phung <- phung_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phung=as.numeric(round(prop.phung, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phung, area_km, songuoi_km, lng, lat, distm_km)

phung_peak <- phung_plot %>% filter(NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi")

datatable(phung, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
# library(plotly)

phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phung_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phung_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phùng")

# fig <- ggplotly(
#   ggplot(bui_plot) +
#     geom_sf(aes(fill = pro.pop), lwd=0) +
#     # geom_sf(data=river3, col="orange") +
#     scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
#     annotate(geom="text", x=108, y=23, color="red", label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
#     theme_bw()
# )
# 
# fig
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
phung <- dat_sff %>% filter(Ho=="Phùng") %>% st_as_sf(crs = 4326)
phung$centroid <- sf::st_transform(phung, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung <- phung %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_radius <- phung %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-phung_radius$distm_km
pro.pop<-phung_radius$pro.pop
rank<-phung_radius$rank
commune<-phung_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-45*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Phùng")

plot_df
```



```{r, lazy=TRUE}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plotf <- phung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phung_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phung_plotf$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phùng")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
phung <- dat_sff %>% filter(Ho=="Phùng") %>% st_as_sf(crs = 4326)
phung$centroid <- sf::st_transform(phung, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung <- phung %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_radius <- phung %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-phung_radius$distm_km
songuoi_km<-phung_radius$songuoi_km
rank<-phung_radius$rank
commune<-phung_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-750*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Phùng")

plot_df
```

## Khúc

Họ Khúc.

(Ngược dòng lịch sử)

Họ Khúc truyền nối làm chức Tiết Độ Sứ (tức làm Vua) gồm 3 đời: Khúc Thừa Dụ, Khúc Hạo, Khúc Thừa Mỹ, trị vì từ năm 905 tới năm 923 (hoặc 930). Đền thờ Khúc Thừa Dụ, Khúc Hạo, Khúc Thừa Mỹ, được xây dựng vào năm 2005 cạnh đình cổ làng Cúc Bồ bên bờ sông Luộc thuộc tỉnh Hải Dương.

Theo thống kê học sinh phổ thông năm 2017 thì họ Khúc có mật độ phân bố lớn nhất ở vùng Hải Dương, Hưng Yên, Ninh Bình, và Hà Nội. Phân bố thống kê mật độ người mang họ Khúc này hoàn toàn phù hợp với sử liệu về nơi phát tích gia tộc họ Khúc.

Năm Bính Dần (906) đời vua Chiêu Tuyên, nhà Đường rơi vào tay quyền thần Chu Ôn, các thế lực cát cứ nổi lên đánh giết lẫn nhau, tạo ra thế chia cắt 5 đời 10 nước (Ngũ đại Thập quốc).
Năm 905, ở Tĩnh Hải quân (tên gọi Việt Nam lúc đó), Tiết độ sứ Độc Cô Tổn bị Chu Ôn dời tiếp ra đảo Hải Nam và giết chết. Tĩnh Hải quân do đó không có người cai quản. 

Khúc Thừa Dụ 曲承裕 quê ở Hồng Châu (thuộc địa hạt Bàng Giang, Ninh Giang cũ ở Hải Dương), gặp thời buổi loạn lạc, nhân danh là hào trưởng một xứ, Thừa Dụ tự xưng là Tiết độ sứ" và cho dựng đô ở La Thành. Cương mục dẫn sách An Nam kỷ yếu, ghi thêm: "Cuối thời Đường, Khúc Hạo làm Tiết độ sứ thay cho Độc Cô Tôn; đổi các hương ở các huyện làm giáp, đặt ở mỗi giáp một viên quản giáp và một phó tri giáp để giữ việc đánh thuế. Hạo giữ chức Tiết độ sứ được hơn 4 năm thì mất".

Ngày 7 tháng 2 năm 906, vua Đường phong thêm cho Tĩnh Hải quân Tiết độ sứ Khúc Thừa Dụ tước "Đồng bình chương sự". Sau đó, Khúc Thừa Dụ tự lấy quyền mình, phong cho con là Khúc Hạo chức vụ "Tĩnh Hải hành quân tư mã quyền tri lưu hậu", tức là chức vụ chỉ huy quân đội và sẽ kế vị quyền Tiết độ sứ.

Ngày 23 tháng 7 năm 907, Khúc Thừa Dụ mất, Khúc Hạo lên kế vị và phong cho con là Khúc Thừa Mỹ làm "Tĩnh Hải hành quân tư mã quyền tri lưu hậu" để kế vị. 

Khúc Hạo người làng Cúc Bồ, huyện Ninh Thanh, tỉnh Hải Hưng ngày nay, ở đó hiện còn đình thờ họ Khúc. Việt sử thông giám cương mục (Tiền biên, quyển 5) viết: "Họ Khúc là một họ lớn lâu đời ở Hồng Châu. 

Năm sau nhà Đường mất ngôi (907), nhà Hậu Lương lên thay, phong cho Lưu Ẩn làm Nam Bình Vương, kiêm chức Tiết độ sứ Quảng Châu và Tĩnh Hải, có ý để lấy lại Giao Châu.
Khúc Thừa Mỹ chủ trương kết thân với nhà Hậu Lương ở Trung nguyên mà gây hấn với nước Nam Hán liền kề. Năm 919, ông sai sứ sang Biện Kinh xin tiết việt của nhà Hậu Lương. Vua Lương là Mạt đế Chu Hữu Trinh bấy giờ bận đối phó với các nước lớn ở Trung nguyên nên ban tiết việt cho Khúc Thừa Mỹ và phong ông làm Tiết độ sứ Giao châu.
Được sự hậu thuẫn của Hậu Lương, Thừa Mỹ chủ quan cho rằng uy thế của nhà Lương rộng lớn ở Trung nguyên có thể kìm chế được Nam Hán nhỏ hơn ở Quảng Châu. Ông công khai gọi nước Nam Hán là "ngụy đình" (triều đình tiếm ngôi, không chính thống). Chính sách đối ngoại đó của Khúc Thừa Mỹ khiến vua Nam Hán tức giận và quyết định sai Lý Khắc Chính cầm quân sang đánh chiếm Tĩnh Hải quân.

Sách Tân Ngũ Đại sử, phần Nam Hán thế gia ghi: Đại Hữu năm thứ ba (930), [Lưu Nghiễm] sai tướng Lý Thủ Dung và Lương Khắc Trinh đánh Giao Chỉ, bắt được Khúc Thừa Mỹ... Thừa Mỹ là con của Khúc Hạo. Lương Khắc Trinh lại đánh Chiêm Thành, cướp lấy đồ quý mang về.

Việc quân Nam Hán sang đánh Giao Châu (tức nước ta), bắt Khúc Thừa Mỹ, sử liệu Trung Quốc như Thông giám ghi vào tháng 9 năm Trường Hưng thứ 1 (930). Tân Ngũ Đại sử, Nam Hán thế gia ghi vào niên hiệu Đại Hữu thứ 3, cũng tức là năm 930. Chưa rõ vì sao cả Toàn thư và Cương mục đều ghi vào năm Quý Mùi (923)?

Từ sự liên kết các sự kiện nêu trong sử liệu Phương Bắc với các sử liệu có trong trong Đại Việt Sử Ký Toàn Thư, cộng với sự phù hợp về địa lý của hàm phân bố mật độ dân mang họ Khúc cho thấy các thông tin lịch sử về triều đại họ Khúc trong khoảng thời gian từ 905 tới năm 923 (hoặc 930) là đáng tin cậy.



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuc, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
khuc_plot$centroid <- sf::st_transform(khuc_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

khuc <- khuc_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.khuc=as.numeric(round(prop.khuc, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuc, area_km, songuoi_km, lng, lat, distm_km)

khuc_peak <- khuc_plot %>% filter(NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha")

datatable(khuc, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuc_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=khuc_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khúc")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
khuc <- dat_sff %>% filter(Ho=="Khúc") %>% st_as_sf(crs = 4326)
khuc$centroid <- sf::st_transform(khuc, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
khuc <- khuc %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc_radius <- khuc %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-khuc_radius$distm_km
pro.pop<-khuc_radius$pro.pop
rank<-khuc_radius$rank
commune<-khuc_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-18*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Khúc")

plot_df
```



```{r, lazy=TRUE}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plotf <- khuc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.khuc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuc_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuc_plotf$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khúc")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
khuc <- dat_sff %>% filter(Ho=="Khúc") %>% st_as_sf(crs = 4326)
khuc$centroid <- sf::st_transform(khuc, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
khuc <- khuc %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc_radius <- khuc %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-khuc_radius$distm_km
songuoi_km<-khuc_radius$songuoi_km
rank<-khuc_radius$rank
commune<-khuc_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-250*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Khúc")

plot_df
```

## Dương



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
duong_plot$centroid <- sf::st_transform(duong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

duong <- duong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.duong=as.numeric(round(prop.duong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong, area_km, songuoi_km, lng, lat, distm_km)

duong_peak <- duong_plot %>% filter(NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son")

datatable(duong, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, warning=FALSE, message=FALSE, lazy=TRUE}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=duong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(duong_plot$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Dương")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
duong <- dat_sff %>% filter(Ho=="Dương") %>% st_as_sf(crs = 4326)
duong$centroid <- sf::st_transform(duong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
duong <- duong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

duong_radius <- duong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-duong_radius$distm_km
pro.pop<-duong_radius$pro.pop
rank<-duong_radius$rank
commune<-duong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-87*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Dương")

plot_df
```



```{r, lazy=TRUE}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plotf <- duong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.duong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(duong_plotf$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Dương")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
duong <- dat_sff %>% filter(Ho=="Dương") %>% st_as_sf(crs = 4326)
duong$centroid <- sf::st_transform(duong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
duong <- duong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

duong_radius <- duong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-duong_radius$distm_km
songuoi_km<-duong_radius$songuoi_km
rank<-duong_radius$rank
commune<-duong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-121*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Dương")

plot_df
```

## Ngô



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ngo_plot$centroid <- sf::st_transform(ngo_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ngo <- ngo_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ngo=as.numeric(round(prop.ngo, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo, area_km, songuoi_km, lng, lat, distm_km)

ngo_peak <- ngo_plot %>% filter(NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa")

datatable(ngo, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, warning=FALSE, message=FALSE, lazy=TRUE}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ngo_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngô")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ngo <- dat_sff %>% filter(Ho=="Ngô") %>% st_as_sf(crs = 4326)
ngo$centroid <- sf::st_transform(ngo, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ngo <- ngo %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo_radius <- ngo %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ngo_radius$distm_km
pro.pop<-ngo_radius$pro.pop
rank<-ngo_radius$rank
commune<-ngo_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Ngô")

plot_df
```



```{r, lazy=TRUE}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plotf <- ngo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ngo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngo_plotf$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngô")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ngo <- dat_sff %>% filter(Ho=="Ngô") %>% st_as_sf(crs = 4326)
ngo$centroid <- sf::st_transform(ngo, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ngo <- ngo %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo_radius <- ngo %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ngo_radius$distm_km
songuoi_km<-ngo_radius$songuoi_km
rank<-ngo_radius$rank
commune<-ngo_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-525*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Ngô")

plot_df
```

## Lương



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
luong_plot$centroid <- sf::st_transform(luong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

luong <- luong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.luong=as.numeric(round(prop.luong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong, area_km, songuoi_km, lng, lat, distm_km)

luong_peak <- luong_plot %>% filter(NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh")

datatable(luong, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, warning=FALSE, message=FALSE, lazy=TRUE}
luong_sf <- dat_sf %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.luong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=luong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luong_plot$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lương")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
luong <- dat_sff %>% filter(Ho=="Lương") %>% st_as_sf(crs = 4326)
luong$centroid <- sf::st_transform(luong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
luong <- luong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

luong_radius <- luong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-luong_radius$distm_km
pro.pop<-luong_radius$pro.pop
rank<-luong_radius$rank
commune<-luong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-46*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lương")

plot_df
```



```{r, lazy=TRUE}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plotf <- luong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.luong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luong_plotf$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lương")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
luong <- dat_sff %>% filter(Ho=="Lương") %>% st_as_sf(crs = 4326)
luong$centroid <- sf::st_transform(luong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
luong <- luong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

luong_radius <- luong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-luong_radius$distm_km
songuoi_km<-luong_radius$songuoi_km
rank<-luong_radius$rank
commune<-luong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-36*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lương")

plot_df
```

## Lý

Họ Lý 李, Trần 陳, và Nguyễn 阮

Con tự họ Lý 李 hàm ý đứa con của cây rừng trên núi cao. Con tự dòng Nguyễn 阮 được hiểu là người thân phận như những mô đất (dòng họ) bị đè nén không ngóc đầu lên được. Con Tự dòng họ Trần 陳 là những mô đất (dòng họ) ở phía Đông nơi có cây bao phủ. Dòng Họ Lý 李 là ở phía rừng núi Quảng Tây, dòng họ Trần 陳 là ở về phía đồng bằng Quảng Đông. 

Trong bài khảo cứu về dòng họ Lý được đăng trên trithucvn.org, anh Việt giám đốc Trung Tâm Tiền Sử Đông Nam Á có khẳng định như sau. 

Trên một dụng cụ bằng đồng khai quật tại Quảng Đông còn nguyên dòng minh văn: “Nguyên Sơ ngũ niên thất nguyệt trung Tây Vu Lý Văn Sơn trị xạ trước (chú) hữu”. Tạm dịch: Vào trung tuần tháng bảy năm thứ năm đời Nguyên Sơ (năm 143 sau Công nguyên) Lý Văn Sơn người Tây Vu điều hành việc đúc đồng. 

Trên một chiếc vò sành đời Hán được Clemant Huet sưu tầm tại Thanh Hóa trước Chiến tranh thế giới lần thứ nhất, hiện trưng bày tại gian Việt Nam của Bảo tàng Hoàng gia Bỉ về Nghệ thuật và Lịch sử (Brussel) có khắc dòng chữ: “Kiến hòa tam niên nhuận nguyệt trấp nhật Lý thị tác”. Tạm dịch: Họ Lý sản xuất ngày hai mươi tháng nhuận năm thứ ba đời Kiến Hòa (năm 149 sau Công nguyên).

Huyện Tây Vu đời Nguyên Sơ bao gồm cả vùng đất Bắc Ninh, Bắc Giang trọng tâm là các vùng Quế Võ, Phả Lại, Thiên Thai… Mã Viện đã tách ra từ huyện Tây Vu cũ thành ba huyện: Tây Vu, Phong Châu và Vọng Hải. Anh Việt cũng cho biết thêm tổ của Lý Bí cũng từ phía Bắc sang đất Việt từ thời Tây Hán, 200 năm trước Công Nguyên.

Như thế họ Lý được biết đến ở Đại Việt tương đối sớm. Lần ngược lại lịch sử thì chúng ta được biết họ Nguyễn ở Đại Việt được hình thành một cách "nhân tạo" như sau.

Năm 1232, nhà Lý suy vong, Trần Thủ Độ đã bắt con cháu họ Lý đổi sang họ Nguyễn với lý do phạm húy bởi ông nội của Trần Cảnh tức vua Trần Thái Tông là Trần Lý. Trên thực tế lý do bắt đổi họ Lý 李 thành họ Nguyễn 阮 là hàm ý nhục mạ và để tiêu diệt tận gốc sự chống đối. 

Không riêng gì dòng họ Lý, trong lịch sử Việt Nam, tất cả các dòng họ khác với họ của Vua đều bị quy chuyển về Nguyễn. 

Suốt 1000 năm, từ năm 457 đến thời Hồ Quý Ly ở vùng đất Hải Dương và một phần Hải Phòng ngày nay có huyện Phí Gia người họ Phí. Vào thời nhà Trần đã bị đổi sang thành họ Nguyễn. Năm 1592, nhà Mạc suy tàn, con cháu họ Mạc cũng đổi sang họ Nguyễn.

Trần Quang Diệu (và vợ là Bùi Thị Xuân) làm quan lớn cho nhà Tây Sơn, chống lại Nguyễn Ánh, sau khi nhà Tây Sơn cáo chung, con cháu Trần Quang Diệu, Bùi Thị Xuân bị trả thù khốc liệt, phải đổi thành nhiều họ, trong đó một số thành họ Nguyễn.

Căn cứ vào thống kê sau chúng ta thấy ở Việt Nam có 3 loại họ được sử dụng nhiều hơn cả. Đó là họ Nguyễn, họ Trần, và họ Lê. Trong đó họ Nguyễn chiếm tới gần 40% tổng số họ được sử dụng. 

Về mặt nguyên tắc thì sau khi có lệnh của Trần Thủ Độ, ở Đại Việt không thể có người mang họ Lý. Hiện vẫn còn một phần rất ít người mang họ Lý. Vậy họ từ đâu mà ra? 

Xét về lịch sử, kể từ sau nhà Trần, nhà Lý không còn tham gia chính sự. Hơn thế dòng họ Lý chỉ chiếm rất ít 0.5% trong tỷ lệ dân số Đại Việt. Như thế biến động về tỷ lệ dân số của họ Lý là không lớn. 

Cho tới tận khi Pháp sang phương thức sản xuất ở đồng bằng Bắc Bộ vẫn không thay đổi so với thời kỳ từ đầu Công Nguyên. Mật độ dân cư vẫn là khoảng 1 hộ trên 1 heta, tức khoảng 6 nhân khẩu gồm 3 thế hệ trên 1 heta. Vào thời Nhà Trần bờ biển ở vào khoảng Nam Định, diện tích đồng bằng Bắc Bộ vào khoảng 670 nghìn heta. Như thế dân số thời Nhà Trần vào khoảng trên dưới 4 triệu. Theo cổ sử thì dân số thì thời nhà Trần có 3790000 người. Con số này là đáng tin cậy. Với tỷ lệ này thì 0.5%  là khoảng 20 nghìn. Đây có thể chính là số quân của Đại Lý sau khi làm phản đánh lại 15 nghìn quân Mông Cổ trong trận đánh Mông lần thứ nhất 1258 ở lại Đại Việt. Đây là lực lượng tạo ra chiến thắng cho nhà Trần và không liên quan gì tới dòng của các vua Lý. Hơn thế Trần Thủ Độ (1194–1264) chết già khoảng 8 năm sau cuộc chiến khốc liệt. Và có thể vì các lý do đó mà 20 nghìn quân Đại Lý đã không bị đổi họ.

Như thế rất có thể 0.5% dân số mang họ Lý là hậu duệ của 20 nghìn quân từ Đại Lý làm chư hầu cho 15 nghìn quân Mông Cổ tiến đánh Đại Việt lần thứ nhất vào năm 1258. 

Trận đánh thắng quân Mông - Đại Lý năm 1258 là trận đánh tầm cỡ thế giới, bởi đấy là trận thua đầu tiên của quân Mông sau khi đã bình định khắp cả lục địa Á Âu. 

Vào cuối thời kỳ nhà Lý xã hội rối ren suy tàn, vua chúa ham tửu sắc mà bỏ bê việc nước, cướp nổi lên khắp nơi. Năm 1225, Lý Huệ Tông truyền ngôi cho con gái 7 tuổi là Chiêu Thánh, tức vua Lý Chiêu Hoàng. Trần Thủ Độ chú của Lý Chiêu Hoàng đã dàn xếp việc truyền lại ngôi từ nhà Lý sang nhà Trần. Trần Thủ Độ tiến cử Trần Cảnh, lúc đó mới 8 tuổi, làm Chi hậu chính chi ứng cục hầu hạ trong cung. Ngày 11 tháng 12 năm ấy (tức 10 tháng 1 năm 1226), Chiêu Hoàng trao hoàng bào cho Trần Cảnh ở điện Thiên An. Nhà Lý chấm dứt sau 216 năm tồn tại. 
32 năm, từ năm 1226 đến năm 1258, là khoảng thời gian may mắn vừa để dẹp nạn cướp, vừa để củng cố sức mạnh quân sự đủ để đương đầu chống lại cuộc chiến với quân Mông Cổ. 

Diến tiến trận đánh như sau 
- Ngày 12 tháng chạp (17/1/1258), quân Nguyên từ Đại Lý thuộc Vân Nam sang giao chiến với quân nhà Trần trận đầu tiên ở Bình Lệ Nguyên (nay là khoảng Bình Xuyên, Vĩnh Phúc). 
- Ngày 13 tháng chạp (18/1/1258) giao chiến lần thứ 2 bên sông Phù Lỗ (tức sông Cà Lồ).
- Ngày 21 tháng 1 năm đó, quân Trần rút khỏi thành Thăng Long về Thiên Mạc. Quân Nguyên Mông chiếm được thành. 
- Ngày 24 tháng chạp (29/1/1258) giao chiến trận thứ 3 ở Đông Bộ Đầu. Trần Thái Tông cùng thái tử Trần Hoảng (sau là vua Trần Thánh Tông) dẫn quân ngược sông Nhị tiến đánh Đông Bộ Đầu. Quân Nguyên Mông rút chạy về Vân Nam.

Theo Đại Việt Sử Ký Toàn Thư thì trận đánh trên sông Cà Lồ quân của Trần Thái Tông bị thua trận quân lính tan tác. Sự kiện chỉ sau có 11 ngày, từ chỗ ngày 18/1 quân Trần đại bại, tới 29/1 quân Trần đại thắng, đánh bại 15 nghìn quân Mông được giải thích như sau. 

Đặc điểm của quân Mông là cưỡi ngựa, bắn tên rất giỏi. Đội quân này không mang theo lương thực. Họ đánh phá các làng mạc thành trì, cướp lương ăn, hãm hiếp phụ nữ, cứ như thế mà di chuyển đánh khắp cả châu Á châu Âu. Như vậy sức mạnh của quân Mông Cổ là ở khả năng di chuyển bằng ngựa chiến. Hiển nhiên là trận thua đầu tiên của quân Mông Cổ phải là do các vấn đề liên quan tới ngựa chiến. Sự thật có thể đã là thế nào?

Nhiều sử gia rất hoang mang khi nói đến số quân Mông Cổ huy động đánh Nhà Trần lần thứ 1, và càng hoang mang hơn khi lập luận về cuộc chiến đánh thắng quân Mông. 

Thủ phủ của Đại Lý ở hồ Nhĩ Hà, mà phía Tây của nó là thượng nguồn con sông Thao. Hốt Tất Liệt đưa 100 nghìn quân tiến từ Nội Mông qua Tân Cương xuống đánh Đại Lý. Đội quân này chia thành 3 cánh, Hốt Tất Liệt chỉ quy cánh giữa 70 nghìn quân. Cánh phải do Uriyangqatai chỉ huy với 15 nghìn quân. Sau khi đánh chiếm kinh thành của Đại Lý, Hôt Tất Liệt thu quân về đánh nhau với Tống. Uriyangqatai bình định nốt phần còn lại của Đại Lý rồi tiến quân xuống Đại Việt nhằm mở hướng tấn công Tống từ phía Nam.  
Số quân của Uriyangqatai là 35 nghìn, trong đó có 20 nghìn quân chư hầu Đại Lý. Đường đi ở vùng núi ít thay đổi theo thời gian. Ngày nay chúng là các đại lộ lớn. Như thế đường tiến quân của Uriyangqatai là qua Hà Giang rồi theo QL2, xuống Tam Quan.  

Đại Việt Sử Ký Toàn Thư nói tương đối rõ về bối cảnh trận chiến này. Vào tháng 11/1257 có lệnh "Mùa đông, tháng 11, Trần Thái Tông ra lệnh cả nước sắm sửa vũ khí." 
Các tình tiết sau chứng tỏ sự bị động của Đại Việt khi cuộc chiến bắt đầu. Cuộc chiến diễn ra tại vùng Bình Lệ Nguyên là vùng gồm Vinh Yên, Hương Canh ra tới tận bờ sông Hồng nay. Vào thế kỷ 12 sông Phan và sông Cà Lồ rộng khoảng 200m (bằng 2 lần tên bắn từ bờ ra giữa sông. Độ rộng này rộng hơn sông Thiên Phù -- vì sông Thiên Phù nay đã cạn.  Độ rộng của sông Thiên Phù gấp 2 lần sông Tô Lịch, và sông Tô Lịch thì rộng 70m từ Hàng Buồm qua Chợ Gạo). Bối cảnh chung thì Nhà Trần thi hành quan hệ hữu hảo với các tù trưởng ở biên cương. Quan hệ với Tống ở phía Bắc cũng rất tốt.

Nhắc lại diễn tiến 
- Mùa đông, tháng 11, lệnh truyền cả nước sắm sửa vũ khí.
- Tháng 12, ngày 12, tướng Nguyên Uriyangqatai (Ngột Lương Hợp Đải) xâm phạm Bình Lệ Nguyên.
- Vua thân hành đốc chiến, xông pha tên đạn. Quan quân hơi núng, vua ngoảnh trông tả hữu, chỉ có Lê Phụ Trần (tức Lê Trần) một mình một ngựa, ra vào trận giặc, sắc mặt bình thản như không.
- Lúc ấy, có người khuyên vua dừng lại để chỉ huy chiến đấu. Phụ Trần cố sức can vua: "Nay thì bệ hạ chỉ đánh một ván dốc túi thôi! Hãy nên tạm lánh chúng, sao lại có thể dễ dàng tin lời người ta thế!".
Bấy giờ, vua mới lui quân đóng ở sông Lô. Phụ Trần giữ phía sau. Quân giặc bắn loạn xạ, Phụ Trần lấy ván thuyền che cho vua khỏi trúng tên giặc. Thế giặc rất mạnh, vua lại phải lui giữ sông Thiên Mạc. Phụ Trần theo vua bàn những việc cơ mật, rất ít người biết được đều đó.
- Vua ngự thuyền nhỏ đến thuyền Thái úy Nhật Hiệu hỏi kế sách (chống giặc). Nhật Hiệu đương dựa mạn thuyền, cứ ngồi chứ không đứng dậy nổi, chỉ lấy ngón tay chấm nước viết hai chỉ "nhập Tống" lên mạn thuyền. Vua hỏi quân Tinh Cương ở đâu? (Tinh Cương là quân do Nhật Hiệu chỉ huy).
Nhật Hiệu trả lời: "Không gọi được chúng đến"
- Vua lập tức dời thuyền đến hỏi Thái sư Trần Thủ Độ, Thủ Độ trả lời: "Đầu thần chưa rơi xuống đất, bệ hạ đừng lo gì khác".
Như thế ngay từ phút giáp trận đầu tiên quân của Trần Thái Tông đã bị vỡ trận, bỏ chạy, tướng không còn thấy quân ở đâu. Tuy nhiên chỉ sau có 1 tháng quân của Uriyangqatai đã phải tháo chạy khỏi Đại Việt không còn đủ 3 nghìn quân. Vậy điều gì đã xảy ra.
Vào thế kỷ 12 đồng bằng Bắc Bộ thấp hơn hiện nay 4m. Vậy cuộc chiến xảy ra ở vùng sông nước. 
Mật độ dân cư đồng bằng Bắc Bộ ước tính 1 hộ/1ha, dân ở trong làng và đào hào quanh để lấy đất làm nhà làm đường. Quanh làng có lũy tre để ngăn cướp. Trên các con đường vào làng mà đào hố thì chả ngựa nào tấn công được. Như thế việc bình định nhanh vùng đầm hồ là không thể. Ưu thế của kị binh đánh nhanh thắng nhanh không còn. Cỏ ăn cho ngựa không hợp thổ nhưỡng, cũng có thể là nguyên nhân dẫn đến giảm sức chiến đấu. Quân của Mông Cổ hiển nhiên là đối tượng cho đội quân 20 nghìn quân thiện chiến của Đại Lý trả thù. Và chỉ sau chưa đầy 1 tháng thì "gậy ông đập lưng ông" chính quân Mông Cổ bị 20 nghìn quân chư hầu đánh lại. Quân của vua Trần Thái Tông cũng tập hợp lại và theo đà đánh đuổi quân Mông. Quân Mông Cổ chết gần hết. 20 nghìn quân Đại Lý này ở lại Đại Việt. Có thể những người này sống ở vùng rừng núi  ít liên quan tới nhà Trần, và cũng có thể nhà Trần đã đăng ký nhân khẩu và cấp họ cho những người này là Lý. 

Lần theo nguồn Đại Việt Sử Ký Toàn Thư, chúng ta thấy cái tên Đông Bộ Đầu được nhắc đến 10 lần, trong đó 9 lần đề đích danh Đông Bộ Đầu 東步頭, 1 lần đề là bến Triều Đông朝東津:
Vị trí của Đông Bộ Đầu được xác định nhờ bia "chùa Hòe Nhai".
https://yeuhannom.blogspot.com/.../bia-chua-hong-phuc-voi?fbclid=IwAR3s6qFXt__KF4_vOQSxbThNeq33iikJsPEoqxEpPZcmlwcdyEa1C7Xw1go

Theo các nhà sử học, người soạn tấm bia này là tiến sĩ Hà Tông Mục - tác giả của nhiều văn bia có giá trị vào thế kỷ 17. Hà Tông Mục 何宗穆 sinh ngày 25-9 năm Quý Tỵ (1653) mất ngày 7-3 Ðinh Hợi (1707), người làng Tỉnh Thạch huyện Thiên Lộc (nay là xã Tùng Lộc huyện Can Lộc) tỉnh Hà Tĩnh. Là một danh thần nổi tiếng triều Lê có tham gia biên soạn Đại Việt sử ký tục biên.

Mặt 1: 盛德宏功
蓋 聞：夫善之種福之宗而修福行善者，豈必於山巔水涯足跡穻到之所然後為至哉！我大越昇龍城之 "東步頭" 槐街坊有寺名洪福，帶瀘江而襟蘇瀝，控傘嶺而拱宸居。風景 有情精氣所萃，自古僧伽大士住持焚誦，上祝聖人壽下願民物康，國禱民祈應若桴鼓。誠古跡大伽藍都會中之勝概也。日月跡久平波靡常鄰房纔闕於鴟魚，梵宇盡灰 於回祿。一區淨土侵尋為讙鬧之場，幾座金身零落於福林之境。禪扃煙鎖僧砌苔漫，歷閱星霜六十餘年，皈依像教者睹之者莫不太息然未有修而復之者。睠玆
Dịch là 
THỊNH ĐỨC HOẰNG CÔNG
Từng nghe: Gieo mầm thiện là nối dòng phúc, mà tu phúc làm thiện, há phải ở những nơi góc biển chân trời nơi chân người ít đến mới được đâu! Phường Hòe Nhai, khu "Đông Bộ Đầu", thành Thăng Long nước Đại Việt ta có ngôi chùa tên Hồng Phúc, men dòng Lô giang (sông Hồng) mà bao dòng Tô Lịch, chống non Tản mà chầu hướng thần cư. Phong cảnh hữu tình là nơi tinh khí hội tụ, từ xưa là nơi các bậc tăng già đại sĩ trụ trì khấn tụng, trên thì chúc vua thánh thọ dưới nguyện dân vật an khang, quốc cúng dân cầu linh ứng vang truyền như trống dậy. Thực là nơi đại già lam cổ tích, thắng cảnh chốn đô thành. Năm tháng dài lâu, phong ba biến đổi, xóm thôn vắng vẻ đìu hiu, kèo cột tô khắc hình cá chim tiêu tán, cảnh chùa cũng mắc vòng lửa tai biến mà ra tro. Một khu Tịnh thổ dần thành chốn hoan lạc bon chen, mấy tòa tượng báu điêu tàn giữa cảnh phúc lâm. Cửa Thiền mây tỏa, thềm tăng rêu đầy, trải bao phen ngó sao nằm sương hơn sáu chục năm, những người quy y Tượng giáo (Phật Giáo) mà trông cảnh ấy không ai không than thở vì chưa có người tu sửa mà khôi phục lại.

Chùa Hòe Nhai ở Hà Nội là địa danh Đông Bộ Đầu 東步頭, tức "Bến đỗ thuyền phía đông". 

Khảo sát thực địa khu vực Hòe Nhai là một gò đất cao gần chân cầu Long Biên. Khảo sát thực tế chúng ta biết cửa sông Tô Lịch xưa là ở khoảng giữa Chợ Gạo và Hội Quán Quảng Đông trên phố Hàng Buồm. Như thế vào khoảng năm 1800 sông Hồng chảy theo đường Yên Phụ. Từ chùa Hòe Nhai, tức Đông Bộ Đầu, đi theo phố Hàng Than tới Hàng Ngang chính là bờ sông Hồng vào thời năm 1258. 

Khoảng cách từ phố Hàng Ngang tới đền Bạch Mã là 100m. Đền Bạch Mã có trên bản đồ 1490, như thế vận tốc bồi của phù sa làm bờ sông tiến dần ra là khoảng 100m cho 200 năm. Khoảng cách từ Đền Bạch Mã ra tới cửa sông Tô Lịch là 200m. Vậy 200m này ứng với 400 năm phù sa bồi. Như thế hội Quán Quảng Đông được dựng ra tại vị trí như hiện nay trên phố Hàng Buồm là vào khoảng năm 1900. 

Khoảng cách từ Hội Quán Phúc Kiến tới phố Hàng Ngang là 100m, vậy Hội Quán Phúc Kiến được dựng vào khoảng năm 1000, tức gần thời gian với vua Lý Công Uẩn rời đô ra Thăng Long. Đây chính là thời gian Nhà Trần từ Phúc Kiến di cư tới Đại Việt. Khu vực phát tích của Nhà Trần là ở Mỹ Lộc, Nam Định. Khoảng cách từ Mỹ Lộc tới cửa Ba Lạt là khoảng 50km. Cứ 1000 năm thì cửa sông Hồng tiến ra biển được 45km, vậy 50km ứng với khoảng 1000 năm. Đó chính là thời điểm xây dựng Hội Quán Phúc Kiến.

Như vậy chúng ta có thể tin vào khẳng định bờ sông Hồng vào năm 1258 là từ Hòe Nhai tới Hàng Ngang, rồi qua hồ Gươm. Vào năm 1400 bờ sông Hồng đã được phù sa bồi lấn tới phố Nguyễn Thiếp, Hàng Giầy, và do Hàng Bạc là một gò đất cao nên, bờ sông là vòng theo phố Lương Ngọc Quyến. Chùa Bạch Mã thờ Mã Viện thực chất là một miếu trên gò nổi ở bãi nổi giữa sông. Như vậy Đền Bạch Mã nơi thờ Mã Viện là được hình thành từ một cái miếu hoang ngoài bãi nổi giữa sông Hồng vào thời cư dân vùng ven biển Phúc Kiến di sang làm ăn buôn bán..

ĐVSKTT (Đại Việt Sử Ký Toàn Thư), là chính sử Ngô Sĩ Liên viết vào năm 1479. Sau nhiều năm kiểm duyệt, sửa đổi, và bổ sung, bộ sử 15 quyển được khắc in và phát hành vào năm 1697.
Ngô Sĩ Liên đã dựa vào hai bộ sử, bộ sử của Lê Văn Hưu và bộ sử của Phan Phu Tiên để biên soạn.

Bộ sử của Lê Văn Hưu biên soạn và hoàn thành vào năm 1272, Bộ Đại Việt sử ký 大越史記, là bộ quốc sử Việt Nam sớm nhất được ghi nhận,. Bộ sử ghi chép lịch sử Đại Việt từ thời đại Triệu Vũ Đế năm 207 TCN đến hết năm 1225 đời Lý Chiêu Hoàng nhà Lý.

Lê Văn Hưu theo lệnh vua Trần Thái Tông biên soạn bộ chính sử đầu tiên của nhà Trần mang tên Đại Việt Sử Ký. Bộ sách này bao gồm 30 quyển được hoàn thành và dâng lên vua Trần Thánh Tông vào tháng 1 năm 1272 và được vua Thánh Tông hết sức khen ngợi. Lê Tắc trong An Nam Chí Lược cho rằng Đại Việt Sử Ký của Lê Văn Hưu được biên soạn dựa trên cơ sở bộ Việt Chí (越志) của Trần Phổ được viết dưới thời Trần Thái Tông.

Như vậy ĐVSKTT có tham khảo Sử Ký 史記 của Đỗ Thiện thời nhà Lý, Việt chí 越志 của Hàn trưởng Trần Phổ thời nhà Trần. 

Lê Tắc (1263 - 1342) cùng chủ là Trần Kiện đã đầu hàng quân Nguyên, khi quân Nguyên đánh Đại Việt lần thứ 2, Lê Tắc được vua Nguyên phong chức. Hẳn là Lê Trác đã có được điều kiện để truy cập vào kho cổ sử các triều đại phong kiến Phương Bắc để viết An Nam Chí Lược. An Nam Chí Lược là cuốn cổ sử được viết dưới dạng cổ xúy cho các triều đại phong kiến Phương Bắc vì thế mà nó được phát hành, và cũng vì lý do đó mà các sự kiện lịch sử liên quan tới Đại Việt mới tới được với Ngô Sỹ Liên và chúng ta ngày nay. 

Về Nhà Trần ĐVSKTT viết: Có người tên là Kinh từ đất Mân di cư đến ở hương Tức Mặc, phủ Thiên Trường, sinh ra Hấp, Hấp sinh ra Lý, Lý sinh ra Thừa, đời đời làm nghề đánh cá. Trần Cảnh (1226-1258) là con thứ của Thừa, mẹ họ Lê, sinh ngày 16 tháng 6 năm Mậu Dần, Kiến Gia thứ 8. 

Như vậy Trần Cảnh là đời thứ 5 của Kinh di cưu tới  Mỹ Lộc thuộc Nam Định vào khoảng năm 1100. Cứ 1000 năm thì cửa Ba Lạt của sông Hồng tiến ra biển được khoảng 45km. Khoảng cách từ Mỹ Lộc tới cửa Ba Lạt khoảng 50km, tương ứng với khoảng 1000 năm về trước Mỹ Lộc là bờ biển. Điều này phù hợp với sử kiện ghi chép là tổ tiên của Nhà Trần tới vùng này làm nghề chài lưới vào khoảng năm 1100.

Trần Thủ Độ là chú họ bên ngoại của Lý Chiêu Hoàng (1218 - 1278) và là người sắp đặt cho việc Lý Chiêu Hoàng lấy Trần Cảnh (Trần Thái Tông) vào năm 1226, để chuyển ngôi từ nhà Lý sang nhà Trần.  Vào năm 1237, Trần Cảnh phế bỏ Hoàng Hậu Lý Chiêu Hoàng để lấy chị ruột của bà là  Hiển Từ Thuận Thiên Hoàng Hậu. Khi quân Mông tắt đường đánh chiếm kinh thành Thăng Long, Linh Từ (tức Lý Chiêu Hoàng) đã đưa hoàng thái tử, cung phi, công chúa và vợ con các tướng soái trốn thoát khỏi giặc cướp. 

Sau đại thắng quân Mông vào năm 1258, ở tuổi 40 Lý Chiêu Hoàng tái giá lấy Lê Phụ Trần. Lê Phụ Trần là một danh tướng phục vụ Trần Thái Tông, Trần Thánh Tông và Trần Nhân Tông. Ông đã có công cứu giúp Trần Thái Tông khỏi bị truy kích trong trận đánh với quân Mông ở Bình Lệ Nguyên.  

Bối cảnh trận đánh lần đầu tiên của quân Mông Cổ vào Đại Việt như sau.

Dali (Đại Lý) và Nam Tống là hai nước ở về phía Bắc của Đại Việt. Đế quốc Đại Lý hình thành vào năm 937 bao gồm cao nguyên Vân Nam 云南 và Tây Tứ Xuyên 四川西. Thủ phủ của Dali nằm ở phía nam hồ nước Erhai Lake 洱海. Hồ Erhai Lake dài 40km rộng 8km ở cao độ 2000m, bao quanh bởi các dãy núi dốc đứng cao 3500m. Đại Lý là nơi bắt đầu của tuyến đường tiến quân xuống Đông Nam Á, và là sườn phía Đông của Nam Tống. 

Năm 1252, đại hãn Mông Cổ Monkhe lệnh cho em trai mình là Hốt Tất Liệt 忽必烈 và tướng Ngột Lương Hợp Thai (Wulianghetai 兀良合台 sinh năm 1201 chết năm 1272, là  Wulianghetai con trai của Subutai  速不台 thuộc "Tứ linh Mông Cổ") dẫn 100 nghìn quân kỵ binh thiện chiến chinh phạt nước Đại Lý ở Vân Nam. 

Đây là cuộc viễn chinh quân sự đầu tiên của Hốt Tất Liệt và cũng là viễn chinh nổi tiếng trong lịch sử Trung Quốc. Muốn đánh Vân Nam thì phải qua Tứ Xuyên, nhưng Tứ Xuyên lúc này vẫn là đất của nhà Nam Tống. Tháng 7 năm 1252, Hốt Tất Liệt 忽必烈 khi ấy 36 tuổi, dẫn đội kỵ binh tiến hàng nghìn dặm dọc theo con đường qua Tây Tạng. Phải đến tháng 9 năm 1252, Hốt Tất Liệt mới tới được biên giới Đại Lý. Mục đích của việc đánh chiếm Dali là tạo thế gọng kìm để đánh quân Nam Tống từ phía bắc và từ phía Đông Nam. Sau khi đánh chiếm Dali, quân Mông Cổ đã tiến đánh Đại Việt với mực đích tấn công Tống từ phía Nam.

Cùng lúc ấy Meng Ge Khan 命汪德臣 (Wang Dechen), dẫn quân vào đánh Tứ Xuyên để hỗ trợ.

Vào mùa hè năm 1253, Quân Mông Cổ đi qua núi Liupan 六盘 và từ Lintao临洮 đến Tula 忒剌(nay là Dalagou, huyện Diebu, Cam Túc). Sau đó đội quân của Hốt Tất Liệt chia thành 3 cánh quân tiến về thành Kinh Thành Đại Lý ở phía nam. Wuliang Hetai dẫn quân tiến về theo đường phía Tây dọc theo Yandang (nay là đồng cỏ Aba ở Tứ Xuyên). Zong Wangchao và Yezhilie tiến theo đường phía Đông qua Mao Châu 茂州 (nay là Maowen) đến Huichuan 会川 (nay là Huilixi) và đến sông Lệ Giang Jinsha 沙江. Cánh quân giữa do Hốt Tất Liệt chỉ huy tiến qua thành phố Mantuo (nay là Hanyuan North, Tứ Xuyên) qua sông Dadu 渡大, dọc theo lãnh thổ nhà Thanh cổ đi hơn 1000 km về phía nam, vào đầu tháng 11, đến bờ sông Jinsha. Ước tính, trong tổng số 100 nghìn quân của cả 3 mũi thì cánh quân phía Tây của Wuliang Hetai có không ít hơn 15 nghìn quân.  

Vua Đại Lý Duẩn Hành Chi 段兴智 cử Tể tướng Cao Tương Gaoxiang Kublai 高祥 dẫn 100 nghìn quân từ Thiểm Tây tiến ra Huichuan 会川 đối phó. 

Cánh quân phía Tây của Wuliang Hetai chiếm được Lệ Giang. Cao Tương phải rút lui về chấn giữ đèo Đầu Rồng 龙首关. Sau khi hội quân, cả 3 toán quân Mông Cổ tập trung tấn công và đã đánh bại đại quân của Cao Tương tại Đèo Đầu Rồng 龙首关.

Sau khi trận chiến kết thúc, Hốt Tất Liệt đã ra lệnh cho Wuliang tiếp tục chinh phục các bộ lạc còn lại, và lệnh cho Liu Shizhong làm sứ thần áp đặt sự cai trịcủa Mông Cổ lên Đại Lý. Hốt Tất Liệt dẫn quân quay về phía bắc. WuLiang tiến vào Keab Chicheng. Vào mùa thu năm 1254 (năm thứ tư của Hoàng đế Xianzong ở Mông Cổ và năm thứ ba của Tianding ở Đại Lý), Wuliang Hetai dẫn quân đánh chiếm Bechicheng (nay là Côn Minh) truy đuổi Duẫn Hành Chi đến Côn Minh, và khi Duẫn Hành Chi chạy đến Kunze (nay là Yiliang) thì bị bắt. Duẫn Hành Chi bị dẫn giải đến Triều đình Khan miền bắc Mông Cổ. Meng Ge Khan cho phép Duẫn Hành Chi tiếp tục cai quản các bộ thuộc về ông. Wuliang Hetai sử dụng 20000 quân của gia tộc Duẩn làm tiên phong chiếm toàn bộ lãnh thổ Đại Lý.

Sau hai năm chiến đấu ác liệt, WuLiang đã chinh phục được Vương quốc Bare and Bald (tức là Luo Shigui, miền tây Quý Châu ngày nay), Luoluosi (tỉnh Tứ Xuyên Xichang ngày nay và tỉnh tự trị Liangshan Yi ), và Vương quốc Ziman Boli (khu vực Yuanjiang ngày nay). Thủ lĩnh Baiman Xilaifu bị bắt.

http://www.qulishi.com/article/201811/306471.html
http://www.qulishi.com/huati/menggumiedalizhizhan01/

Vào năm 1254 WuLiang  đưa đội kỵ binh 15 nghìn quân Mông Cổ cùng với 20000 quân của gia tộc Duẩn xâm nhập vào Đại Việt dọc theo phía hữu ngạn sông Hồng. Phần Đại Việt tiếp với Nam Tống kéo dài tới Lạng Sơn, có lẽ đường tiến quân của WuLiang là đi qua Lào Cai. 

Địa hình Đại Việt không giống như vùng cao nguyên Vân Nam. Phần phía Bắc và Tây giáp với Đại Lý, là các dáy núi đá dốc và rừng rậm đổ dọc về phía từ Tây Bắc xuống Đông Nam. Phần đồng bằng sông Hồng có cấu trúc gò đồi bao quanh là nước chảy. Do địa hình không phải là bình nguyên mà là rừng rậm nhiệt đới và đầm lầy nên không thể có đủ lượng cỏ cho ngựa ăn. Các mũi tiến quân của WuLiang không thể triển khai được.

Để biết được chiến sự đã diễn ra thế nào chúng ta căn cứ vào quy tắc, các đường đi trong vùng núi đá là đi theo các hẻm giữa các dãy núi và các đường này hầu như không hề thay đổi theo thời gian. Chúng là các con đường đi cả nghìn năm, vì thế mà nay chúng là các đường quốc lộ. Tiếp theo nữa là do việc các con sông liên tục mang phù sa bồi đắp mà nhiều vùng nay là đồng bằng thì trước đây là đầm lầy. Cũng như thế các con sông cũng rộng hơn ngày nay nhiều. Hàng năm vào mùa mưa, nước sông Hồng chảy lênh láng khắp vùng đồng bằng khu vực sông Phan. Phù sa bồi thêm một lớp dày 5mm mỗi năm. Như thế sau 800 năm nó bồi được một lớp đất khoảng 4m. Điều này cho thấy vào thế kỷ thứ 12 thì vùng đất này thấp hơn hiện nay tới 4m và con sông Phan thì rộng tới 150m. Vào thế kỷ 12 đầm hồ còn rất nhiều, người dân sống trên các gò đồi và đi lại chủ yếu bằng thuyền mảng nhỏ. Mỗi gò đồi là một làng. Người dân vợt đất làm nhà và làm đường trong làng vì thế bao quanh làng là dãy tre, mương nước, và ao sâu. Khả năng là quân của WuLiang đã tiến dọc theo đường QL14 giữa các dãy núi theo rồi qua QL2C để tránh đầm lầy phía nam hồ Thác Bà. Tiếp theo chúng tiến theo chân dãy núi Tam Đảo vào vùng đồi đất đỏ Hương Canh. 

Cuộc chiến đánh quân Mông ĐVSKTT viết
- Mùa đông, tháng 11, lệnh truyền cả nước sắm sửa vũ khí.
- Tháng 12, ngày 12, tướng Mông Uriyangqatai (1200-1271) xâm phạm Bình Lệ Nguyên.
- Vua thân hành đốc chiến, xông pha tên đạn. Quan quân hơi núng, vua ngoảnh trông tả hữu, chỉ có Lê Phụ Trần (tức Lê Trần) một mình một ngựa, ra vào trận giặc, sắc mặt bình thản như không.
- Lúc ấy, có người khuyên Trần Cảnh ở lại để chỉ huy chiến đấu. Phụ Trần cố sức can: "Nay thì bệ hạ chỉ đánh một ván dốc túi thôi! Hãy nên tạm lánh chúng, sao lại có thể dễ dàng tin lời người ta thế!". Bấy giờ, vua mới lui quân đóng ở sông Lô. Phụ Trần giữ phía sau. Quân giặc bắn loạn xạ, Phụ Trrần lấy ván thuyền che cho vua khỏi trúng tên giặc.
- Thế giặc rất mạnh, Trần Cảnh lui giữ sông Thiên Mạc. Phụ Trần theo vua bàn những việc cơ mật, rất ít người biết được đều đó. 
- Vua ngự thuyền nhỏ đến thuyền Thái úy Nhật Hiệu hỏi kế sách (chống giặc). Nhật Hiệu đương dựa mạn thuyền, cứ ngồi chứ không đứng dậy nổi, chỉ lấy ngón tay chấm nước viết hai chỉ "nhập
Tống" lên mạn thuyền. Vua hỏi quân Tinh Cương ở đâu? (Tinh Cương là quân do Nhật Hiệu chỉ huy). Nhật Hiệu trả lời: "Không gọi được chúng đến"
- Vua lập tức dời thuyền đến hỏi Thái sư Trần Thủ Độ, Thủ Độ trả lời: "Đầu thần chưa rơi xuống đất, bệ hạ đừng lo gì khác".
- Ngày 24, vua và Thái Tử ngự lâu thuyền, tiến quân đến Đông Bộ Đầu, đón đánh, cả phá được quân giặc. Quân Mông chạy trốn về, đến trại Quy Hóa, chủ trại là Hà Bổng chiêu tập người Man ra tập kích, lại cả phá bọn chúng.

Uriyangqatai (WuLiang) là con của Subotai, là một trong tứ dũng của Thành Cát Tư Hãn. Con của Uriyangqatai là Ajiu nguyên soái chỉ huy 700 nghìn quân đánh chiếm thành Tương Dương tiêu diệt Nam Tống. Quân của Uriyangqatai rất giỏi cưỡi ngựa bắn cung. Đoạn "Quân giặc bắn loạn xạ, Phụ Trrần lấy ván thuyền che cho vua khỏi trúng tên giặc." cho thấy việc "Vua Trần Cảnh ngoảnh trông tả hữu, chỉ có Lê Phụ Trần (tức Lê Trần) một mình một ngựa, ra vào trận giặc, sắc mặt bình thản như không." là viết phịa. Lê Phụ Trần không thể một mình một ngựa mà sống sót được dưới làn tên bắn của đội quân thiện chiến đánh khắp cả châu Âu - Châu Á. 

Bình Lệ Nguyên là vùng đất thận lợi cho kỵ binh Mông Cổ. Việc Trần Cảnh hỏi quân của Nhật Hiệu ở đâu? Nhật Hiệu trả lời: "Không gọi được chúng đến" là cho thấy quân của nhà Trần đã thua trận và tan tác. 

Chỉ 2 ngày sau trận đại bại ở Bình Lệ Nguyên, ngày 24/2/1258 xảy ra trận thắng ở Đông Bộ Đầu. 

Đông Bộ Đầu được cho là ở vùng Hòe Nhai nay, tức dốc Hàng Than ở đầu cầu Long Biên, là nơi quân của Trần Cảnh đón đánh cản phá được quân Mông. Đông Bộ Đầu ở ven sông phía bên này sông Hồng. Rõ ràng là ĐVSKTT đã nói rõ, quân Mông đã tiến đánh Thăng Long và Linh Từ Thái Hâu đã kịp đưa hoàng thái tử, cung phi, công chúa và vợ con các tướng soái trốn thoát. Như thế việc khẳng định Đông Bộ Đầu là trận đánh quyết định khiến cho quân Mông phải tự rút về nước có phần không đúng. Trận Đông Bộ Đầu cùng lắm là đánh nhau với toán quân Mông đánh vào Kinh Thành Thăng Long. Toàn bộ 35 nghìn quân Mông và Đại Lý vẫn còn cố thủ ở Bình Lệ Nguyên. Việc quân Mông bại trận và phải rút về nước có thể là do 20 nghìn quân Đại Lý làm binh biến đánh lại 15 nghìn quân kỵ binh Mông Cổ. 

Trần Thủ Độ đã cho đổi họ Lý thành họ Nguyễn từ trước cuộc xâm lược lần thứ nhất của quân Nguyên -  Mông, vậy những người mang họ Lý hiện nay có thể là 20 nghìn quân Đại Lý năm xưa, được đăng triều đình cho nhận họ Lý.

ĐVSKTT viết 

Tháng 1/1259, phu nhân Trần Thủ Độ là Linh Từ quốc mẫu Trần thị mất. Trần thị được gọi là quốc mẫu vì đó vốn là hiệu của Ngô phu nhân trước kia, tức là hoàng hậu Thái Tông thấy Linh Từ đã từng làm hoàng hậu của Lý Huệ Tông, không nỡ gọi là công chúa, cho nên phong làm quốc mẫu, cũng là biệt danh của hoàng hậu. Xe kiệu, mũ áo, quân hầu của bà đều ngang với hoàng 

Đến khi người Nguyên tắt đường vào cướp, kinh thành thất thủ, Linh Từ ở Hoàng Giang, giữ gìn hoàng thái tử, cung phi, công chúa và vợ con các tướng soái thoát khỏi giặc cướp, lại khám xét thuyền các nhà chứa giấu quân khí đều đưa dùng vào việc quân.



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ly, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ly_plot$centroid <- sf::st_transform(ly_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ly <- ly_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ly=as.numeric(round(prop.ly, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ly, area_km, songuoi_km, lng, lat, distm_km)

ly_peak <- ly_plot %>% filter(NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat")

datatable(ly, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, warning=FALSE, message=FALSE, lazy=TRUE}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ly_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ly_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lý")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ly <- dat_sff %>% filter(Ho=="Lý") %>% st_as_sf(crs = 4326)
ly$centroid <- sf::st_transform(ly, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ly <- ly %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ly_radius <- ly %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ly_radius$distm_km
pro.pop<-ly_radius$pro.pop
rank<-ly_radius$rank
commune<-ly_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lý")

plot_df
```



```{r, lazy=TRUE}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plotf <- ly_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ly, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ly_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ly_plotf$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lý")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ly <- dat_sff %>% filter(Ho=="Lý") %>% st_as_sf(crs = 4326)
ly$centroid <- sf::st_transform(ly, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ly <- ly %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ly_radius <- ly %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ly_radius$distm_km
songuoi_km<-ly_radius$songuoi_km
rank<-ly_radius$rank
commune<-ly_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-40*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lý")

plot_df
```

## Hoàng



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hoang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hoang_plot$centroid <- sf::st_transform(hoang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hoang <- hoang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hoang=as.numeric(round(prop.hoang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hoang, area_km, songuoi_km, lng, lat, distm_km)

hoang_peak <- hoang_plot %>% filter(NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh")

datatable(hoang, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```



```{r, warning=FALSE, message=FALSE, lazy=TRUE}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hoang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hoang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hoang_plot$prop.hoang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hoàng")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
hoang <- dat_sff %>% filter(Ho=="Hoàng") %>% st_as_sf(crs = 4326)
hoang$centroid <- sf::st_transform(hoang, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
hoang <- hoang %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

hoang_radius <- hoang %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-hoang_radius$distm_km
pro.pop<-hoang_radius$pro.pop
rank<-hoang_radius$rank
commune<-hoang_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-86*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Hoàng")

plot_df
```



```{r, lazy=TRUE}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plotf <- hoang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hoang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hoang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hoang_plotf$prop.hoang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hoàng")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
hoang <- dat_sff %>% filter(Ho=="Hoàng") %>% st_as_sf(crs = 4326)
hoang$centroid <- sf::st_transform(hoang, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
hoang <- hoang %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

hoang_radius <- hoang %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-hoang_radius$distm_km
songuoi_km<-hoang_radius$songuoi_km
rank<-hoang_radius$rank
commune<-hoang_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-47*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Hoàng")

plot_df
```

## Triệu



```{r, warning=FALSE, message=FALSE, lazy=FALSE}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trieu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
trieu_plot$centroid <- sf::st_transform(trieu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

trieu <- trieu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.trieu=as.numeric(round(prop.trieu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trieu, area_km, songuoi_km, lng, lat, distm_km)

trieu_peak <- trieu_plot %>% filter(NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh")

datatable(trieu, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))
```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trieu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=trieu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Triệu")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
trieu <- dat_sff %>% filter(Ho=="Triệu") %>% st_as_sf(crs = 4326)
trieu$centroid <- sf::st_transform(trieu, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
trieu <- trieu %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

trieu_radius <- trieu %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-trieu_radius$distm_km
pro.pop<-trieu_radius$pro.pop
rank<-trieu_radius$rank
commune<-trieu_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-85*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Triệu")

plot_df
```



```{r, lazy = TRUE}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plotf <- trieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.trieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trieu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trieu_plotf$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Triệu")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
trieu <- dat_sff %>% filter(Ho=="Triệu") %>% st_as_sf(crs = 4326)
trieu$centroid <- sf::st_transform(trieu, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
trieu <- trieu %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

trieu_radius <- trieu %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-trieu_radius$distm_km
songuoi_km<-trieu_radius$songuoi_km
rank<-trieu_radius$rank
commune<-trieu_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-14*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Triệu")

plot_df
```

## Nguyễn



```{r, warning=FALSE, message=FALSE, lazy = FALSE}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguyen, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nguyen_plot$centroid <- sf::st_transform(nguyen_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nguyen <- nguyen_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nguyen=as.numeric(round(prop.nguyen, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguyen, area_km, songuoi_km, lng, lat, distm_km)

nguyen_peak <- nguyen_plot %>% filter(NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo")

datatable(nguyen, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nguyen_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nguyễn")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
nguyen <- dat_sff %>% filter(Ho=="Nguyễn") %>% st_as_sf(crs = 4326)
nguyen$centroid <- sf::st_transform(nguyen, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
nguyen <- nguyen %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

nguyen_radius <- nguyen %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-nguyen_radius$distm_km
pro.pop<-nguyen_radius$pro.pop
rank<-nguyen_radius$rank
commune<-nguyen_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-88*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Nguyễn")

plot_df
```



```{r, lazy = TRUE}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plotf <- nguyen_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nguyen_plotf$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nguyễn")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
nguyen <- dat_sff %>% filter(Ho=="Nguyễn") %>% st_as_sf(crs = 4326)
nguyen$centroid <- sf::st_transform(nguyen, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
nguyen <- nguyen %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

nguyen_radius <- nguyen %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-nguyen_radius$distm_km
songuoi_km<-nguyen_radius$songuoi_km
rank<-nguyen_radius$rank
commune<-nguyen_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-1100*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Nguyễn")

plot_df
```

## Trần



```{r, warning=FALSE, message=FALSE, lazy = FALSE}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tran, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tran_plot$centroid <- sf::st_transform(tran_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tran <- tran_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tran=as.numeric(round(prop.tran, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tran, area_km, songuoi_km, lng, lat, distm_km)

tran_peak <- tran_plot %>% filter(NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan")

datatable(tran, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tran_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tran_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trần")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
tran <- dat_sff %>% filter(Ho=="Trần") %>% st_as_sf(crs = 4326)
tran$centroid <- sf::st_transform(tran, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
tran <- tran %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran_radius <- tran %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-tran_radius$distm_km
pro.pop<-tran_radius$pro.pop
rank<-tran_radius$rank
commune<-tran_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-94*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Trần")

plot_df
```



```{r, lazy = TRUE}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plotf <- tran_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tran, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tran_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tran_plotf$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trần")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
tran <- dat_sff %>% filter(Ho=="Trần") %>% st_as_sf(crs = 4326)
tran$centroid <- sf::st_transform(tran, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
tran <- tran %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran_radius <- tran %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-tran_radius$distm_km
songuoi_km<-tran_radius$songuoi_km
rank<-tran_radius$rank
commune<-tran_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-1500*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Trần")

plot_df
```

## Lê



```{r, warning=FALSE, message=FALSE, lazy = FALSE}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.le, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
le_plot$centroid <- sf::st_transform(le_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

le <- le_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.le=as.numeric(round(prop.le, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.le, area_km, songuoi_km, lng, lat, distm_km)

le_peak <- le_plot %>% filter(NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa")

datatable(le, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=le_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=le_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lê")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
le <- dat_sff %>% filter(Ho=="Lê") %>% st_as_sf(crs = 4326)
le$centroid <- sf::st_transform(le, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
le <- le %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

le_radius <- le %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-le_radius$distm_km
pro.pop<-le_radius$pro.pop
rank<-le_radius$rank
commune<-le_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-78*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lê")

plot_df
```



```{r, lazy = TRUE}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plotf <- le_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.le, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=le_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(le_plotf$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lê")
```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
le <- dat_sff %>% filter(Ho=="Lê") %>% st_as_sf(crs = 4326)
le$centroid <- sf::st_transform(le, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
le <- le %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

le_radius <- le %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-le_radius$distm_km
songuoi_km<-le_radius$songuoi_km
rank<-le_radius$rank
commune<-le_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-750*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lê")

plot_df
```

## A

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
a_sff <- dat_sff %>% mutate(prop.a=(sum(subset(., Ho=="A")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="A")
a_plot <- a_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.a, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
a_plot$centroid <- sf::st_transform(a_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

a <- a_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ngoc Linh" & NAME_2=="Dak Glei"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.a=as.numeric(round(prop.a, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.a, area_km, songuoi_km, lng, lat, distm_km)

a_peak <- a_plot %>% filter(NAME_3=="Xa Ngoc Linh" & NAME_2=="Dak Glei")

```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
a_sf <- dat_sf %>% mutate(prop.a=(sum(subset(., Ho=="A")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="A")
a_plot <- a_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.a, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=a_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=a_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(a_plot$prop.a[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("A")
```



```{r, lazy=TRUE}
a_sff <- dat_sff %>% mutate(prop.a=(sum(subset(., Ho=="A")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="A")
a_plotf <- a_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.a, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=a_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(a_plotf$prop.a[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("A")
```

## An

```{r, warning=FALSE, message=FALSE}
an_sff <- dat_sff %>% mutate(prop.an=(sum(subset(., Ho=="An")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="An")
an_plot <- an_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.an, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
an_plot$centroid <- sf::st_transform(an_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

an <- an_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cao Thang" & NAME_2=="Thanh Mien"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.an=as.numeric(round(prop.an, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.an, area_km, songuoi_km, lng, lat, distm_km)

an_peak <- an_plot %>% filter(NAME_3=="Xa Cao Thang" & NAME_2=="Thanh Mien")

```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
an_sf <- dat_sf %>% mutate(prop.an=(sum(subset(., Ho=="An")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="An")
an_plot <- an_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.an, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=an_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=an_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(an_plot$prop.an[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("An")
```



```{r, lazy=TRUE}
an_sff <- dat_sff %>% mutate(prop.an=(sum(subset(., Ho=="An")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="An")
an_plotf <- an_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.an, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=an_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(an_plotf$prop.an[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("An")
```

## Âu

```{r, warning=FALSE, message=FALSE}
au_sff <- dat_sff %>% mutate(prop.au=(sum(subset(., Ho=="Âu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Âu")
au_plot <- au_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.au, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
au_plot$centroid <- sf::st_transform(au_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

au <- au_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Na Mao" & NAME_2=="Dai Tu"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.au=as.numeric(round(prop.au, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.au, area_km, songuoi_km, lng, lat, distm_km)

au_peak <- au_plot %>% filter(NAME_3=="Xa Na Mao" & NAME_2=="Dai Tu")

```



```{r, message=FALSE, warning=FALSE, lazy=TRUE}
au_sf <- dat_sf %>% mutate(prop.au=(sum(subset(., Ho=="Âu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Âu")
au_plot <- au_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.au, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=au_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=au_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(au_plot$prop.au[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Âu")
```



```{r, lazy=TRUE}
au_sff <- dat_sff %>% mutate(prop.au=(sum(subset(., Ho=="Âu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Âu")
au_plotf <- au_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.au, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=au_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(au_plotf$prop.au[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Âu")
```

## Bạc

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
bac_sff <- dat_sff %>% mutate(prop.bac=(sum(subset(., Ho=="Bạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bạc")
bac_plot <- bac_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bac, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
bac_plot$centroid <- sf::st_transform(bac_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

bac <- bac_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chieng Khoang" & NAME_2=="Quynh Nhai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.bac=as.numeric(round(prop.bac, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bac, area_km, songuoi_km, lng, lat, distm_km)

bac_peak <- bac_plot %>% filter(NAME_3=="Xa Chieng Khoang" & NAME_2=="Quynh Nhai")

```



```{r, message=FALSE, warning=FALSE}
bac_sf <- dat_sf %>% mutate(prop.bac=(sum(subset(., Ho=="Bạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bạc")
bac_plot <- bac_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.bac, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bac_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=bac_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bac_plot$prop.bac[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bạc")
```



```{r, lazy=TRUE}
bac_sff <- dat_sff %>% mutate(prop.bac=(sum(subset(., Ho=="Bạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bạc")
bac_plotf <- bac_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.bac, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bac_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bac_plotf$prop.bac[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bạc")
```

## Bạch

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
bach_sff <- dat_sff %>% mutate(prop.bach=(sum(subset(., Ho=="Bạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bạch")
bach_plot <- bach_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bach, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
bach_plot$centroid <- sf::st_transform(bach_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

bach <- bach_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Mi Hoa" & NAME_2=="Kim Boi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.bach=as.numeric(round(prop.bach, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bach, area_km, songuoi_km, lng, lat, distm_km)

bach_peak <- bach_plot %>% filter(NAME_3=="Xa Mi Hoa" & NAME_2=="Kim Boi")

```



```{r, message=FALSE, warning=FALSE}
bach_sf <- dat_sf %>% mutate(prop.bach=(sum(subset(., Ho=="Bạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bạch")
bach_plot <- bach_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.bach, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bach_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=bach_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bach_plot$prop.bach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bạch")
```



```{r, lazy = TRUE}
bach_sff <- dat_sff %>% mutate(prop.bach=(sum(subset(., Ho=="Bạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bạch")
bach_plotf <- bach_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.bach, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bach_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bach_plotf$prop.bach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bạch")
```

## Bàn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ban_sff <- dat_sff %>% mutate(prop.ban=(sum(subset(., Ho=="Bàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bàn")
ban_plot <- ban_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ban, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ban_plot$centroid <- sf::st_transform(ban_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ban <- ban_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Nam Muoi" & NAME_2=="Van Chan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ban=as.numeric(round(prop.ban, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ban, area_km, songuoi_km, lng, lat, distm_km)

ban_peak <- ban_plot %>% filter(NAME_3=="Xa Nam Muoi" & NAME_2=="Van Chan")

```



```{r, message=FALSE, warning=FALSE}
ban_sf <- dat_sf %>% mutate(prop.ban=(sum(subset(., Ho=="Bàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bàn")
ban_plot <- ban_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ban, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ban_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ban_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ban_plot$prop.ban[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bàn")
```



```{r, lazy = TRUE}
ban_sff <- dat_sff %>% mutate(prop.ban=(sum(subset(., Ho=="Bàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bàn")
ban_plotf <- ban_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ban, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ban_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ban_plotf$prop.ban[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bàn")
```

## Bành

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
banh_sff <- dat_sff %>% mutate(prop.banh=(sum(subset(., Ho=="Bành")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bành")
banh_plot <- banh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.banh, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
banh_plot$centroid <- sf::st_transform(banh_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

banh <- banh_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Yen Thinh" & NAME_2=="Huu Lung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.banh=as.numeric(round(prop.banh, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.banh, area_km, songuoi_km, lng, lat, distm_km)

banh_peak <- banh_plot %>% filter(NAME_3=="Xa Yen Thinh" & NAME_2=="Huu Lung")

```



```{r, message=FALSE, warning=FALSE}
banh_sf <- dat_sf %>% mutate(prop.banh=(sum(subset(., Ho=="Bành")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bành")
banh_plot <- banh_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.banh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=banh_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=banh_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(banh_plot$prop.banh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bành")
```



```{r, lazy = TRUE}
banh_sff <- dat_sff %>% mutate(prop.banh=(sum(subset(., Ho=="Bành")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bành")
banh_plotf <- banh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.banh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=banh_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(banh_plotf$prop.banh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bành")
```

## Bế

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
be_sff <- dat_sff %>% mutate(prop.be=(sum(subset(., Ho=="Bế")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bế")
be_plot <- be_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.be, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
be_plot$centroid <- sf::st_transform(be_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

be <- be_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Doc Lap" & NAME_2=="Quang Uyen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.be=as.numeric(round(prop.be, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.be, area_km, songuoi_km, lng, lat, distm_km)

be_peak <- be_plot %>% filter(NAME_3=="Xa Doc Lap" & NAME_2=="Quang Uyen")

```



```{r, message=FALSE, warning=FALSE}
be_sf <- dat_sf %>% mutate(prop.be=(sum(subset(., Ho=="Bế")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bế")
be_plot <- be_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.be, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=be_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=be_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(be_plot$prop.be[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bế")
```



```{r, lazy = TRUE}
be_sff <- dat_sff %>% mutate(prop.be=(sum(subset(., Ho=="Bế")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bế")
be_plotf <- be_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.be, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=be_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(be_plotf$prop.be[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bế")
```

## Biện

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
bien_sff <- dat_sff %>% mutate(prop.bien=(sum(subset(., Ho=="Biện")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Biện")
bien_plot <- bien_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bien, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
bien_plot$centroid <- sf::st_transform(bien_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

bien <- bien_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ha Man" & NAME_2=="Thuan Thanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.bien=as.numeric(round(prop.bien, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bien, area_km, songuoi_km, lng, lat, distm_km)

bien_peak <- bien_plot %>% filter(NAME_3=="Xa Ha Man" & NAME_2=="Thuan Thanh")

```



```{r, message=FALSE, warning=FALSE}
bien_sf <- dat_sf %>% mutate(prop.bien=(sum(subset(., Ho=="Biện")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Biện")
bien_plot <- bien_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.bien, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bien_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=bien_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bien_plot$prop.bien[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Biện")
```



```{r, lazy = TRUE}
bien_sff <- dat_sff %>% mutate(prop.bien=(sum(subset(., Ho=="Biện")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Biện")
bien_plotf <- bien_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.bien, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bien_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bien_plotf$prop.bien[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Biện")
```

## Bùi

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plot <- bui_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bui, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
bui_plot$centroid <- sf::st_transform(bui_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

bui <- bui_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Lac Sy" & NAME_2=="Yen Thuy"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.bui=as.numeric(round(prop.bui, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.bui, area_km, songuoi_km, lng, lat, distm_km)

bui_peak <- bui_plot %>% filter(NAME_3=="Xa Lac Sy" & NAME_2=="Yen Thuy")

```



```{r, message=FALSE, warning=FALSE}
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plot <- bui_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.bui, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bui_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=bui_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bùi")
```



```{r, lazy = TRUE}
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plotf <- bui_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.bui, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=bui_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Bùi")
```

## Cà

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ca_sff <- dat_sff %>% mutate(prop.ca=(sum(subset(., Ho=="Cà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cà")
ca_plot <- ca_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ca, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ca_plot$centroid <- sf::st_transform(ca_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ca <- ca_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Giang Ly" & NAME_2=="Khanh Vinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ca=as.numeric(round(prop.ca, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ca, area_km, songuoi_km, lng, lat, distm_km)

ca_peak <- ca_plot %>% filter(NAME_3=="Xa Giang Ly" & NAME_2=="Khanh Vinh")

```



```{r, message=FALSE, warning=FALSE}
ca_sf <- dat_sf %>% mutate(prop.ca=(sum(subset(., Ho=="Cà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cà")
ca_plot <- ca_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ca, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ca_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ca_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ca_plot$prop.ca[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cà")
```



```{r, lazy = TRUE}
ca_sff <- dat_sff %>% mutate(prop.ca=(sum(subset(., Ho=="Cà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cà")
ca_plotf <- ca_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ca, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ca_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ca_plotf$prop.ca[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cà")
```

## Cầm

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cam_sff <- dat_sff %>% mutate(prop.cam=(sum(subset(., Ho=="Cầm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cầm")
cam_plot <- cam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cam, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
cam_plot$centroid <- sf::st_transform(cam_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

cam <- cam_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Xuan Chinh" & NAME_2=="Thuong Xuan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.cam=as.numeric(round(prop.cam, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cam, area_km, songuoi_km, lng, lat, distm_km)

cam_peak <- cam_plot %>% filter(NAME_3=="Xa Xuan Chinh" & NAME_2=="Thuong Xuan")

```



```{r, message=FALSE, warning=FALSE}
cam_sf <- dat_sf %>% mutate(prop.cam=(sum(subset(., Ho=="Cầm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cầm")
cam_plot <- cam_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.cam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cam_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=cam_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cam_plot$prop.cam[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cầm")
```



```{r, message=FALSE, warning=FALSE}
cam_sff <- dat_sff %>% mutate(prop.cam=(sum(subset(., Ho=="Cầm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cầm")
cam_plotf <- cam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.cam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cam_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cam_plotf$prop.cam[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cầm")
```

## Cấn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
can_sff <- dat_sff %>% mutate(prop.can=(sum(subset(., Ho=="Cấn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cấn")
can_plot <- can_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.can, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
can_plot$centroid <- sf::st_transform(can_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

can <- can_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Kim" & NAME_2=="Thach That"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.can=as.numeric(round(prop.can, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.can, area_km, songuoi_km, lng, lat, distm_km)

can_peak <- can_plot %>% filter(NAME_3=="Xa Phu Kim" & NAME_2=="Thach That")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
can_sf <- dat_sf %>% mutate(prop.can=(sum(subset(., Ho=="Cấn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cấn")
can_plot <- can_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.can, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=can_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=can_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(can_plot$prop.can[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cấn")
```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
can_sff <- dat_sff %>% mutate(prop.can=(sum(subset(., Ho=="Cấn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cấn")
can_plotf <- can_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.can, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=can_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(can_plotf$prop.can[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cấn")
```

## Cao

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cao_sff <- dat_sff %>% mutate(prop.cao=(sum(subset(., Ho=="Cao")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cao")
cao_plot <- cao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cao, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
cao_plot$centroid <- sf::st_transform(cao_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

cao <- cao_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Khanh Thanh" & NAME_2=="Khanh Vinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.cao=as.numeric(round(prop.cao, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cao, area_km, songuoi_km, lng, lat, distm_km)

cao_peak <- cao_plot %>% filter(NAME_3=="Xa Khanh Thanh" & NAME_2=="Khanh Vinh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cao_sf <- dat_sf %>% mutate(prop.cao=(sum(subset(., Ho=="Cao")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cao")
cao_plot <- cao_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.cao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cao_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=cao_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cao_plot$prop.cao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cao")
```



```{r, lazy = TRUE}
cao_sff <- dat_sff %>% mutate(prop.cao=(sum(subset(., Ho=="Cao")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cao")
cao_plotf <- cao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.cao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cao_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cao_plotf$prop.cao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cao")
```

## Chang

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chang_sff <- dat_sff %>% mutate(prop.chang=(sum(subset(., Ho=="Chang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chang")
chang_plot <- chang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
chang_plot$centroid <- sf::st_transform(chang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

chang <- chang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Pu Sam Cap" & NAME_2=="Sin Ho"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.chang=as.numeric(round(prop.chang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chang, area_km, songuoi_km, lng, lat, distm_km)

chang_peak <- chang_plot %>% filter(NAME_3=="Xa Pu Sam Cap" & NAME_2=="Sin Ho")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chang_sf <- dat_sf %>% mutate(prop.chang=(sum(subset(., Ho=="Chang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chang")
chang_plot <- chang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.chang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=chang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chang_plot$prop.chang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chang")
```



```{r, lazy = TRUE}
chang_sff <- dat_sff %>% mutate(prop.chang=(sum(subset(., Ho=="Chang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chang")
chang_plotf <- chang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.chang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chang_plotf$prop.chang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chang")
```

## Chảo

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chao_sff <- dat_sff %>% mutate(prop.chao=(sum(subset(., Ho=="Chảo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chảo")
chao_plot <- chao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chao, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
chao_plot$centroid <- sf::st_transform(chao_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

chao <- chao_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Suoi Thau" & NAME_2=="Sa Pa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.chao=as.numeric(round(prop.chao, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chao, area_km, songuoi_km, lng, lat, distm_km)

chao_peak <- chao_plot %>% filter(NAME_3=="Xa Suoi Thau" & NAME_2=="Sa Pa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chao_sf <- dat_sf %>% mutate(prop.chao=(sum(subset(., Ho=="Chảo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chảo")
chao_plot <- chao_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.chao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chao_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=chao_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chao_plot$prop.chao[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chảo")
```



```{r, lazy = TRUE}
chao_sff <- dat_sff %>% mutate(prop.chao=(sum(subset(., Ho=="Chảo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chảo")
chao_plotf <- chao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.chao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chao_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chao_plotf$prop.chao[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chảo")
```

## Châu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chau_sff <- dat_sff %>% mutate(prop.chau=(sum(subset(., Ho=="Châu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Châu")
chau_plot <- chau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chau, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
chau_plot$centroid <- sf::st_transform(chau_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

chau <- chau_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa O Lam" & NAME_2=="Tri Ton"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.chau=as.numeric(round(prop.chau, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chau, area_km, songuoi_km, lng, lat, distm_km)

chau_peak <- chau_plot %>% filter(NAME_3=="Xa O Lam" & NAME_2=="Tri Ton")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chau_sf <- dat_sf %>% mutate(prop.chau=(sum(subset(., Ho=="Châu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Châu")
chau_plot <- chau_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.chau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chau_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=chau_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chau_plot$prop.chau[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Châu")
```



```{r, lazy = TRUE}
chau_sff <- dat_sff %>% mutate(prop.chau=(sum(subset(., Ho=="Châu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Châu")
chau_plotf <- chau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.chau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chau_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chau_plotf$prop.chau[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Châu")
```

## Chế

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
che_sff <- dat_sff %>% mutate(prop.che=(sum(subset(., Ho=="Chế")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chế")
che_plot <- che_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.che, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
che_plot$centroid <- sf::st_transform(che_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

che <- che_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phan Dung" & NAME_2=="Tuy Phong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.che=as.numeric(round(prop.che, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.che, area_km, songuoi_km, lng, lat, distm_km)

che_peak <- che_plot %>% filter(NAME_3=="Xa Phan Dung" & NAME_2=="Tuy Phong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
che_sf <- dat_sf %>% mutate(prop.che=(sum(subset(., Ho=="Chế")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chế")
che_plot <- che_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.che, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=che_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=che_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(che_plot$prop.che[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chế")
```



```{r, lazy = TRUE}
che_sff <- dat_sff %>% mutate(prop.che=(sum(subset(., Ho=="Chế")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chế")
che_plotf <- che_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.che, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=che_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(che_plotf$prop.che[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chế")
```

## Chìu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chiu_sff <- dat_sff %>% mutate(prop.chiu=(sum(subset(., Ho=="Chìu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chìu")
chiu_plot <- chiu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chiu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
chiu_plot$centroid <- sf::st_transform(chiu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

chiu <- chiu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Lam" & NAME_2=="Dam Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.chiu=as.numeric(round(prop.chiu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chiu, area_km, songuoi_km, lng, lat, distm_km)

chiu_peak <- chiu_plot %>% filter(NAME_3=="Xa Quang Lam" & NAME_2=="Dam Ha")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chiu_sf <- dat_sf %>% mutate(prop.chiu=(sum(subset(., Ho=="Chìu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chìu")
chiu_plot <- chiu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.chiu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chiu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=chiu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chiu_plot$prop.chiu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chìu")
```



```{r, lazy = TRUE}
chiu_sff <- dat_sff %>% mutate(prop.chiu=(sum(subset(., Ho=="Chìu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chìu")
chiu_plotf <- chiu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.chiu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chiu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chiu_plotf$prop.chiu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chìu")
```

## Chu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chu_sff <- dat_sff %>% mutate(prop.chu=(sum(subset(., Ho=="Chu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chu")
chu_plot <- chu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
chu_plot$centroid <- sf::st_transform(chu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

chu <- chu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Dong" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.chu=as.numeric(round(prop.chu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chu, area_km, songuoi_km, lng, lat, distm_km)

chu_peak <- chu_plot %>% filter(NAME_3=="Xa Phu Dong" & NAME_2=="Ba Vi")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chu_sf <- dat_sf %>% mutate(prop.chu=(sum(subset(., Ho=="Chu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chu")
chu_plot <- chu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.chu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=chu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chu_plot$prop.chu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chu")
```



```{r, lazy = TRUE}
chu_sff <- dat_sff %>% mutate(prop.chu=(sum(subset(., Ho=="Chu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chu")
chu_plotf <- chu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.chu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chu_plotf$prop.chu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chu")
```

## Chử

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chu2_sff <- dat_sff %>% mutate(prop.chu2=(sum(subset(., Ho=="Chử")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chử")
chu2_plot <- chu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chu2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
chu2_plot$centroid <- sf::st_transform(chu2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

chu2 <- chu2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Van Duc" & NAME_2=="Gia Lam"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.chu2=as.numeric(round(prop.chu2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.chu2, area_km, songuoi_km, lng, lat, distm_km)

chu2_peak <- chu2_plot %>% filter(NAME_3=="Xa Van Duc" & NAME_2=="Gia Lam")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
chu2_sf <- dat_sf %>% mutate(prop.chu2=(sum(subset(., Ho=="Chử")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chử")
chu2_plot <- chu2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.chu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chu2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=chu2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chu2_plot$prop.chu2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chử")
```



```{r, lazy = TRUE}
chu2_sff <- dat_sff %>% mutate(prop.chu2=(sum(subset(., Ho=="Chử")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chử")
chu2_plotf <- chu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.chu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=chu2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(chu2_plotf$prop.chu2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Chử")
```

## Cù

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cu_sff <- dat_sff %>% mutate(prop.cu=(sum(subset(., Ho=="Cù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cù")
cu_plot <- cu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
cu_plot$centroid <- sf::st_transform(cu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

cu <- cu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Van Luong" & NAME_2=="Tam Nong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.cu=as.numeric(round(prop.cu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cu, area_km, songuoi_km, lng, lat, distm_km)

cu_peak <- cu_plot %>% filter(NAME_3=="Xa Van Luong" & NAME_2=="Tam Nong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cu_sf <- dat_sf %>% mutate(prop.cu=(sum(subset(., Ho=="Cù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cù")
cu_plot <- cu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.cu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=cu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cu_plot$prop.cu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cù")
```



```{r, lazy = TRUE}
cu_sff <- dat_sff %>% mutate(prop.cu=(sum(subset(., Ho=="Cù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cù")
cu_plotf <- cu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.cu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cu_plotf$prop.cu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cù")
```

## Cư

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cu2_sff <- dat_sff %>% mutate(prop.cu2=(sum(subset(., Ho=="Cư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cư")
cu2_plot <- cu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cu2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
cu2_plot$centroid <- sf::st_transform(cu2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

cu2 <- cu2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quan Than San" & NAME_2=="Si Ma Cai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.cu2=as.numeric(round(prop.cu2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cu2, area_km, songuoi_km, lng, lat, distm_km)

cu2_peak <- cu2_plot %>% filter(NAME_3=="Xa Quan Than San" & NAME_2=="Si Ma Cai")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cu2_sf <- dat_sf %>% mutate(prop.cu2=(sum(subset(., Ho=="Cư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cư")
cu2_plot <- cu2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.cu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cu2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=cu2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cu2_plot$prop.cu2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cư")
```



```{r, lazy = TRUE}
cu2_sff <- dat_sff %>% mutate(prop.cu2=(sum(subset(., Ho=="Cư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cư")
cu2_plotf <- cu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.cu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cu2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cu2_plotf$prop.cu2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cư")
```

## Cứ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cu1_sff <- dat_sff %>% mutate(prop.cu1=(sum(subset(., Ho=="Cứ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cứ")
cu1_plot <- cu1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cu1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
cu1_plot$centroid <- sf::st_transform(cu1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

cu1 <- cu1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chieng An" & NAME_2=="Muong La"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.cu1=as.numeric(round(prop.cu1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.cu1, area_km, songuoi_km, lng, lat, distm_km)

cu1_peak <- cu1_plot %>% filter(NAME_3=="Xa Chieng An" & NAME_2=="Muong La")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
cu1_sf <- dat_sf %>% mutate(prop.cu1=(sum(subset(., Ho=="Cứ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cứ")
cu1_plot <- cu1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.cu1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cu1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=cu1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cu1_plot$prop.cu1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cứ")
```



```{r, lazy = TRUE}
cu1_sff <- dat_sff %>% mutate(prop.cu1=(sum(subset(., Ho=="Cứ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cứ")
cu1_plotf <- cu1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.cu1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=cu1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(cu1_plotf$prop.cu1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Cứ")
```

## Đàm

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dam_sff <- dat_sff %>% mutate(prop.dam=(sum(subset(., Ho=="Đàm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đàm")
dam_plot <- dam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dam, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dam_plot$centroid <- sf::st_transform(dam_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dam <- dam_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Chau" & NAME_2=="Quang Trach"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dam=as.numeric(round(prop.dam, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dam, area_km, songuoi_km, lng, lat, distm_km)

dam_peak <- dam_plot %>% filter(NAME_3=="Xa Quang Chau" & NAME_2=="Quang Trach")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dam_sf <- dat_sf %>% mutate(prop.dam=(sum(subset(., Ho=="Đàm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đàm")
dam_plot <- dam_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dam_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dam_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dam_plot$prop.dam[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đàm")
```



```{r, lazy = TRUE}
dam_sff <- dat_sff %>% mutate(prop.dam=(sum(subset(., Ho=="Đàm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đàm")
dam_plotf <- dam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dam_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dam_plotf$prop.dam[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đàm")
```

## Đặng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dang_sff <- dat_sff %>% mutate(prop.dang=(sum(subset(., Ho=="Đặng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đặng")
dang_plot <- dang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dang_plot$centroid <- sf::st_transform(dang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dang <- dang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa My Hung" & NAME_2=="My Loc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dang=as.numeric(round(prop.dang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dang, area_km, songuoi_km, lng, lat, distm_km)

dang_peak <- dang_plot %>% filter(NAME_3=="Xa My Hung" & NAME_2=="My Loc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dang_sf <- dat_sf %>% mutate(prop.dang=(sum(subset(., Ho=="Đặng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đặng")
dang_plot <- dang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dang_plot$prop.dang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đặng")
```



```{r, lazy = TRUE}
dang_sff <- dat_sff %>% mutate(prop.dang=(sum(subset(., Ho=="Đặng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đặng")
dang_plotf <- dang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dang_plotf$prop.dang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đặng")
```

## Danh

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
danh_sff <- dat_sff %>% mutate(prop.danh=(sum(subset(., Ho=="Danh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Danh")
danh_plot <- danh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.danh, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
danh_plot$centroid <- sf::st_transform(danh_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

danh <- danh_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dinh Hoa" & NAME_2=="Go Quao"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.danh=as.numeric(round(prop.danh, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.danh, area_km, songuoi_km, lng, lat, distm_km)

danh_peak <- danh_plot %>% filter(NAME_3=="Xa Dinh Hoa" & NAME_2=="Go Quao")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
danh_sf <- dat_sf %>% mutate(prop.danh=(sum(subset(., Ho=="Danh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Danh")
danh_plot <- danh_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.danh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=danh_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=danh_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(danh_plot$prop.danh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Danh")
```



```{r, lazy = TRUE}
danh_sff <- dat_sff %>% mutate(prop.danh=(sum(subset(., Ho=="Danh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Danh")
danh_plotf <- danh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.danh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=danh_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(danh_plotf$prop.danh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Danh")
```

## Đào

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plot <- dao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dao, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dao_plot$centroid <- sf::st_transform(dao_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dao <- dao_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Hung" & NAME_2=="Khoai Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dao=as.numeric(round(prop.dao, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dao, area_km, songuoi_km, lng, lat, distm_km)

dao_peak <- dao_plot %>% filter(NAME_3=="Xa Dai Hung" & NAME_2=="Khoai Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dao_sf <- dat_sf %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plot <- dao_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dao_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dao_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dao_plot$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đào")
```



```{r, lazy = TRUE}
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plotf <- dao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dao_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dao_plotf$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đào")
```

## Đậu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dau_sff <- dat_sff %>% mutate(prop.dau=(sum(subset(., Ho=="Đậu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đậu")
dau_plot <- dau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dau, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dau_plot$centroid <- sf::st_transform(dau_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dau <- dau_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ngoc Linh" & NAME_2=="Tinh Gia"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dau=as.numeric(round(prop.dau, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dau, area_km, songuoi_km, lng, lat, distm_km)

dau_peak <- dau_plot %>% filter(NAME_3=="Xa Ngoc Linh" & NAME_2=="Tinh Gia")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dau_sf <- dat_sf %>% mutate(prop.dau=(sum(subset(., Ho=="Đậu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đậu")
dau_plot <- dau_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dau_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dau_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dau_plot$prop.dau[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đậu")
```



```{r, lazy = TRUE}
dau_sff <- dat_sff %>% mutate(prop.dau=(sum(subset(., Ho=="Đậu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đậu")
dau_plotf <- dau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dau_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dau_plotf$prop.dau[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đậu")
```

## Diệp

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
diep_sff <- dat_sff %>% mutate(prop.diep=(sum(subset(., Ho=="Diệp")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Diệp")
diep_plot <- diep_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.diep, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
diep_plot$centroid <- sf::st_transform(diep_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

diep <- diep_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tan Loi" & NAME_2=="Dong Hy"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.diep=as.numeric(round(prop.diep, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.diep, area_km, songuoi_km, lng, lat, distm_km)

diep_peak <- diep_plot %>% filter(NAME_3=="Xa Tan Loi" & NAME_2=="Dong Hy")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
diep_sf <- dat_sf %>% mutate(prop.diep=(sum(subset(., Ho=="Diệp")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Diệp")
diep_plot <- diep_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.diep, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=diep_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=diep_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(diep_plot$prop.diep[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Diệp")
```



```{r, lazy = TRUE}
diep_sff <- dat_sff %>% mutate(prop.diep=(sum(subset(., Ho=="Diệp")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Diệp")
diep_plotf <- diep_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.diep, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=diep_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(diep_plotf$prop.diep[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Diệp")
```

## Điêu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dieu_sff <- dat_sff %>% mutate(prop.dieu=(sum(subset(., Ho=="Điêu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Điêu")
dieu_plot <- dieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dieu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dieu_plot$centroid <- sf::st_transform(dieu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dieu <- dieu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hung Do" & NAME_2=="Tam Nong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dieu=as.numeric(round(prop.dieu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dieu, area_km, songuoi_km, lng, lat, distm_km)

dieu_peak <- dieu_plot %>% filter(NAME_3=="Xa Hung Do" & NAME_2=="Tam Nong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dieu_sf <- dat_sf %>% mutate(prop.dieu=(sum(subset(., Ho=="Điêu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Điêu")
dieu_plot <- dieu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dieu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dieu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dieu_plot$prop.dieu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Điêu")
```



```{r, lazy = TRUE}
dieu_sff <- dat_sff %>% mutate(prop.dieu=(sum(subset(., Ho=="Điêu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Điêu")
dieu_plotf <- dieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dieu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dieu_plotf$prop.dieu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Điêu")
```

## Điểu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dieu2_sff <- dat_sff %>% mutate(prop.dieu2=(sum(subset(., Ho=="Điểu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Điểu")
dieu2_plot <- dieu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dieu2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dieu2_plot$centroid <- sf::st_transform(dieu2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dieu2 <- dieu2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Nai" & NAME_2=="Bu Dang"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dieu2=as.numeric(round(prop.dieu2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dieu2, area_km, songuoi_km, lng, lat, distm_km)

dieu2_peak <- dieu2_plot %>% filter(NAME_3=="Xa Dong Nai" & NAME_2=="Bu Dang")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dieu2_sf <- dat_sf %>% mutate(prop.dieu2=(sum(subset(., Ho=="Điểu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Điểu")
dieu2_plot <- dieu2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dieu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dieu2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dieu2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dieu2_plot$prop.dieu2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Điểu")
```



```{r, lazy = TRUE}
dieu2_sff <- dat_sff %>% mutate(prop.dieu2=(sum(subset(., Ho=="Điểu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Điểu")
dieu2_plotf <- dieu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dieu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dieu2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dieu2_plotf$prop.dieu2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Điểu")
```

## Đinh

Họ Đinh.

Theo thống kê dân số, họ Đinh chiếm 1.6% dân số cả nước. Dựa theo phân bố % (xác suất gặp người mang họ Đinh trong khu vực) chúng ta nhận thấy phân bố xác suất gặp người mang họ Đinh cách xa biên giới cũng như bờ biển. Vậy có thể khẳng định là đã không có một cuộc di dân tự nhiên người mang họ Đinh nào tới Việt Nam. Họ Đinh là cư dân bản địa. Họ đã mang họ Đinh chỉ là vì, sau khi dẹp loạn 12 xứ quân, Đinh Tiên Hoàng cho thực hiện chế độ quản lý hành chính trong toàn Đại Cồ Việt. Chế độ quản lý hành chính được thực hiện dựa trên việc dùng chữ Hán. Hệ thống họ được dùng là từ các con Hán Tự và nhiều khi là lấy từ danh sách các họ Hán có sẵn. Chính vì thế mà rất nhiều dòng họ Việt đã sinh sống cả nhiều nghìn năm ở vùng đất quê cha mẹ đẻ, tự dưng trở thành những đứa con hoang của các dòng họ Phương Bắc. 
Nhà Đinh 丁 bắt đầu năm 968, sau khi Vua Đinh Tiên Hoàng dẹp xong loạn 12 sứ quân thống nhất đất nước lên ngôi Hoàng Đế và kết thúc năm 980 khi con của Đinh Tiên Hoàng là Vua Đinh Phế Đế nhường ngôi cho Lê Hoàn. 

Người mang họ Đinh tập trung khá nhiều ở Ninh Bình, đây là nơi cho đến nay được xem là khởi thủy của tộc Họ Đinh Việt Nam. 

https://baoquangngai.vn/channel/2047/202206/nguoi-hre-ca-dong-mang-ho-dinh-tu-luc-nao-3119416/?fbclid=IwAR28UE2q0PJ_95xidTXJq-5BgUUEv7V3V4fA_o9LFbFdtpBCrPW27KUHNe8

Từ phân bố mật độ dòng họ Đinh theo % (xác suất gặp người mang họ đinh trong khu vực) chúng ta nhận thấy phần phía Tây Nguyên có các cụm dân cư chủ yếu mang họ Đinh, lên tới 75%. Tuy nhiên ở các vùng này phân bố mật độ cư dân mang họ Đinh theo 1km2 rất thấp. Như vậy cư dân mang họ Đinh ở vùng Tây Nguyên là người dân tộc thiểu số. 

Trong sách "Đường lên xứ Thượng" Bộ Công dân vụ xuất bản, năm 1963,  tác giả Bùi Đình cho biết: 

Trấn Man là tên gọi có từ thời Gia Long thứ 3 (1804). Nó gồm 2 miền, là Nghĩa Biên (vùng Trà My của Quảng Nam và tất cả vùng sơn cước của Quảng Ngãi), và Định Biên (vùng sơn cước của tỉnh Bình Định). 

Đến năm 1877 (tức năm Đồng Khánh thứ 2), thì Trấn Man được chia làm 5 châu: Trà My, Hà Tịnh, Nghĩa Hành, Đức Phổ và Bồng Sơn. Mỗi châu có Tri châu điều khiển. Dưới quyền Tri châu có các Chánh tổng và Phó tổng người Kinh và Tổng nguồn có người Thượng. Các cấp Đầu mục và Sách trưởng vẫn được duy trì. Lúc này, trai tráng được kiểm tra chặt chẽ và tên tuổi được ghi vào danh bộ. Người Thượng vốn không có họ, chỉ có tên, vì vậy khi lập danh bộ (để quản lý và đánh thuế), trai tráng từ 18 tuổi trở lên, các Chánh tổng đã ghi vào tên riêng của mỗi người một chữ Đinh (丁= tức tráng đinh) như Đinh A, Đinh B... Và từ đó về sau, chữ Đinh này biến thành tên họ chung cho đồng bào Thượng vùng Nam - Ngãi, cả nam lẫn nữ.

Năm 1969, người Hrê ở huyện Ba Tơ đổi họ Đinh lấy họ Phạm (theo họ Thủ tướng Phạm Văn Đồng). Còn người Hrê ở hai huyện Sơn Hà, Minh Long vẫn giữ chữ Đinh trước tên riêng mà cha mẹ đã đặt cho ngay từ thuở nhỏ. Đối với người Ca Dong ở huyện Sơn Tây, đến năm 1976, cùng với việc sáp nhập huyện Sơn Tây vào huyện Sơn Hà, thì hầu hết người Ca Dong mới có họ Đinh.

Lịch sử.

Năm 905 Tĩnh Hải quân Tiết độ sứ Độc Cô Tổn bị triệu về nhà Đường (đời vua Đường Ai Đế) để trị tội, đất Tĩnh Hải quân vô chủ. Khúc Thừa Dụ thừa dịp dẫn quân đánh chiếm thủ phủ Đại La. Nhà Đường suy nhược, thuận cho Khúc Thừa Dụ làm Tĩnh Hải Tiết độ sứ.

Năm 907 nhà Đường mất ngôi, nhà Hậu Lương, Hậu Đường, Hậu Tấn, Hậu Hán, Hậu Chu tranh nhau làm vua. Mỗi nhà được mấy năm. Khúc Thừa Dụ làm Tiết độ sứ được non một năm thì mất, giao quyền lại cho con là Khúc Hạo. Cuối năm 917, Khúc Hạo mất Khúc Thừa Mỹ thay cha làm Tiết độ sứ Tĩnh Hải quân. 

Vào năm 930, Nam Hán Cao Tổ sai Lương Khắc Trinh quân sang đánh chiếm Tĩnh Hải quân, bắt được Tiết độ sứ là Khúc Thừa Mỹ. Lý Khắc Chính bị tướng của Khúc Hạo là Dương Đình Nghệ người Ái Châu đánh đuổi. Dương Đình Nghệ làm Tiết Độ Sứ được 6 năm thì bị tướng của mình là Kiều Công Tiễn làm phản, giết chết rồi lên thay.
Sử chép rằng Dương Đình Nghệ nhận tất cả 3000 tráng sĩ đến đầu quân làm "con nuôi", trong đó có Kiều Công Tiễn và Ngô Quyền. 

Ngô Quyền - con rể Dương Đình Nghệ chiêu binh đánh Kiều Công Tiễn. Dương Tam Kha, Đinh Công Trứ, Kiều Công Hãn, Đỗ Cảnh Thạc... về theo. Tháng 4 năm 938, Ngô Quyền tiến quân ra Bắc, hạ thành Đại La. Tháng 10/938, Kiều Công Tiễn cầu cứu quân Nam Hán. Nam Hán Cao Tổ phái con trai là Lưu Hoằng Tháo đem binh sang Tĩnh Hải quân. Nhưng khi quân Nam Hán chưa sang, mùa thu năm 938, Ngô Quyền đã giết được Kiều Công Tiễn.

Ngô Quyền bảo các tướng tá rằng:

Hoằng Tháo là đứa trẻ khờ dại, đem quân từ xa đến. Công Tiễn đã chết, không có người làm nội ứng. Rồi sai người đem cọc lớn vạt nhọn đầu bịt sắt đóng ngầm ở trước cửa biển, thuyền của bọn chúng theo nước triều lên vào trong hàng cọc thì sau đó ta dễ bề chế ngự, không cho chiếc nào ra thoát.

Khu vực Quảng Yên ở cửa sông Bạch Đằng xưa là bãi đá ngầm. Ngô Quyền cho quân quấy nhiễu khiến thuyền bè của Hoằng Tháo không thể neo đậu. Khi thủy triều rút thuyền bè của quân Hoằng Tháo bị nước biển cuốn đâm cả vào bãi đá ngầm Quảng Yên mà tự vỡ. Ngô Quyền thừa thắng đuổi đánh, bắt được Hoằng Tháo giết chết. Vua Nam Hán Cao Tổ (Lưu Cung) đồn trú ở cửa biển thu nhặt quân lính còn sót rút về. 

Sau chiến thắng quân Nam Hán ở Bạch Đằng, Ngô Quyền lên ngôi vua trị vì từ năm 939 đến năm 944. Năm 944, Ngô Quyền mất, con trưởng là Ngô Xương Ngập lên thay. Dương Tam Kha (em vợ của Ngô Quyền và là con trai của Tiết độ sứ Dương Đình Nghệ) cướp ngôi Ngô Xương Ngập, tự lập mình làm vua, xưng Dương Bình Vương, trị vì từ năm 944 đến 950. 

Năm 950, Dương Tam Kha sai Ngô Xương Văn đi đánh loạn hai thôn Đường, Nguyễn. Ngô Xương Văn dẫn quân quay lại lật đổ Dương Tam Kha. Xương Văn không giết Tam Kha, chỉ giáng xuống làm Chương Dương công. Năm 953, Dương Tam Kha cùng gia quyến và thuộc hạ khai khẩn vùng đất mới, Giao Thủy (Nam Định). Dương Tam Kha là cha của hoàng hậu Dương Vân Nga. Ông còn sống tới lúc gả Dương Vân Nga cho Đinh Bộ Lĩnh năm 966.

Sự kiện Dương Tam Kha cướp ngôi chính là nguyên nhân gây nên loạn 12 sứ quân. Đinh Bộ Lĩnh có công đánh dẹp loạn 12 sứ quân, thống nhất giang sơn và trở thành hoàng đế đầu tiên của Việt Nam sau thời Bắc thuộc.

Đinh Công Trứ, nguyên là một nha tướng của Dương Đình Nghệ. Khi Dương Đình Nghệ tiếp nối làm Thống lĩnh Giao Châu của họ Khúc, đã cử ông Đinh Công Trứ làm Thứ sử Châu Hoan (Nghệ An, Hà Tĩnh ngày nay). Đinh Công Trứ sinh ra Đinh Bộ Lĩnh, nhưng ông mất sớm, Đinh Bộ Lĩnh lúc này còn nhỏ (năm 12 tuổi), theo mẹ về quê Hoa Lư sinh sống.

Đại Việt sử ký toàn thư, ngoại kỷ, Quyển V chép là Dương Đình Nghệ kèm ghi chú: "Cương mục ghi Dương Diên Nghệ, người Ái Châu, tức Thanh Hóa.

Dựa vào phân bố mật độ dòng họ Dương trên khắp cả nước chúng ta thấy vùng có mật độ cao và có phân bố chuẩn là ở Thanh Hóa. Dựa vào các chú dẫn về Ái Châu trong các tư liệu cổ sử của chúng ta có thể thấy rõ vùng quê của Dương Đình Nghệ là xã Thiệu Dương thuộc Thanh Hóa.

Xa Thiệu Dương 48.66%
Xa Tho The 11.88%
Xa Thieu Toan 11.39%
Xa Cam Ngoc 10.37%
Xa Luong Trung 8.28%
Xa Thieu Khanh 7.69%
Xa Nga Hung 7.38%
Xa Thieu Long 6.64%
Phuong Ham Rong 6.25%

Dựa vào xác suất gặp họ Đinh, 
Hoa Binh Tan Lac Xa Phu Vinh 79.91%
Ninh Binh Nho Quan Xa Cuc Phuong 63.66%
Thanh Hoa Thach Thanh Xa Thanh Yen 57.56%
Hoa Binh Da Bac Xa Tien Phong 51.17%
Hoa Binh Mai Chau Xa Ba Khan 44.12%
Hoa Binh Mai Chau Xa Tan Dan 38.77%
Hoa Binh Da Bac Xa Hao Ly 38.16%
Ninh Binh Nho Quan Xa Ky Phu 35.87%
Hoa Binh Tan Lac Xa Phu Cuong 34.18%
Hoa Binh Tan Lac Xa Lung Van 33.45%
Hoa Binh Yen Thuy Xa Huu Loi 31.8%
Ninh Binh Nho Quan Xa Thuong Hoa 30.55%
Ninh Binh Nho Quan Xa Van Phuong 30.55%
Hoa Binh Ky Son Xa Phuc Tien 30.45%
Hoa Binh Cao Phong Xa Binh Thanh 30.01%
Ninh Binh Nho Quan Xa Gia Tuong 27.74%
Hoa Binh Tan Lac Xa Quyet Chien 27.64%
Ninh Binh Gia Vien Xa Gia Lap 27.37%
Ninh Binh Hoa Lu Xa Ninh Khang 27.3%
Ninh Binh Gia Vien Xa Gia Minh 27.15%
Hoa Binh Mai Chau Xa Tan Mai 26.87%

Chúng ta nhận thấy nguồn gốc của Họ Đinh là ở ven hồ thủy điện Hòa Bình. Nơi phát tích là xã Phú Ninh, huyện Tân Lạc, Hòa Bình. Sau đó họ Đinh đã phát triển dần về phía biển tới Xã Cúc Phương huyện Nho Quan thuộc Ninh Bình dọc theo con sông Bôi, và xã Thành Yên huyện Thạch Thành tỉnh Thanh Hóa dọc theo con sông Bưởi.  

Như vậy họ Đinh chẳng những là người bản xứ mà còn là những cư dân rất cổ ở khu vực.


```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plot <- dinh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dinh, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dinh_plot$centroid <- sf::st_transform(dinh_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dinh <- dinh_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Long Mon" & NAME_2=="Minh Long"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dinh=as.numeric(round(prop.dinh, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dinh, area_km, songuoi_km, lng, lat, distm_km)

dinh_peak <- dinh_plot %>% filter(NAME_3=="Xa Long Mon" & NAME_2=="Minh Long")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plot <- dinh_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dinh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dinh_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dinh_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dinh_plot$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đinh")
```



```{r, lazy = TRUE}
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plotf <- dinh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dinh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dinh_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dinh_plotf$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đinh")
```

## Đô

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
do1_sff <- dat_sff %>% mutate(prop.do1=(sum(subset(., Ho=="Đô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đô")
do1_plot <- do1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.do1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
do1_plot$centroid <- sf::st_transform(do1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

do1 <- do1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phuong Hung" & NAME_2=="Gia Loc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.do1=as.numeric(round(prop.do1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.do1, area_km, songuoi_km, lng, lat, distm_km)

do1_peak <- do1_plot %>% filter(NAME_3=="Xa Phuong Hung" & NAME_2=="Gia Loc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
do1_sf <- dat_sf %>% mutate(prop.do1=(sum(subset(., Ho=="Đô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đô")
do1_plot <- do1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.do1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=do1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=do1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(do1_plot$prop.do1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đô")
```



```{r, lazy = TRUE}
do1_sff <- dat_sff %>% mutate(prop.do1=(sum(subset(., Ho=="Đô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đô")
do1_plotf <- do1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.do1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=do1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(do1_plotf$prop.do1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đô")
```

## Đỗ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plot <- do_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.do, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
do_plot$centroid <- sf::st_transform(do_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

do <- do_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Xuan Truong" & NAME_2=="Tho Xuan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.do=as.numeric(round(prop.do, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.do, area_km, songuoi_km, lng, lat, distm_km)

do_peak <- do_plot %>% filter(NAME_3=="Xa Xuan Truong" & NAME_2=="Tho Xuan")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plot <- do_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.do, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=do_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=do_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(do_plot$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đỗ")
```



```{r, lazy = TRUE}
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plotf <- do_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.do, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=do_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(do_plotf$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đỗ")
```

## Doãn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
doan1_sff <- dat_sff %>% mutate(prop.doan1=(sum(subset(., Ho=="Doãn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Doãn")
doan1_plot <- doan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.doan1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
doan1_plot$centroid <- sf::st_transform(doan1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

doan1 <- doan1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Thinh" & NAME_2=="Dong Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.doan1=as.numeric(round(prop.doan1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.doan1, area_km, songuoi_km, lng, lat, distm_km)

doan1_peak <- doan1_plot %>% filter(NAME_3=="Xa Dong Thinh" & NAME_2=="Dong Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
doan1_sf <- dat_sf %>% mutate(prop.doan1=(sum(subset(., Ho=="Doãn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Doãn")
doan1_plot <- doan1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.doan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=doan1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=doan1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(doan1_plot$prop.doan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Doãn")
```



```{r, lazy = TRUE}
doan1_sff <- dat_sff %>% mutate(prop.doan1=(sum(subset(., Ho=="Doãn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Doãn")
doan1_plotf <- doan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.doan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=doan1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(doan1_plotf$prop.doan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Doãn")
```

## Đoàn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plot <- doan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.doan, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
doan_plot$centroid <- sf::st_transform(doan_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

doan <- doan_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Dinh" & NAME_2=="Quang Xuong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.doan=as.numeric(round(prop.doan, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.doan, area_km, songuoi_km, lng, lat, distm_km)

doan_peak <- doan_plot %>% filter(NAME_3=="Xa Quang Dinh" & NAME_2=="Quang Xuong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plot <- doan_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.doan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=doan_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=doan_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đoàn")
```



```{r, lazy = TRUE}
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plotf <- doan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.doan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=doan_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(doan_plotf$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đoàn")
```

## Đới

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
doi_sff <- dat_sff %>% mutate(prop.doi=(sum(subset(., Ho=="Đới")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đới")
doi_plot <- doi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.doi, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
doi_plot$centroid <- sf::st_transform(doi_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

doi <- doi_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Hai" & NAME_2=="Quang Xuong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.doi=as.numeric(round(prop.doi, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.doi, area_km, songuoi_km, lng, lat, distm_km)

doi_peak <- doi_plot %>% filter(NAME_3=="Xa Quang Hai" & NAME_2=="Quang Xuong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
doi_sf <- dat_sf %>% mutate(prop.doi=(sum(subset(., Ho=="Đới")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đới")
doi_plot <- doi_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.doi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=doi_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=doi_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(doi_plot$prop.doi[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đới")
```



```{r, lazy = TRUE}
doi_sff <- dat_sff %>% mutate(prop.doi=(sum(subset(., Ho=="Đới")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đới")
doi_plotf <- doi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.doi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=doi_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(doi_plotf$prop.doi[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đới")
```

## Đồng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dong_sff <- dat_sff %>% mutate(prop.dong=(sum(subset(., Ho=="Đồng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đồng")
dong_plot <- dong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
dong_plot$centroid <- sf::st_transform(dong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dong <- dong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Nghia Hoa" & NAME_2=="Lang Giang"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.dong=as.numeric(round(prop.dong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.dong, area_km, songuoi_km, lng, lat, distm_km)

dong_peak <- dong_plot %>% filter(NAME_3=="Xa Nghia Hoa" & NAME_2=="Lang Giang")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
dong_sf <- dat_sf %>% mutate(prop.dong=(sum(subset(., Ho=="Đồng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đồng")
dong_plot <- dong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.dong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=dong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dong_plot$prop.dong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đồng")
```



```{r, lazy = TRUE}
dong_sff <- dat_sff %>% mutate(prop.dong=(sum(subset(., Ho=="Đồng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đồng")
dong_plotf <- dong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.dong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=dong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(dong_plotf$prop.dong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đồng")
```

## Dư

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
du_sff <- dat_sff %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plot <- du_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.du, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
du_plot$centroid <- sf::st_transform(du_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

du <- du_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Nghia Loi" & NAME_2=="Nghia Dan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.du=as.numeric(round(prop.du, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.du, area_km, songuoi_km, lng, lat, distm_km)

du_peak <- du_plot %>% filter(NAME_3=="Xa Nghia Loi" & NAME_2=="Nghia Dan")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
du_sf <- dat_sf %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plot <- du_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.du, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=du_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=du_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Dư")
```



```{r, lazy = TRUE}
du_sff <- dat_sff %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plotf <- du_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.du, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=du_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(du_plotf$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Dư")
```

## Dương

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
duong_plot$centroid <- sf::st_transform(duong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

duong <- duong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.duong=as.numeric(round(prop.duong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong, area_km, songuoi_km, lng, lat, distm_km)

duong_peak <- duong_plot %>% filter(NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=duong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(duong_plot$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Dương")
```



```{r, lazy = TRUE}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plotf <- duong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.duong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(duong_plotf$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Dương")
```

## Đường

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
duong2_sff <- dat_sff %>% mutate(prop.duong2=(sum(subset(., Ho=="Đường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đường")
duong2_plot <- duong2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
duong2_plot$centroid <- sf::st_transform(duong2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

duong2 <- duong2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Van" & NAME_2=="Binh Lieu"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.duong2=as.numeric(round(prop.duong2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong2, area_km, songuoi_km, lng, lat, distm_km)

duong2_peak <- duong2_plot %>% filter(NAME_3=="Xa Dong Van" & NAME_2=="Binh Lieu")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
duong2_sf <- dat_sf %>% mutate(prop.duong2=(sum(subset(., Ho=="Đường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đường")
duong2_plot <- duong2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.duong2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=duong2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(duong2_plot$prop.duong2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đường")
```



```{r, lazy = TRUE}
duong2_sff <- dat_sff %>% mutate(prop.duong2=(sum(subset(., Ho=="Đường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đường")
duong2_plotf <- duong2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.duong2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(duong2_plotf$prop.duong2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Đường")
```

## Giang

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
giang_sff <- dat_sff %>% mutate(prop.giang=(sum(subset(., Ho=="Giang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giang")
giang_plot <- giang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.giang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
giang_plot$centroid <- sf::st_transform(giang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

giang <- giang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa My Loc" & NAME_2=="Thai Thuy"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.giang=as.numeric(round(prop.giang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.giang, area_km, songuoi_km, lng, lat, distm_km)

giang_peak <- giang_plot %>% filter(NAME_3=="Xa My Loc" & NAME_2=="Thai Thuy")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
giang_sf <- dat_sf %>% mutate(prop.giang=(sum(subset(., Ho=="Giang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giang")
giang_plot <- giang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.giang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=giang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=giang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(giang_plot$prop.giang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Giang")
```



```{r, lazy = TRUE}
giang_sff <- dat_sff %>% mutate(prop.giang=(sum(subset(., Ho=="Giang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giang")
giang_plotf <- giang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.giang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=giang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(giang_plotf$prop.giang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Giang")
```

## Giàng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
giang2_sff <- dat_sff %>% mutate(prop.giang2=(sum(subset(., Ho=="Giàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giàng")
giang2_plot <- giang2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.giang2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
giang2_plot$centroid <- sf::st_transform(giang2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

giang2 <- giang2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thuong Tan" & NAME_2=="Bac Me"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.giang2=as.numeric(round(prop.giang2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.giang2, area_km, songuoi_km, lng, lat, distm_km)

giang2_peak <- giang2_plot %>% filter(NAME_3=="Xa Thuong Tan" & NAME_2=="Bac Me")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
giang2_sf <- dat_sf %>% mutate(prop.giang2=(sum(subset(., Ho=="Giàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giàng")
giang2_plot <- giang2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.giang2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=giang2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=giang2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(giang2_plot$prop.giang2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Giàng")
```



```{r, lazy = TRUE}
giang2_sff <- dat_sff %>% mutate(prop.giang2=(sum(subset(., Ho=="Giàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giàng")
giang2_plotf <- giang2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.giang2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=giang2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(giang2_plotf$prop.giang2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Giàng")
```

## Giáp

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
giap_sff <- dat_sff %>% mutate(prop.giap=(sum(subset(., Ho=="Giáp")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giáp")
giap_plot <- giap_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.giap, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
giap_plot$centroid <- sf::st_transform(giap_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

giap <- giap_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Lam" & NAME_2=="Lang Giang"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.giap=as.numeric(round(prop.giap, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.giap, area_km, songuoi_km, lng, lat, distm_km)

giap_peak <- giap_plot %>% filter(NAME_3=="Xa Dai Lam" & NAME_2=="Lang Giang")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
giap_sf <- dat_sf %>% mutate(prop.giap=(sum(subset(., Ho=="Giáp")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giáp")
giap_plot <- giap_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.giap, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=giap_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=giap_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(giap_plot$prop.giap[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Giáp")
```



```{r, lazy = TRUE}
giap_sff <- dat_sff %>% mutate(prop.giap=(sum(subset(., Ho=="Giáp")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giáp")
giap_plotf <- giap_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.giap, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=giap_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(giap_plotf$prop.giap[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Giáp")
```

## H

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
h_sff <- dat_sff %>% mutate(prop.h=(sum(subset(., Ho=="H")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H")
h_plot <- h_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.h, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
h_plot$centroid <- sf::st_transform(h_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

h <- h_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ea Tul" & NAME_2=="Cu M'gar"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.h=as.numeric(round(prop.h, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.h, area_km, songuoi_km, lng, lat, distm_km)

h_peak <- h_plot %>% filter(NAME_3=="Xa Ea Tul" & NAME_2=="Cu M'gar")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
h_sf <- dat_sf %>% mutate(prop.h=(sum(subset(., Ho=="H")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H")
h_plot <- h_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.h, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=h_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=h_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(h_plot$prop.h[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("H")
```



```{r, lazy = TRUE}
h_sff <- dat_sff %>% mutate(prop.h=(sum(subset(., Ho=="H")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H")
h_plotf <- h_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.h, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=h_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(h_plotf$prop.h[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("H")
```

## H'

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
h1_sff <- dat_sff %>% mutate(prop.h1=(sum(subset(., Ho=="H'")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H'")
h1_plot <- h1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.h1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
h1_plot$centroid <- sf::st_transform(h1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

h1 <- h1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chu A" & NAME_2=="Pleiku"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.h1=as.numeric(round(prop.h1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.h1, area_km, songuoi_km, lng, lat, distm_km)

h1_peak <- h1_plot %>% filter(NAME_3=="Xa Chu A" & NAME_2=="Pleiku")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
h1_sf <- dat_sf %>% mutate(prop.h1=(sum(subset(., Ho=="H'")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H'")
h1_plot <- h1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.h1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=h1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=h1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(h1_plot$prop.h1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("H'")
```



```{r, lazy = TRUE}
h1_sff <- dat_sff %>% mutate(prop.h1=(sum(subset(., Ho=="H'")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H'")
h1_plotf <- h1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.h1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=h1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(h1_plotf$prop.h1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("H'")
```

## Ha

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ha1_sff <- dat_sff %>% mutate(prop.ha1=(sum(subset(., Ho=="Ha")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ha")
ha1_plot <- ha1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ha1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ha1_plot$centroid <- sf::st_transform(ha1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ha1 <- ha1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ky Tan" & NAME_2=="Ba Thuoc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ha1=as.numeric(round(prop.ha1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ha1, area_km, songuoi_km, lng, lat, distm_km)

ha1_peak <- ha1_plot %>% filter(NAME_3=="Xa Ky Tan" & NAME_2=="Ba Thuoc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ha1_sf <- dat_sf %>% mutate(prop.ha1=(sum(subset(., Ho=="Ha")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ha")
ha1_plot <- ha1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ha1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ha1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ha1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ha1_plot$prop.ha1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ha")
```



```{r, lazy = TRUE}
ha1_sff <- dat_sff %>% mutate(prop.ha1=(sum(subset(., Ho=="Ha")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ha")
ha1_plotf <- ha1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ha1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ha1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ha1_plotf$prop.ha1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ha")
```

## Hà

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ha_sff <- dat_sff %>% mutate(prop.ha=(sum(subset(., Ho=="Hà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hà")
ha_plot <- ha_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ha, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ha_plot$centroid <- sf::st_transform(ha_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ha <- ha_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tan Son" & NAME_2=="Tan Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ha=as.numeric(round(prop.ha, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ha, area_km, songuoi_km, lng, lat, distm_km)

ha_peak <- ha_plot %>% filter(NAME_3=="Xa Tan Son" & NAME_2=="Tan Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ha_sf <- dat_sf %>% mutate(prop.ha=(sum(subset(., Ho=="Hà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hà")
ha_plot <- ha_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ha, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ha_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ha_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ha_plot$prop.ha[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hà")
```



```{r, lazy = TRUE}
ha_sff <- dat_sff %>% mutate(prop.ha=(sum(subset(., Ho=="Hà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hà")
ha_plotf <- ha_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ha, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ha_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ha_plotf$prop.ha[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hà")
```

## Hạ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ha2_sff <- dat_sff %>% mutate(prop.ha2=(sum(subset(., Ho=="Hạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hạ")
ha2_plot <- ha2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ha2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ha2_plot$centroid <- sf::st_transform(ha2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ha2 <- ha2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tay Son" & NAME_2=="Ky Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ha2=as.numeric(round(prop.ha2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ha2, area_km, songuoi_km, lng, lat, distm_km)

ha2_peak <- ha2_plot %>% filter(NAME_3=="Xa Tay Son" & NAME_2=="Ky Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ha2_sf <- dat_sf %>% mutate(prop.ha2=(sum(subset(., Ho=="Hạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hạ")
ha2_plot <- ha2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ha2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ha2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ha2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ha2_plot$prop.ha2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hạ")
```



```{r, lazy = TRUE}
ha2_sff <- dat_sff %>% mutate(prop.ha2=(sum(subset(., Ho=="Hạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hạ")
ha2_plotf <- ha2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ha2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ha2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ha2_plotf$prop.ha2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hạ")
```

## Hán

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
han1_sff <- dat_sff %>% mutate(prop.han1=(sum(subset(., Ho=="Hán")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hán")
han1_plot <- han1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.han1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
han1_plot$centroid <- sf::st_transform(han1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

han1 <- han1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Gia Thanh" & NAME_2=="Phu Ninh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.han1=as.numeric(round(prop.han1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.han1, area_km, songuoi_km, lng, lat, distm_km)

han1_peak <- han1_plot %>% filter(NAME_3=="Xa Gia Thanh" & NAME_2=="Phu Ninh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
han1_sf <- dat_sf %>% mutate(prop.han1=(sum(subset(., Ho=="Hán")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hán")
han1_plot <- han1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.han1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=han1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=han1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(han1_plot$prop.han1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hán")
```



```{r, lazy = TRUE}
han1_sff <- dat_sff %>% mutate(prop.han1=(sum(subset(., Ho=="Hán")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hán")
han1_plotf <- han1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.han1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=han1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(han1_plotf$prop.han1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hán")
```

## Hàn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
han2_sff <- dat_sff %>% mutate(prop.han2=(sum(subset(., Ho=="Hàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hàn")
han2_plot <- han2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.han2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
han2_plot$centroid <- sf::st_transform(han2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

han2 <- han2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thieu Quang" & NAME_2=="Thieu Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.han2=as.numeric(round(prop.han2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.han2, area_km, songuoi_km, lng, lat, distm_km)

han2_peak <- han2_plot %>% filter(NAME_3=="Xa Thieu Quang" & NAME_2=="Thieu Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
han2_sf <- dat_sf %>% mutate(prop.han2=(sum(subset(., Ho=="Hàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hàn")
han2_plot <- han2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.han2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=han2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=han2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(han2_plot$prop.han2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hàn")
```



```{r, lazy = TRUE}
han2_sff <- dat_sff %>% mutate(prop.han2=(sum(subset(., Ho=="Hàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hàn")
han2_plotf <- han2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.han2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=han2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(han2_plotf$prop.han2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hàn")
```

## Hàng



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hang1_sff <- dat_sff %>% mutate(prop.hang1=(sum(subset(., Ho=="Hàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hàng")
hang1_plot <- hang1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hang1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hang1_plot$centroid <- sf::st_transform(hang1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hang1 <- hang1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Lung Phinh" & NAME_2=="Bac Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hang1=as.numeric(round(prop.hang1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hang1, area_km, songuoi_km, lng, lat, distm_km)

hang1_peak <- hang1_plot %>% filter(NAME_3=="Xa Lung Phinh" & NAME_2=="Bac Ha")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hang1_sf <- dat_sf %>% mutate(prop.hang1=(sum(subset(., Ho=="Hàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hàng")
hang1_plot <- hang1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hang1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hang1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hang1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hang1_plot$prop.hang1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hàng")
```



```{r, lazy = TRUE}
hang1_sff <- dat_sff %>% mutate(prop.hang1=(sum(subset(., Ho=="Hàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hàng")
hang1_plotf <- hang1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hang1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hang1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hang1_plotf$prop.hang1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hàng")
```

## Hảng



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hang2_sff <- dat_sff %>% mutate(prop.hang2=(sum(subset(., Ho=="Hảng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hảng")
hang2_plot <- hang2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hang2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hang2_plot$centroid <- sf::st_transform(hang2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hang2 <- hang2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ta Leng" & NAME_2=="Tam Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hang2=as.numeric(round(prop.hang2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hang2, area_km, songuoi_km, lng, lat, distm_km)

hang2_peak <- hang2_plot %>% filter(NAME_3=="Xa Ta Leng" & NAME_2=="Tam Duong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hang2_sf <- dat_sf %>% mutate(prop.hang2=(sum(subset(., Ho=="Hảng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hảng")
hang2_plot <- hang2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hang2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hang2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hang2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hang2_plot$prop.hang2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hảng")
```



```{r, lazy = TRUE}
hang2_sff <- dat_sff %>% mutate(prop.hang2=(sum(subset(., Ho=="Hảng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hảng")
hang2_plotf <- hang2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hang2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hang2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hang2_plotf$prop.hang2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hảng")
```

## Hạng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hang3_sff <- dat_sff %>% mutate(prop.hang3=(sum(subset(., Ho=="Hạng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hạng")
hang3_plot <- hang3_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hang3, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hang3_plot$centroid <- sf::st_transform(hang3_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hang3 <- hang3_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Lang Cheu" & NAME_2=="Bac Yen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hang3=as.numeric(round(prop.hang3, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hang3, area_km, songuoi_km, lng, lat, distm_km)

hang3_peak <- hang3_plot %>% filter(NAME_3=="Xa Lang Cheu" & NAME_2=="Bac Yen")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hang3_sf <- dat_sf %>% mutate(prop.hang3=(sum(subset(., Ho=="Hạng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hạng")
hang3_plot <- hang3_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hang3, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hang3_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hang3_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hang3_plot$prop.hang3[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hạng")
```



```{r, lazy = TRUE}
hang3_sff <- dat_sff %>% mutate(prop.hang3=(sum(subset(., Ho=="Hạng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hạng")
hang3_plotf <- hang3_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hang3, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hang3_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hang3_plotf$prop.hang3[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hạng")
```

## Hầu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hau_sff <- dat_sff %>% mutate(prop.hau=(sum(subset(., Ho=="Hầu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hầu")
hau_plot <- hau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hau, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hau_plot$centroid <- sf::st_transform(hau_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hau <- hau_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Bat Dai Son" & NAME_2=="Quan Ba"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hau=as.numeric(round(prop.hau, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hau, area_km, songuoi_km, lng, lat, distm_km)

hau_peak <- hau_plot %>% filter(NAME_3=="Xa Bat Dai Son" & NAME_2=="Quan Ba")
```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hau_sf <- dat_sf %>% mutate(prop.hau=(sum(subset(., Ho=="Hầu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hầu")
hau_plot <- hau_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hau_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hau_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hau_plot$prop.hau[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hầu")
```



```{r, lazy = TRUE}
hau_sff <- dat_sff %>% mutate(prop.hau=(sum(subset(., Ho=="Hầu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hầu")
hau_plotf <- hau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hau_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hau_plotf$prop.hau[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hầu")
```

## Ho

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ho1_sff <- dat_sff %>% mutate(prop.ho1=(sum(subset(., Ho=="Ho")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ho")
ho1_plot <- ho1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ho1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ho1_plot$centroid <- sf::st_transform(ho1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ho1 <- ho1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phi Nhu" & NAME_2=="Dien Bien Dong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ho1=as.numeric(round(prop.ho1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ho1, area_km, songuoi_km, lng, lat, distm_km)

ho1_peak <- ho1_plot %>% filter(NAME_3=="Xa Phi Nhu" & NAME_2=="Dien Bien Dong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ho1_sf <- dat_sf %>% mutate(prop.ho1=(sum(subset(., Ho=="Ho")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ho")
ho1_plot <- ho1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ho1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ho1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ho1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ho1_plot$prop.ho1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ho")
```



```{r, lazy = TRUE}
ho1_sff <- dat_sff %>% mutate(prop.ho1=(sum(subset(., Ho=="Ho")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ho")
ho1_plotf <- ho1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ho1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ho1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ho1_plotf$prop.ho1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ho")
```

## Hồ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ho2_sff <- dat_sff %>% mutate(prop.ho2=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho2_plot <- ho2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ho2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ho2_plot$centroid <- sf::st_transform(ho2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ho2 <- ho2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thanh" & NAME_2=="Huong Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ho2=as.numeric(round(prop.ho2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ho2, area_km, songuoi_km, lng, lat, distm_km)

ho2_peak <- ho2_plot %>% filter(NAME_3=="Xa Thanh" & NAME_2=="Huong Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ho2_sf <- dat_sf %>% mutate(prop.ho2=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho2_plot <- ho2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ho2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ho2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ho2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ho2_plot$prop.ho2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hồ")
```



```{r, lazy = TRUE}
ho2_sff <- dat_sff %>% mutate(prop.ho2=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho2_plotf <- ho2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ho2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ho2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ho2_plotf$prop.ho2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hồ")
```

## Hờ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ho3_sff <- dat_sff %>% mutate(prop.ho3=(sum(subset(., Ho=="Hờ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hờ")
ho3_plot <- ho3_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ho3, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ho3_plot$centroid <- sf::st_transform(ho3_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ho3 <- ho3_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Che Cu Nha" & NAME_2=="Mu Cang Chai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ho3=as.numeric(round(prop.ho3, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ho3, area_km, songuoi_km, lng, lat, distm_km)

ho3_peak <- ho3_plot %>% filter(NAME_3=="Xa Che Cu Nha" & NAME_2=="Mu Cang Chai")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ho3_sf <- dat_sf %>% mutate(prop.ho3=(sum(subset(., Ho=="Hờ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hờ")
ho3_plot <- ho3_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ho3, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ho3_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ho3_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ho3_plot$prop.ho3[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hờ")
```



```{r, lazy = TRUE}
ho3_sff <- dat_sff %>% mutate(prop.ho3=(sum(subset(., Ho=="Hờ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hờ")
ho3_plotf <- ho3_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ho3, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ho3_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ho3_plotf$prop.ho3[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hờ")
```

## Hoàng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hoang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hoang_plot$centroid <- sf::st_transform(hoang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hoang <- hoang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hoang=as.numeric(round(prop.hoang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hoang, area_km, songuoi_km, lng, lat, distm_km)

hoang_peak <- hoang_plot %>% filter(NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hoang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hoang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hoang_plot$prop.hoang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hoàng")
```



```{r, lazy = TRUE}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plotf <- hoang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hoang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hoang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hoang_plotf$prop.hoang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hoàng")
```

## Hứa

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hua_sff <- dat_sff %>% mutate(prop.hua=(sum(subset(., Ho=="Hứa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hứa")
hua_plot <- hua_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hua, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hua_plot$centroid <- sf::st_transform(hua_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hua <- hua_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Lai" & NAME_2=="Van Quan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hua=as.numeric(round(prop.hua, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hua, area_km, songuoi_km, lng, lat, distm_km)

hua_peak <- hua_plot %>% filter(NAME_3=="Xa Vinh Lai" & NAME_2=="Van Quan")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hua_sf <- dat_sf %>% mutate(prop.hua=(sum(subset(., Ho=="Hứa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hứa")
hua_plot <- hua_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hua, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hua_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hua_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hua_plot$prop.hua[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hứa")
```



```{r, lazy = TRUE}
hua_sff <- dat_sff %>% mutate(prop.hua=(sum(subset(., Ho=="Hứa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hứa")
hua_plotf <- hua_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hua, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hua_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hua_plotf$prop.hua[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hứa")
```

## Hùng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hung_sff <- dat_sff %>% mutate(prop.hung=(sum(subset(., Ho=="Hùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hùng")
hung_plot <- hung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hung, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hung_plot$centroid <- sf::st_transform(hung_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hung <- hung_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tan Bac" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hung=as.numeric(round(prop.hung, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hung, area_km, songuoi_km, lng, lat, distm_km)

hung_peak <- hung_plot %>% filter(NAME_3=="Xa Tan Bac" & NAME_2=="Quang Binh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
hung_sf <- dat_sf %>% mutate(prop.hung=(sum(subset(., Ho=="Hùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hùng")
hung_plot <- hung_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hung_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hung_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hung_plot$prop.hung[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hùng")
```



```{r, lazy = TRUE}
hung_sff <- dat_sff %>% mutate(prop.hung=(sum(subset(., Ho=="Hùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hùng")
hung_plotf <- hung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hung_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(hung_plotf$prop.hung[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Hùng")
```

## Huỳnh

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plot <- huynh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.huynh, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
huynh_plot$centroid <- sf::st_transform(huynh_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

huynh <- huynh_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Pho Minh" & NAME_2=="Duc Pho"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.huynh=as.numeric(round(prop.huynh, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.huynh, area_km, songuoi_km, lng, lat, distm_km)

huynh_peak <- huynh_plot %>% filter(NAME_3=="Xa Pho Minh" & NAME_2=="Duc Pho")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plot <- huynh_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.huynh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=huynh_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=huynh_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(huynh_plot$prop.huynh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Huỳnh")
```



```{r, lazy = TRUE}
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plotf <- huynh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.huynh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=huynh_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(huynh_plotf$prop.huynh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Huỳnh")
```

## K 

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
k_sff <- dat_sff %>% mutate(prop.k=(sum(subset(., Ho=="K")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="K")
k_plot <- k_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.k, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
k_plot$centroid <- sf::st_transform(k_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

k <- k_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Giang" & NAME_2=="Ham Thuan Bac"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.k=as.numeric(round(prop.k, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.k, area_km, songuoi_km, lng, lat, distm_km)

k_peak <- k_plot %>% filter(NAME_3=="Xa Dong Giang" & NAME_2=="Ham Thuan Bac")

```



```{r, message=FALSE, warning=FALSE}
k_sf <- dat_sf %>% mutate(prop.k=(sum(subset(., Ho=="K")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="K")
k_plot <- k_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.k, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=k_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=k_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(k_plot$prop.k[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("K")
```



```{r, lazy = TRUE}
k_sff <- dat_sff %>% mutate(prop.k=(sum(subset(., Ho=="K")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="K")
k_plotf <- k_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.k, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=k_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(k_plotf$prop.k[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("K")
```

## K'

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
k1_sff <- dat_sff %>% mutate(prop.k1=(sum(subset(., Ho=="K'")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="K'")
k1_plot <- k1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.k1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
k1_plot$centroid <- sf::st_transform(k1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

k1 <- k1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Bao Thuan" & NAME_2=="Di Linh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.k1=as.numeric(round(prop.k1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.k1, area_km, songuoi_km, lng, lat, distm_km)

k1_peak <- k1_plot %>% filter(NAME_3=="Xa Bao Thuan" & NAME_2=="Di Linh")

```



```{r, message=FALSE, warning=FALSE}
k1_sf <- dat_sf %>% mutate(prop.k1=(sum(subset(., Ho=="K'")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="K'")
k1_plot <- k1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.k1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=k1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=k1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(k1_plot$prop.k1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("K'")
```



```{r, lazy = TRUE}
k1_sff <- dat_sff %>% mutate(prop.k1=(sum(subset(., Ho=="K'")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="K'")
k1_plotf <- k1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.k1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=k1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(k1_plotf$prop.k1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("K'")
```

## Ka

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ka_sff <- dat_sff %>% mutate(prop.ka=(sum(subset(., Ho=="Ka")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ka")
ka_plot <- ka_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ka, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ka_plot$centroid <- sf::st_transform(ka_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ka <- ka_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Son Dien" & NAME_2=="Di Linh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ka=as.numeric(round(prop.ka, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ka, area_km, songuoi_km, lng, lat, distm_km)

ka_peak <- ka_plot %>% filter(NAME_3=="Xa Son Dien" & NAME_2=="Di Linh")

```



```{r, message=FALSE, warning=FALSE}
ka_sf <- dat_sf %>% mutate(prop.ka=(sum(subset(., Ho=="Ka")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ka")
ka_plot <- ka_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ka, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ka_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ka_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ka_plot$prop.ka[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ka")
```



```{r, lazy = TRUE}
ka_sff <- dat_sff %>% mutate(prop.ka=(sum(subset(., Ho=="Ka")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ka")
ka_plotf <- ka_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ka, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ka_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ka_plotf$prop.ka[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ka")
```

## Katơr

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kator_sff <- dat_sff %>% mutate(prop.kator=(sum(subset(., Ho=="Katơr")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Katơr")
kator_plot <- kator_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kator, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
kator_plot$centroid <- sf::st_transform(kator_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

kator <- kator_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phuoc Binh" & NAME_2=="Bac Ai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.kator=as.numeric(round(prop.kator, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kator, area_km, songuoi_km, lng, lat, distm_km)

kator_peak <- kator_plot %>% filter(NAME_3=="Xa Phuoc Binh" & NAME_2=="Bac Ai")

```



```{r, message=FALSE, warning=FALSE}
kator_sf <- dat_sf %>% mutate(prop.kator=(sum(subset(., Ho=="Katơr")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Katơr")
kator_plot <- kator_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.kator, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kator_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=kator_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kator_plot$prop.kator[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Katơr")
```



```{r, lazy = TRUE}
kator_sff <- dat_sff %>% mutate(prop.kator=(sum(subset(., Ho=="Katơr")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Katơr")
kator_plotf <- kator_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.kator, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kator_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kator_plotf$prop.kator[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Katơr")
```

## Kha

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kha_sff <- dat_sff %>% mutate(prop.kha=(sum(subset(., Ho=="Kha")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kha")
kha_plot <- kha_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kha, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
kha_plot$centroid <- sf::st_transform(kha_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

kha <- kha_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Binh Chuan" & NAME_2=="Con Cuong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.kha=as.numeric(round(prop.kha, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kha, area_km, songuoi_km, lng, lat, distm_km)

kha_peak <- kha_plot %>% filter(NAME_3=="Xa Binh Chuan" & NAME_2=="Con Cuong")

```



```{r, message=FALSE, warning=FALSE}
kha_sf <- dat_sf %>% mutate(prop.kha=(sum(subset(., Ho=="Kha")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kha")
kha_plot <- kha_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.kha, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kha_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=kha_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kha_plot$prop.kha[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kha")
```



```{r, lazy = TRUE}
kha_sff <- dat_sff %>% mutate(prop.kha=(sum(subset(., Ho=="Kha")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kha")
kha_plotf <- kha_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.kha, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kha_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kha_plotf$prop.kha[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kha")
```

## Khổng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
khong_sff <- dat_sff %>% mutate(prop.khong=(sum(subset(., Ho=="Khổng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khổng")
khong_plot <- khong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
khong_plot$centroid <- sf::st_transform(khong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

khong <- khong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cao Phong" & NAME_2=="Song Lo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.khong=as.numeric(round(prop.khong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khong, area_km, songuoi_km, lng, lat, distm_km)

khong_peak <- khong_plot %>% filter(NAME_3=="Xa Cao Phong" & NAME_2=="Song Lo")

```



```{r, message=FALSE, warning=FALSE}
khong_sf <- dat_sf %>% mutate(prop.khong=(sum(subset(., Ho=="Khổng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khổng")
khong_plot <- khong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.khong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=khong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khong_plot$prop.khong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khổng")
```



```{r, lazy = TRUE}
khong_sff <- dat_sff %>% mutate(prop.khong=(sum(subset(., Ho=="Khổng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khổng")
khong_plotf <- khong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.khong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khong_plotf$prop.khong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khổng")
```

## Khuất

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
khuat_sff <- dat_sff %>% mutate(prop.khuat=(sum(subset(., Ho=="Khuất")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khuất")
khuat_plot <- khuat_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuat, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
khuat_plot$centroid <- sf::st_transform(khuat_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

khuat <- khuat_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cam Yen" & NAME_2=="Thach That"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.khuat=as.numeric(round(prop.khuat, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuat, area_km, songuoi_km, lng, lat, distm_km)

khuat_peak <- khuat_plot %>% filter(NAME_3=="Xa Cam Yen" & NAME_2=="Thach That")

```



```{r, message=FALSE, warning=FALSE}
khuat_sf <- dat_sf %>% mutate(prop.khuat=(sum(subset(., Ho=="Khuất")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khuất")
khuat_plot <- khuat_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.khuat, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuat_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=khuat_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuat_plot$prop.khuat[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khuất")
```



```{r, lazy = TRUE}
khuat_sff <- dat_sff %>% mutate(prop.khuat=(sum(subset(., Ho=="Khuất")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khuất")
khuat_plotf <- khuat_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.khuat, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuat_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuat_plotf$prop.khuat[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khuất")
```

## Khúc

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuc, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
khuc_plot$centroid <- sf::st_transform(khuc_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

khuc <- khuc_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.khuc=as.numeric(round(prop.khuc, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuc, area_km, songuoi_km, lng, lat, distm_km)

khuc_peak <- khuc_plot %>% filter(NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha")

```



```{r, message=FALSE, warning=FALSE}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuc_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=khuc_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khúc")
```



```{r, lazy = TRUE}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plotf <- khuc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.khuc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuc_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuc_plotf$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khúc")
```

## Khương

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
khuong_sff <- dat_sff %>% mutate(prop.khuong=(sum(subset(., Ho=="Khương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khương")
khuong_plot <- khuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
khuong_plot$centroid <- sf::st_transform(khuong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

khuong <- khuong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tien Lu" & NAME_2=="Lap Thach"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.khuong=as.numeric(round(prop.khuong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuong, area_km, songuoi_km, lng, lat, distm_km)

khuong_peak <- khuong_plot %>% filter(NAME_3=="Xa Tien Lu" & NAME_2=="Lap Thach")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
khuong_sf <- dat_sf %>% mutate(prop.khuong=(sum(subset(., Ho=="Khương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khương")
khuong_plot <- khuong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.khuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=khuong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuong_plot$prop.khuong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khương")
```



```{r, lazy = TRUE}
khuong_sff <- dat_sff %>% mutate(prop.khuong=(sum(subset(., Ho=="Khương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khương")
khuong_plotf <- khuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.khuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuong_plotf$prop.khuong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khương")
```

## Khưu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
khuu_sff <- dat_sff %>% mutate(prop.khuu=(sum(subset(., Ho=="Khưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khưu")
khuu_plot <- khuu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
khuu_plot$centroid <- sf::st_transform(khuu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

khuu <- khuu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Dong" & NAME_2=="Vinh Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.khuu=as.numeric(round(prop.khuu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuu, area_km, songuoi_km, lng, lat, distm_km)

khuu_peak <- khuu_plot %>% filter(NAME_3=="Xa Hoa Dong" & NAME_2=="Vinh Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
khuu_sf <- dat_sf %>% mutate(prop.khuu=(sum(subset(., Ho=="Khưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khưu")
khuu_plot <- khuu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.khuu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=khuu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuu_plot$prop.khuu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khưu")
```



```{r, lazy = TRUE}
khuu_sff <- dat_sff %>% mutate(prop.khuu=(sum(subset(., Ho=="Khưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khưu")
khuu_plotf <- khuu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.khuu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(khuu_plotf$prop.khuu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Khưu")
```

## Kiên

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kien_sff <- dat_sff %>% mutate(prop.kien=(sum(subset(., Ho=="Kiên")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kiên")
kien_plot <- kien_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kien, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
kien_plot$centroid <- sf::st_transform(kien_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

kien <- kien_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thanh Hoa Son" & NAME_2=="Cau Ngang"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.kien=as.numeric(round(prop.kien, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kien, area_km, songuoi_km, lng, lat, distm_km)

kien_peak <- kien_plot %>% filter(NAME_3=="Xa Thanh Hoa Son" & NAME_2=="Cau Ngang")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kien_sf <- dat_sf %>% mutate(prop.kien=(sum(subset(., Ho=="Kiên")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kiên")
kien_plot <- kien_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.kien, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kien_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=kien_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kien_plot$prop.kien[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kiên")
```



```{r, lazy = TRUE}
kien_sff <- dat_sff %>% mutate(prop.kien=(sum(subset(., Ho=="Kiên")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kiên")
kien_plotf <- kien_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.kien, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kien_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kien_plotf$prop.kien[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kiên")
```

## Kiều

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kieu_sff <- dat_sff %>% mutate(prop.kieu=(sum(subset(., Ho=="Kiều")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kiều")
kieu_plot <- kieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kieu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
kieu_plot$centroid <- sf::st_transform(kieu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

kieu <- kieu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Can Kiem" & NAME_2=="Thach That"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.kieu=as.numeric(round(prop.kieu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kieu, area_km, songuoi_km, lng, lat, distm_km)

kieu_peak <- kieu_plot %>% filter(NAME_3=="Xa Can Kiem" & NAME_2=="Thach That")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kieu_sf <- dat_sf %>% mutate(prop.kieu=(sum(subset(., Ho=="Kiều")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kiều")
kieu_plot <- kieu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.kieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kieu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=kieu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kieu_plot$prop.kieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kiều")
```



```{r, lazy = TRUE}
kieu_sff <- dat_sff %>% mutate(prop.kieu=(sum(subset(., Ho=="Kiều")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kiều")
kieu_plotf <- kieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.kieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kieu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kieu_plotf$prop.kieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kiều")
```

## Kim

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kim_sff <- dat_sff %>% mutate(prop.kim=(sum(subset(., Ho=="Kim")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kim")
kim_plot <- kim_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kim, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
kim_plot$centroid <- sf::st_transform(kim_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

kim <- kim_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tan Son" & NAME_2=="Tra Cu"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.kim=as.numeric(round(prop.kim, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kim, area_km, songuoi_km, lng, lat, distm_km)

kim_peak <- kim_plot %>% filter(NAME_3=="Xa Tan Son" & NAME_2=="Tra Cu")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kim_sf <- dat_sf %>% mutate(prop.kim=(sum(subset(., Ho=="Kim")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kim")
kim_plot <- kim_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.kim, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kim_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=kim_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kim_plot$prop.kim[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kim")
```



```{r, lazy = TRUE}
kim_sff <- dat_sff %>% mutate(prop.kim=(sum(subset(., Ho=="Kim")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kim")
kim_plotf <- kim_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.kim, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kim_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kim_plotf$prop.kim[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kim")
```

## Kơ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ko_sff <- dat_sff %>% mutate(prop.ko=(sum(subset(., Ho=="Kơ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kơ")
ko_plot <- ko_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ko, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ko_plot$centroid <- sf::st_transform(ko_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ko <- ko_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Da Nhim" & NAME_2=="Lac Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ko=as.numeric(round(prop.ko, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ko, area_km, songuoi_km, lng, lat, distm_km)

ko_peak <- ko_plot %>% filter(NAME_3=="Xa Da Nhim" & NAME_2=="Lac Duong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ko_sf <- dat_sf %>% mutate(prop.ko=(sum(subset(., Ho=="Kơ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kơ")
ko_plot <- ko_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ko, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ko_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ko_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ko_plot$prop.ko[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kơ")
```



```{r, lazy = TRUE}
ko_sff <- dat_sff %>% mutate(prop.ko=(sum(subset(., Ho=="Kơ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kơ")
ko_plotf <- ko_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ko, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ko_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ko_plotf$prop.ko[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kơ")
```

## Kpă

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kpa_sff <- dat_sff %>% mutate(prop.kpa=(sum(subset(., Ho=="Kpă")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kpă")
kpa_plot <- kpa_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kpa, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
kpa_plot$centroid <- sf::st_transform(kpa_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

kpa <- kpa_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Suoi Trai" & NAME_2=="Son Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.kpa=as.numeric(round(prop.kpa, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kpa, area_km, songuoi_km, lng, lat, distm_km)

kpa_peak <- kpa_plot %>% filter(NAME_3=="Xa Suoi Trai" & NAME_2=="Son Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kpa_sf <- dat_sf %>% mutate(prop.kpa=(sum(subset(., Ho=="Kpă")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kpă")
kpa_plot <- kpa_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.kpa, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kpa_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=kpa_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kpa_plot$prop.kpa[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kpă")
```



```{r, lazy = TRUE}
kpa_sff <- dat_sff %>% mutate(prop.kpa=(sum(subset(., Ho=="Kpă")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kpă")
kpa_plotf <- kpa_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.kpa, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kpa_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kpa_plotf$prop.kpa[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kpă")
```

## Kpuih

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kpuih_sff <- dat_sff %>% mutate(prop.kpuih=(sum(subset(., Ho=="Kpuih")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kpuih")
kpuih_plot <- kpuih_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kpuih, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
kpuih_plot$centroid <- sf::st_transform(kpuih_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

kpuih <- kpuih_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ia Tor" & NAME_2=="Chu Prong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.kpuih=as.numeric(round(prop.kpuih, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.kpuih, area_km, songuoi_km, lng, lat, distm_km)

kpuih_peak <- kpuih_plot %>% filter(NAME_3=="Xa Ia Tor" & NAME_2=="Chu Prong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
kpuih_sf <- dat_sf %>% mutate(prop.kpuih=(sum(subset(., Ho=="Kpuih")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kpuih")
kpuih_plot <- kpuih_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.kpuih, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kpuih_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=kpuih_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kpuih_plot$prop.kpuih[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kpuih")
```



```{r, lazy = TRUE}
kpuih_sff <- dat_sff %>% mutate(prop.kpuih=(sum(subset(., Ho=="Kpuih")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Kpuih")
kpuih_plotf <- kpuih_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.kpuih, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=kpuih_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(kpuih_plotf$prop.kpuih[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Kpuih")
```

## Ksor

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ksor_sff <- dat_sff %>% mutate(prop.ksor=(sum(subset(., Ho=="Ksor")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ksor")
ksor_plot <- ksor_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ksor, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ksor_plot$centroid <- sf::st_transform(ksor_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ksor <- ksor_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ea Lam" & NAME_2=="Song Hinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ksor=as.numeric(round(prop.ksor, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ksor, area_km, songuoi_km, lng, lat, distm_km)

ksor_peak <- ksor_plot %>% filter(NAME_3=="Xa Ea Lam" & NAME_2=="Song Hinh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ksor_sf <- dat_sf %>% mutate(prop.ksor=(sum(subset(., Ho=="Ksor")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ksor")
ksor_plot <- ksor_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ksor, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ksor_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ksor_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ksor_plot$prop.ksor[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ksor")
```



```{r, lazy = TRUE}
ksor_sff <- dat_sff %>% mutate(prop.ksor=(sum(subset(., Ho=="Ksor")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ksor")
ksor_plotf <- ksor_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ksor, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ksor_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ksor_plotf$prop.ksor[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ksor")
```

## La

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
la_sff <- dat_sff %>% mutate(prop.la=(sum(subset(., Ho=="La")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="La")
la_plot <- la_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.la, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
la_plot$centroid <- sf::st_transform(la_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

la <- la_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Mo" & NAME_2=="Dong Xuan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.la=as.numeric(round(prop.la, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.la, area_km, songuoi_km, lng, lat, distm_km)

la_peak <- la_plot %>% filter(NAME_3=="Xa Phu Mo" & NAME_2=="Dong Xuan")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
la_sf <- dat_sf %>% mutate(prop.la=(sum(subset(., Ho=="La")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="La")
la_plot <- la_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.la, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=la_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=la_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("La")
```



```{r, lazy = TRUE}
la_sff <- dat_sff %>% mutate(prop.la=(sum(subset(., Ho=="La")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="La")
la_plotf <- la_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.la, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=la_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(la_plotf$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("La")
```

## Lã

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
la2_sff <- dat_sff %>% mutate(prop.la2=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la2_plot <- la2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.la2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
la2_plot$centroid <- sf::st_transform(la2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

la2 <- la2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Khanh Thinh" & NAME_2=="Yen Mo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.la2=as.numeric(round(prop.la2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.la2, area_km, songuoi_km, lng, lat, distm_km)

la2_peak <- la2_plot %>% filter(NAME_3=="Xa Khanh Thinh" & NAME_2=="Yen Mo")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
la2_sf <- dat_sf %>% mutate(prop.la2=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la2_plot <- la2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.la2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=la2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=la2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(la2_plot$prop.la2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lã")
```



```{r, lazy = TRUE}
la2_sff <- dat_sff %>% mutate(prop.la2=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la2_plotf <- la2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.la2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=la2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(la2_plotf$prop.la2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lã")
```

## Lai

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lai_sff <- dat_sff %>% mutate(prop.lai=(sum(subset(., Ho=="Lai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lai")
lai_plot <- lai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lai, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lai_plot$centroid <- sf::st_transform(lai_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lai <- lai_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Lac Hoa" & NAME_2=="Vinh Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lai=as.numeric(round(prop.lai, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lai, area_km, songuoi_km, lng, lat, distm_km)

lai_peak <- lai_plot %>% filter(NAME_3=="Xa Lac Hoa" & NAME_2=="Vinh Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lai_sf <- dat_sf %>% mutate(prop.lai=(sum(subset(., Ho=="Lai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lai")
lai_plot <- lai_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lai, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lai_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lai_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lai_plot$prop.lai[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lai")
```



```{r, lazy = TRUE}
lai_sff <- dat_sff %>% mutate(prop.lai=(sum(subset(., Ho=="Lai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lai")
lai_plotf <- lai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lai, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lai_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lai_plotf$prop.lai[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lai")
```

## Lại

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lai1_sff <- dat_sff %>% mutate(prop.lai1=(sum(subset(., Ho=="Lại")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lại")
lai1_plot <- lai1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lai1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lai1_plot$centroid <- sf::st_transform(lai1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lai1 <- lai1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Liem Chung" & NAME_2=="Phu Ly"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lai1=as.numeric(round(prop.lai1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lai1, area_km, songuoi_km, lng, lat, distm_km)

lai1_peak <- lai1_plot %>% filter(NAME_3=="Xa Liem Chung" & NAME_2=="Phu Ly")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lai1_sf <- dat_sf %>% mutate(prop.lai1=(sum(subset(., Ho=="Lại")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lại")
lai1_plot <- lai1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lai1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lai1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lai1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lai1_plot$prop.lai1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lại")
```



```{r, lazy = TRUE}
lai1_sff <- dat_sff %>% mutate(prop.lai1=(sum(subset(., Ho=="Lại")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lại")
lai1_plotf <- lai1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lai1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lai1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lai1_plotf$prop.lai1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lại")
```

## Lâm

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lam_sff <- dat_sff %>% mutate(prop.lam=(sum(subset(., Ho=="Lâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lâm")
lam_plot <- lam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lam, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lam_plot$centroid <- sf::st_transform(lam_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lam <- lam_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Minh Khai" & NAME_2=="Binh Gia"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lam=as.numeric(round(prop.lam, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lam, area_km, songuoi_km, lng, lat, distm_km)

lam_peak <- lam_plot %>% filter(NAME_3=="Xa Minh Khai" & NAME_2=="Binh Gia")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lam_sf <- dat_sf %>% mutate(prop.lam=(sum(subset(., Ho=="Lâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lâm")
lam_plot <- lam_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lam_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lam_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lam_plot$prop.lam[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lâm")
```



```{r, lazy = TRUE}
lam_sff <- dat_sff %>% mutate(prop.lam=(sum(subset(., Ho=="Lâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lâm")
lam_plotf <- lam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lam_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lam_plotf$prop.lam[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lâm")
```

## Lang

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lang_sff <- dat_sff %>% mutate(prop.lang=(sum(subset(., Ho=="Lang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lang")
lang_plot <- lang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lang_plot$centroid <- sf::st_transform(lang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lang <- lang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Bat Mot" & NAME_2=="Thuong Xuan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lang=as.numeric(round(prop.lang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lang, area_km, songuoi_km, lng, lat, distm_km)

lang_peak <- lang_plot %>% filter(NAME_3=="Xa Bat Mot" & NAME_2=="Thuong Xuan")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lang_sf <- dat_sf %>% mutate(prop.lang=(sum(subset(., Ho=="Lang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lang")
lang_plot <- lang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lang_plot$prop.lang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lang")
```



```{r, lazy = TRUE}
lang_sff <- dat_sff %>% mutate(prop.lang=(sum(subset(., Ho=="Lang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lang")
lang_plotf <- lang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lang_plotf$prop.lang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lang")
```

## Lăng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lang2_sff <- dat_sff %>% mutate(prop.lang2=(sum(subset(., Ho=="Lăng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lăng")
lang2_plot <- lang2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lang2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lang2_plot$centroid <- sf::st_transform(lang2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lang2 <- lang2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Za Hung" & NAME_2=="Dong Giang"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lang2=as.numeric(round(prop.lang2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lang2, area_km, songuoi_km, lng, lat, distm_km)

lang2_peak <- lang2_plot %>% filter(NAME_3=="Xa Za Hung" & NAME_2=="Dong Giang")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lang2_sf <- dat_sf %>% mutate(prop.lang2=(sum(subset(., Ho=="Lăng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lăng")
lang2_plot <- lang2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lang2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lang2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lang2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lang2_plot$prop.lang2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lăng")
```



```{r, lazy = TRUE}
lang2_sff <- dat_sff %>% mutate(prop.lang2=(sum(subset(., Ho=="Lăng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lăng")
lang2_plotf <- lang2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lang2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lang2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lang2_plotf$prop.lang2[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lăng")
```

## Lành

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lanh_sff <- dat_sff %>% mutate(prop.lanh=(sum(subset(., Ho=="Lành")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lành")
lanh_plot <- lanh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lanh, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lanh_plot$centroid <- sf::st_transform(lanh_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lanh <- lanh_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Gia" & NAME_2=="Loc Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lanh=as.numeric(round(prop.lanh, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lanh, area_km, songuoi_km, lng, lat, distm_km)

lanh_peak <- lanh_plot %>% filter(NAME_3=="Xa Tam Gia" & NAME_2=="Loc Binh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lanh_sf <- dat_sf %>% mutate(prop.lanh=(sum(subset(., Ho=="Lành")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lành")
lanh_plot <- lanh_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lanh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lanh_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lanh_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lanh_plot$prop.lanh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lành")
```



```{r, lazy = TRUE}
lanh_sff <- dat_sff %>% mutate(prop.lanh=(sum(subset(., Ho=="Lành")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lành")
lanh_plotf <- lanh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lanh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lanh_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lanh_plotf$prop.lanh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lành")
```

## Lầu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lau_sff <- dat_sff %>% mutate(prop.lau=(sum(subset(., Ho=="Lầu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lầu")
lau_plot <- lau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lau, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lau_plot$centroid <- sf::st_transform(lau_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lau <- lau_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Xa Dung" & NAME_2=="Dien Bien Dong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lau=as.numeric(round(prop.lau, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lau, area_km, songuoi_km, lng, lat, distm_km)

lau_peak <- lau_plot %>% filter(NAME_3=="Xa Xa Dung" & NAME_2=="Dien Bien Dong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lau_sf <- dat_sf %>% mutate(prop.lau=(sum(subset(., Ho=="Lầu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lầu")
lau_plot <- lau_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lau_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lau_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lau_plot$prop.lau[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lầu")
```



```{r, lazy = TRUE}
lau_sff <- dat_sff %>% mutate(prop.lau=(sum(subset(., Ho=="Lầu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lầu")
lau_plotf <- lau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lau_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lau_plotf$prop.lau[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lầu")
```

## Lê

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.le, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
le_plot$centroid <- sf::st_transform(le_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

le <- le_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.le=as.numeric(round(prop.le, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.le, area_km, songuoi_km, lng, lat, distm_km)

le_peak <- le_plot %>% filter(NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=le_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=le_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lê")
```



```{r, lazy = TRUE}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plotf <- le_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.le, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=le_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(le_plotf$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lê")
```

## Lèo

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
leo_sff <- dat_sff %>% mutate(prop.leo=(sum(subset(., Ho=="Lèo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lèo")
leo_plot <- leo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.leo, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
leo_plot$centroid <- sf::st_transform(leo_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

leo <- leo_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hua La" & NAME_2=="Son La"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.leo=as.numeric(round(prop.leo, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.leo, area_km, songuoi_km, lng, lat, distm_km)

leo_peak <- leo_plot %>% filter(NAME_3=="Xa Hua La" & NAME_2=="Son La")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
leo_sf <- dat_sf %>% mutate(prop.leo=(sum(subset(., Ho=="Lèo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lèo")
leo_plot <- leo_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.leo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=leo_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=leo_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(leo_plot$prop.leo[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lèo")
```



```{r, lazy = TRUE}
leo_sff <- dat_sff %>% mutate(prop.leo=(sum(subset(., Ho=="Lèo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lèo")
leo_plotf <- leo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.leo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=leo_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(leo_plotf$prop.leo[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lèo")
```

## Lo

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lo_sff <- dat_sff %>% mutate(prop.lo=(sum(subset(., Ho=="Lo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lo")
lo_plot <- lo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lo, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lo_plot$centroid <- sf::st_transform(lo_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lo <- lo_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Bac Son" & NAME_2=="Quy Hop"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lo=as.numeric(round(prop.lo, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lo, area_km, songuoi_km, lng, lat, distm_km)

lo_peak <- lo_plot %>% filter(NAME_3=="Xa Bac Son" & NAME_2=="Quy Hop")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lo_sf <- dat_sf %>% mutate(prop.lo=(sum(subset(., Ho=="Lo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lo")
lo_plot <- lo_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lo_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lo_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lo_plot$prop.lo[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lo")
```



```{r, lazy = TRUE}
lo_sff <- dat_sff %>% mutate(prop.lo=(sum(subset(., Ho=="Lo")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lo")
lo_plotf <- lo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lo_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lo_plotf$prop.lo[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lo")
```

## Lò

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lo1_sff <- dat_sff %>% mutate(prop.lo1=(sum(subset(., Ho=="Lò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lò")
lo1_plot <- lo1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lo1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lo1_plot$centroid <- sf::st_transform(lo1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lo1 <- lo1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Na Tam" & NAME_2=="Tam Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lo1=as.numeric(round(prop.lo1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lo1, area_km, songuoi_km, lng, lat, distm_km)

lo1_peak <- lo1_plot %>% filter(NAME_3=="Xa Na Tam" & NAME_2=="Tam Duong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lo1_sf <- dat_sf %>% mutate(prop.lo1=(sum(subset(., Ho=="Lò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lò")
lo1_plot <- lo1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lo1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lo1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lo1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lo1_plot$prop.lo1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lò")
```



```{r, lazy = TRUE}
lo1_sff <- dat_sff %>% mutate(prop.lo1=(sum(subset(., Ho=="Lò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lò")
lo1_plotf <- lo1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lo1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lo1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lo1_plotf$prop.lo1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lò")
```

## Lô

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lo2_sff <- dat_sff %>% mutate(prop.lo2=(sum(subset(., Ho=="Lô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lô")
lo2_plot <- lo2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lo2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lo2_plot$centroid <- sf::st_transform(lo2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lo2 <- lo2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cam Muon" & NAME_2=="Que Phong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lo2=as.numeric(round(prop.lo2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lo2, area_km, songuoi_km, lng, lat, distm_km)

lo2_peak <- lo2_plot %>% filter(NAME_3=="Xa Cam Muon" & NAME_2=="Que Phong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lo2_sf <- dat_sf %>% mutate(prop.lo2=(sum(subset(., Ho=="Lô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lô")
lo2_plot <- lo2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lo2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lo2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lo2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lo2_plot$prop.lo2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lô")
```



```{r, lazy = TRUE}
lo2_sff <- dat_sff %>% mutate(prop.lo2=(sum(subset(., Ho=="Lô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lô")
lo2_plotf <- lo2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lo2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lo2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lo2_plotf$prop.lo2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lô")
```

## Lộc

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
loc_sff <- dat_sff %>% mutate(prop.loc=(sum(subset(., Ho=="Lộc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lộc")
loc_plot <- loc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.loc, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
loc_plot$centroid <- sf::st_transform(loc_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

loc <- loc_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hien Kiet" & NAME_2=="Quan Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.loc=as.numeric(round(prop.loc, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.loc, area_km, songuoi_km, lng, lat, distm_km)

loc_peak <- loc_plot %>% filter(NAME_3=="Xa Hien Kiet" & NAME_2=="Quan Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
loc_sf <- dat_sf %>% mutate(prop.loc=(sum(subset(., Ho=="Lộc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lộc")
loc_plot <- loc_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.loc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=loc_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=loc_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(loc_plot$prop.loc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lộc")
```



```{r, lazy = TRUE}
loc_sff <- dat_sff %>% mutate(prop.loc=(sum(subset(., Ho=="Lộc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lộc")
loc_plotf <- loc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.loc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=loc_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(loc_plotf$prop.loc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lộc")
```

## Long

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
long_sff <- dat_sff %>% mutate(prop.long=(sum(subset(., Ho=="Long")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Long")
long_plot <- long_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.long, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
long_plot$centroid <- sf::st_transform(long_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

long <- long_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Phung" & NAME_2=="Hoang Su Phi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.long=as.numeric(round(prop.long, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.long, area_km, songuoi_km, lng, lat, distm_km)

long_peak <- long_plot %>% filter(NAME_3=="Xa Ban Phung" & NAME_2=="Hoang Su Phi")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
long_sf <- dat_sf %>% mutate(prop.long=(sum(subset(., Ho=="Long")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Long")
long_plot <- long_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.long, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=long_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=long_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(long_plot$prop.long[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Long")
```



```{r, lazy = TRUE}
long_sff <- dat_sff %>% mutate(prop.long=(sum(subset(., Ho=="Long")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Long")
long_plotf <- long_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.long, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=long_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(long_plotf$prop.long[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Long")
```

## Lù

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lu_sff <- dat_sff %>% mutate(prop.lu=(sum(subset(., Ho=="Lù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lù")
lu_plot <- lu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lu_plot$centroid <- sf::st_transform(lu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lu <- lu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thang Tin" & NAME_2=="Hoang Su Phi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lu=as.numeric(round(prop.lu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lu, area_km, songuoi_km, lng, lat, distm_km)

lu_peak <- lu_plot %>% filter(NAME_3=="Xa Thang Tin" & NAME_2=="Hoang Su Phi")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lu_sf <- dat_sf %>% mutate(prop.lu=(sum(subset(., Ho=="Lù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lù")
lu_plot <- lu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lu_plot$prop.lu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lù")
```



```{r, lazy = TRUE}
lu_sff <- dat_sff %>% mutate(prop.lu=(sum(subset(., Ho=="Lù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lù")
lu_plotf <- lu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lu_plotf$prop.lu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lù")
```

## Lư

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lu1_sff <- dat_sff %>% mutate(prop.lu1=(sum(subset(., Ho=="Lư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lư")
lu1_plot <- lu1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lu1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lu1_plot$centroid <- sf::st_transform(lu1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lu1 <- lu1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Muong Khoa" & NAME_2=="Bac Yen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lu1=as.numeric(round(prop.lu1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lu1, area_km, songuoi_km, lng, lat, distm_km)

lu1_peak <- lu1_plot %>% filter(NAME_3=="Xa Muong Khoa" & NAME_2=="Bac Yen")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lu1_sf <- dat_sf %>% mutate(prop.lu1=(sum(subset(., Ho=="Lư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lư")
lu1_plot <- lu1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lu1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lu1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lu1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lu1_plot$prop.lu1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lư")
```



```{r, lazy = TRUE}
lu1_sff <- dat_sff %>% mutate(prop.lu1=(sum(subset(., Ho=="Lư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lư")
lu1_plotf <- lu1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lu1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lu1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lu1_plotf$prop.lu1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lư")
```

## Lữ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
lu2_sff <- dat_sff %>% mutate(prop.lu2=(sum(subset(., Ho=="Lữ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lữ")
lu2_plot <- lu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lu2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
lu2_plot$centroid <- sf::st_transform(lu2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

lu2 <- lu2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Xuan" & NAME_2=="Quan Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.lu2=as.numeric(round(prop.lu2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.lu2, area_km, songuoi_km, lng, lat, distm_km)

lu2_peak <- lu2_plot %>% filter(NAME_3=="Xa Trung Xuan" & NAME_2=="Quan Son")

```



```{r, message=FALSE, warning=FALSE}
lu2_sf <- dat_sf %>% mutate(prop.lu2=(sum(subset(., Ho=="Lữ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lữ")
lu2_plot <- lu2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.lu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lu2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=lu2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lu2_plot$prop.lu2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lữ")
```



```{r, lazy = TRUE}
lu2_sff <- dat_sff %>% mutate(prop.lu2=(sum(subset(., Ho=="Lữ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lữ")
lu2_plotf <- lu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.lu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=lu1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(lu2_plotf$prop.lu2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lữ")
```

## Lục

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luc_sff <- dat_sff %>% mutate(prop.luc=(sum(subset(., Ho=="Lục")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lục")
luc_plot <- luc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luc, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
luc_plot$centroid <- sf::st_transform(luc_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

luc <- luc_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Co Lung" & NAME_2=="Ba Thuoc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.luc=as.numeric(round(prop.luc, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luc, area_km, songuoi_km, lng, lat, distm_km)

luc_peak <- luc_plot %>% filter(NAME_3=="Xa Co Lung" & NAME_2=="Ba Thuoc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luc_sf <- dat_sf %>% mutate(prop.luc=(sum(subset(., Ho=="Lục")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lục")
luc_plot <- luc_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.luc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luc_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=luc_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luc_plot$prop.luc[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lục")
```



```{r, lazy = TRUE}
luc_sff <- dat_sff %>% mutate(prop.luc=(sum(subset(., Ho=="Lục")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lục")
luc_plotf <- luc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.luc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luc_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luc_plotf$prop.luc[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lục")
```

## Lương

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
luong_plot$centroid <- sf::st_transform(luong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

luong <- luong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.luong=as.numeric(round(prop.luong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong, area_km, songuoi_km, lng, lat, distm_km)

luong_peak <- luong_plot %>% filter(NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luong_sf <- dat_sf %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.luong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=luong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luong_plot$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lương")
```



```{r, lazy = TRUE}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plotf <- luong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.luong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luong_plotf$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lương")
```

## Lường

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luong1_sff <- dat_sff %>% mutate(prop.luong1=(sum(subset(., Ho=="Lường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lường")
luong1_plot <- luong1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
luong1_plot$centroid <- sf::st_transform(luong1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

luong1 <- luong1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Ruong" & NAME_2=="Da Bac"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.luong1=as.numeric(round(prop.luong1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong1, area_km, songuoi_km, lng, lat, distm_km)

luong1_peak <- luong1_plot %>% filter(NAME_3=="Xa Dong Ruong" & NAME_2=="Da Bac")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luong1_sf <- dat_sf %>% mutate(prop.luong1=(sum(subset(., Ho=="Lường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lường")
luong1_plot <- luong1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.luong1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=luong1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luong1_plot$prop.luong1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lường")
```



```{r, lazy = TRUE}
luong1_sff <- dat_sff %>% mutate(prop.luong1=(sum(subset(., Ho=="Lường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lường")
luong1_plotf <- luong1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.luong1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luong1_plotf$prop.luong1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lường")
```

## Lưu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luu_sff <- dat_sff %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
luu_plot <- luu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
luu_plot$centroid <- sf::st_transform(luu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

luu <- luu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Linh Thong" & NAME_2=="Dinh Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.luu=as.numeric(round(prop.luu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luu, area_km, songuoi_km, lng, lat, distm_km)

luu_peak <- luu_plot %>% filter(NAME_3=="Xa Linh Thong" & NAME_2=="Dinh Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
luu_sf <- dat_sf %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
luu_plot <- luu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.luu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=luu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luu_plot$prop.luu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lưu")
```



```{r, lazy = TRUE}
luu_sff <- dat_sff %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
luu_plotf <- luu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.luu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(luu_plotf$prop.luu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lưu")
```

## Lý

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ly, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ly_plot$centroid <- sf::st_transform(ly_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ly <- ly_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ly=as.numeric(round(prop.ly, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ly, area_km, songuoi_km, lng, lat, distm_km)

ly_peak <- ly_plot %>% filter(NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ly_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ly_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lý")
```



```{r, lazy = TRUE}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plotf <- ly_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ly, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ly_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ly_plotf$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Lý")
```

## Ma

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ma_sff <- dat_sff %>% mutate(prop.ma=(sum(subset(., Ho=="Ma")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ma")
ma_plot <- ma_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ma, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ma_plot$centroid <- sf::st_transform(ma_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ma <- ma_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Minh Quang" & NAME_2=="Chiem Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ma=as.numeric(round(prop.ma, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ma, area_km, songuoi_km, lng, lat, distm_km)

ma_peak <- ma_plot %>% filter(NAME_3=="Xa Minh Quang" & NAME_2=="Chiem Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ma_sf <- dat_sf %>% mutate(prop.ma=(sum(subset(., Ho=="Ma")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ma")
ma_plot <- ma_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ma, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ma_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ma_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ma")
```



```{r, lazy = TRUE}
ma_sff <- dat_sff %>% mutate(prop.ma=(sum(subset(., Ho=="Ma")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ma")
ma_plotf <- ma_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ma, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ma_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ma_plotf$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ma")
```

## Mã

Bí mật 2000 năm về cột Đồng Trụ của Mã Viện.

Đồng bằng Bắc Bộ có đặc trưng văn hóa Gò Đống. Khi bị được phù sa bồi lấp, các gò đống lớn dần, khoảng nước giữa các gò hẹp lại biến thành các con sông ngoằn nghèo, và văn hóa Gò Đống chuyển sang văn hóa Làng Xã. Chế độ phụ hệ duy trì quy tắc đặt họ cho con theo họ bố. Do có đặc tính văn hóa Làng Xã mà độ ổn định dòng họ rất cao. Mật độ dòng họ theo không gian sống có dạng phân bố chuẩn. Như vậy các sự kiện xảy ra trong lịch sử nhiều nghìn năm về trước sẽ được phản ánh qua phân bố của các dòng họ. 

Năm 42, Hán Quang Vũ Đế lệnh cho các quận Trường Sa, Hợp Phố chuẩn bị xe thuyền, sửa đường và trữ lương; phong Mã Viện đã 58 tuổi làm Phục ba tướng quân, Lưu Long làm Phó tướng, Đoàn Chí làm Lâu Thuyền tướng quân sang đánh đất Giao Chỉ. 

Quân Hán huy động 2000 thuyền xe và 20 nghìn quân. Trong đó 8000 quân lấy từ các quận Trường Sa, Quế Dương, Linh Lăng, và 12000 quân lấy ở bộ Giao Chỉ. Đội quân này gồm toàn người Hoa Nam, quen thuộc thủy thổ phương Nam. Khi đến Hợp Phố thì Đoàn Chí chết bệnh nên Mã Viện thống suất toàn quân tiến theo ven biển, ngược sông Bạch Đằng tới sông Lục Đầu rồi vào đất Giao Chỉ, đi thẳng tới Lãng Bạc.

Quân Hán tiến đến Long Biên, Tây Vu, và Lãng Bạc ở phía đông Cổ Loa. Hai Bà Trưng từ Mê Linh qua Cổ Loa xuống Lãng Bạc đón đánh quân Hán. 
Sau trận Lãng Bạc, Trưng Vương phải thu quân về giữ Cổ Loa một thời gian rồi phải lui về Mê Linh, sau đó chạy sang Cấm Khê. Tại Cấm Khê, quân của Hai Bà tiếp tục bị đánh bại. Quân Hán chém hơn nghìn người, bắt hàng hơn 2 vạn quân khởi nghĩa.

Theo Mã Viện truyện, quân Mã Viện truy sát tới Cấm Khê thì chém được cả Trưng Trắc lẫn Trưng Nhị rồi đem đầu về Lạc Dương.

Sau khi chiếm lại quận Giao Chỉ, Mã Viện đem theo hơn 20000 binh sĩ cùng hơn 2000 lâu thuyền lớn nhỏ tiếp tục tiến vào Cửu Chân đánh Đô Dương là tướng của Bà Trưng.
Thủy Kinh Chú chép: "tháng 10 năm 19 hiệu Kiến Vũ, năm 43, Mã Viện tiến quân vào quận Cửu Chân ở miền Nam, đến huyện Vô Công, tướng giặc đầu hàng, lại tiến vào huyện Dư Phát. Cừ súy là Chu Bá bỏ quận mà vào rừng sâu... Mã Viện lại chia binh làm 2 đạo, 1 đạo vào huyện Vô Biên, 1 đạo đến huyện Cư Phong. Phàm tướng giặc không hàng đều bị chém đầu đến mấy trăm người." 

Sách Hậu Hán Thư (quyển 54) chép “Viện đáo Giao Chỉ, lập đồng trụ vi Hán chi cực gián dã”, nghĩa là : “Mã Viện đến Giao Chỉ, dựng cột đồng làm bờ cõi cùng cực của nhà Hán”.

Sách Thủy Kinh soạn thời Tam Quốc (khoảng năm 220-265) chép “Sông Uất Thủy lại chảy về phía nam, từ huyện Thọ Linh chảy vào biển. Ngày xưa Mã Văn Uyên (tức Mã Viện) chất đá làm bờ đê đến sông ngách Tượng Phố, dựng cột kim tiêu làm biên giới của vùng cực nam…

'Tiên' của Du Ích Kỳ nói: Mã Văn Uyên dựng hai cột đồng ở bờ bắc Lâm Ấp, có 10 gia đình binh lính sót lại không trở về, ở bờ nam Thọ Linh, đối mặt với cột đồng. Tất cả đều lấy họ là Mã, tự kết hôn với nhau, nay có 200 hộ. Người Giao Châu cho họ là người lưu ngụ, nên gọi là Mã lưu. Ngôn ngữ ăn uống còn giống với người Hoa. Núi sông dời đổi, cột đồng nay lại ở trong biển, chính nhờ vào những người dân này mà biết được chỗ xưa của cột đồng”. (Thủy kinh chú sớ,…sđd, tr. 395). 

Dựa trên thông tin vào thế kỷ thứ 6 có 200 hộ dân họ Mã sống ở vùng Mã Viện chôn cột Đồng Trụ, chúng ta có thể nhận thấy những hộ dân này sống thành một làng ở khu vực phía nam Thanh Hóa. Sử dụng dữ liệu thống kê dân số chúng ta có thể tính ra mật độ xác suất gặp người dân mang họ Mã ở từng làng trong cả nước. Sau đây là liệt kê kết quả tính cho khu vực gần với xã Nga Thạch.

Sau đây là phân bố xác suất người họ Mã.

Nga Thạch  27.07% (1306 họ Mã) 
Nga Tân    5.49%  (361 họ Mã) 
Quang Văn  1.87% (93 họ Mã) 
Tế Nông      1.14%  (61 họ Mã) 
Yên Giang    1.33% (52 họ Mã) 
Châu Lộc    1.22%  (39 họ Mã) 
Nga Trung   0.81% (33 họ Mã)  

Chúng ta có thể nhận thấy ở xã Nga Thạch mật độ người mang họ Mã rất cao. Cứ 3 người gặp ở đây thì có 1 người mang họ Mã. Xã Nga Thạch là ở bờ bắc ven sông Lèn. Phần bờ nam sông Lèn gần như không có người mang họ Mã sinh sống.

Theo thư tịch cổ, đầu Công nguyên cửa Thần Phù 神符海口 (còn gọi Thần Đầu 神投) nằm trên đường hành quân của Mã Viện. Tháng 11 năm 43 (SCN), sau khi tiêu diệt xong Bà Trưng, Mã Viện đưa 20 nghìn quân cùng 2 nghìn tàu thuyền vào Cửu Chân (Thanh Hóa nay) tiến đánh Đông Dương bằng đường thủy và đường bộ. Cánh quân bộ bị chặn đứng ở vùng núi Tam Điệp. Cánh quân thủy bị chao đảo trước sóng to, gió lớn của biển Thần Đầu (Thần Phù). Mã Viện phải sai quân đào sông qua dãy núi đá vùng này mà thư tịch cổ gọi là Tạc Khẩu.

Vào cuối thế kỷ thứ X, khi Đinh Tiên Hoàng vừa mới mất (năm 979), Đinh Toàn lên ngôi, Lê Hoàn là nhiếp chính. Phò mã Ngô Nhật Khánh cùng quân Chiêm Thành tiến ra Hoa Lư đánh nhà Đinh, nhưng vừa tới cửa Tiểu Khang (cửa Thần Phù) thì bị gió bão đánh chìm. Ngô Nhật Khánh chết đuối, chúa Chiêm may mắn thoát nạn.

Tỷ lệ tăng dân số ổn định trong suốt thời gian từ đầu Công Nguyên cho tới khi Pháp sang là 1‰. Thời gian sau khi Pháp sang tỷ lệ tăng dân số cao hơn. Năm 1802, Nguyễn Ánh diệt Tây Sơn, lập ra nhà Nguyễn, nước Đại Việt có 5780000 người. Thống kê dân số vào năm 1999 là 80 triệu. Trong khoảng từ 1800 tới 1999, tỷ lệ tăng dân số khoảng 1.3%. Trên trang thông tin chính thức của xã Nga Thạch dân số của xã tính đến năm 1999 là 5292 người. Do việc lấy chồng và di cư nên chúng ta ước tính có khoảng 10000 mang họ Mã ở xã Nga Thạch. Vào năm 1800 số cư dân mang họ Mã ở trong vùng Nga Thạch là 750 người. Vào thế kỷ thứ 6  số người mang họ Mã ở trong xã Nga Thạch là 220 người. Con số này cũng tương đối gần với số liệu có trong Thủy Kinh Chú. 

Kết hợp thông tin từ các cổ thư, thông tin về xác suất gặp người mang họ Mã, chúng ta có thể khẳng định Mã Viện quả là có trồng cột Đồng Trụ, và khu vực trồng cột này được xác định là ở trong khu vực bờ bắc sông Lèn và quanh vùng Nga Thạch, nơi có mật độ cao cư dân mang họ Mã cao.


```{r, warning=FALSE, message=FALSE, lazy=FALSE}
ma2_sff <- dat_sff %>% mutate(prop.ma2=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma2_plot <- ma2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ma2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ma2_plot$centroid <- sf::st_transform(ma2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ma2 <- ma2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Nga Thach" & NAME_2=="Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mai=as.numeric(round(prop.ma2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ma2, area_km, songuoi_km, lng, lat, distm_km)

ma2_peak <- ma2_plot %>% filter(NAME_3=="Xa Nga Thach" & NAME_2=="Nga Son")

datatable(ma2, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ma2_sf <- dat_sf %>% mutate(prop.ma2=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma2_plot <- ma2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ma2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ma2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ma2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ma2_plot$prop.ma2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mã")
```


```{r, lazy = TRUE}
ma2_sff <- dat_sff %>% mutate(prop.ma2=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma2_plotf <- ma2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ma2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ma2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ma2_plotf$prop.ma2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mã")
```

## Mạc

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mac_sff <- dat_sff %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plot <- mac_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mac, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mac_plot$centroid <- sf::st_transform(mac_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mac <- mac_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cong Liem" & NAME_2=="Nong Cong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mac=as.numeric(round(prop.mac, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mac, area_km, songuoi_km, lng, lat, distm_km)

mac_peak <- mac_plot %>% filter(NAME_3=="Xa Cong Liem" & NAME_2=="Nong Cong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mac_sf <- dat_sf %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plot <- mac_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mac, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mac_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mac_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mạc")
```



```{r, lazy = TRUE}
mac_sff <- dat_sff %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plotf <- mac_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mac, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mac_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mac_plotf$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mạc")
```

## Mai

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mai, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mai_plot$centroid <- sf::st_transform(mai_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mai <- mai_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son" & NAME_2=="Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mai=as.numeric(round(prop.mai, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mai, area_km, songuoi_km, lng, lat, distm_km)

mai_peak <- mai_plot %>% filter(NAME_3=="Thi tran Nga Son" & NAME_2=="Nga Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mai_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mai")
```



```{r, lazy = TRUE}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plotf <- mai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mai, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mai_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mai_plotf$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mai")
```

## Mang

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mang_sff <- dat_sff %>% mutate(prop.mang=(sum(subset(., Ho=="Mang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mang")
mang_plot <- mang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mang_plot$centroid <- sf::st_transform(mang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mang <- mang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cam Thinh Tay" & NAME_2=="Cam Ranh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mang=as.numeric(round(prop.mang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mang, area_km, songuoi_km, lng, lat, distm_km)

mang_peak <- mang_plot %>% filter(NAME_3=="Xa Cam Thinh Tay" & NAME_2=="Cam Ranh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mang_sf <- dat_sf %>% mutate(prop.mang=(sum(subset(., Ho=="Mang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mang")
mang_plot <- mang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mang_plot$prop.mang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mang")
```



```{r, lazy = TRUE}
mang_sff <- dat_sff %>% mutate(prop.mang=(sum(subset(., Ho=="Mang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mang")
mang_plotf <- mang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mang_plotf$prop.mang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mang")
```

## Mấu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mau_sff <- dat_sff %>% mutate(prop.mau=(sum(subset(., Ho=="Mấu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mấu")
mau_plot <- mau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mau, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mau_plot$centroid <- sf::st_transform(mau_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mau <- mau_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ba Cum Bac" & NAME_2=="Khanh Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mau=as.numeric(round(prop.mau, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mau, area_km, songuoi_km, lng, lat, distm_km)

mau_peak <- mau_plot %>% filter(NAME_3=="Xa Ba Cum Bac" & NAME_2=="Khanh Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mau_sf <- dat_sf %>% mutate(prop.mau=(sum(subset(., Ho=="Mấu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mấu")
mau_plot <- mau_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mau_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mau_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mau_plot$prop.mau[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mấu")
```



```{r, lazy = TRUE}
mau_sff <- dat_sff %>% mutate(prop.mau=(sum(subset(., Ho=="Mấu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mấu")
mau_plotf <- mau_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mau, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mau_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mau_plotf$prop.mau[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mấu")
```

## Mông

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mong_sff <- dat_sff %>% mutate(prop.mong=(sum(subset(., Ho=="Mông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mông")
mong_plot <- mong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mong_plot$centroid <- sf::st_transform(mong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mong <- mong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Bao Thang" & NAME_2=="Ky Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mong=as.numeric(round(prop.mong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mong, area_km, songuoi_km, lng, lat, distm_km)

mong_peak <- mong_plot %>% filter(NAME_3=="Xa Bao Thang" & NAME_2=="Ky Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mong_sf <- dat_sf %>% mutate(prop.mong=(sum(subset(., Ho=="Mông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mông")
mong_plot <- mong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mong_plot$prop.mong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mông")
```



```{r, lazy = TRUE}
mong_sff <- dat_sff %>% mutate(prop.mong=(sum(subset(., Ho=="Mông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mông")
mong_plotf <- mong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mong_plotf$prop.mong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mông")
```

## Mua

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mua_sff <- dat_sff %>% mutate(prop.mua=(sum(subset(., Ho=="Mua")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mua")
mua_plot <- mua_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mua, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mua_plot$centroid <- sf::st_transform(mua_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mua <- mua_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Pu Dao" & NAME_2=="Nam Nhun"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mua=as.numeric(round(prop.mua, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mua, area_km, songuoi_km, lng, lat, distm_km)

mua_peak <- mua_plot %>% filter(NAME_3=="Xa Pu Dao" & NAME_2=="Nam Nhun")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mua_sf <- dat_sf %>% mutate(prop.mua=(sum(subset(., Ho=="Mua")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mua")
mua_plot <- mua_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mua, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mua_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mua_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mua_plot$prop.mua[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mua")
```



```{r, lazy = TRUE}
mua_sff <- dat_sff %>% mutate(prop.mua=(sum(subset(., Ho=="Mua")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mua")
mua_plotf <- mua_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mua, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mua_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mua_plotf$prop.mua[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mua")
```

## Mùa

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mua1_sff <- dat_sff %>% mutate(prop.mua1=(sum(subset(., Ho=="Mùa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mùa")
mua1_plot <- mua1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mua1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mua1_plot$centroid <- sf::st_transform(mua1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mua1 <- mua1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ta Xua" & NAME_2=="Bac Yen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mua1=as.numeric(round(prop.mua1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mua1, area_km, songuoi_km, lng, lat, distm_km)

mua1_peak <- mua1_plot %>% filter(NAME_3=="Xa Ta Xua" & NAME_2=="Bac Yen")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mua1_sf <- dat_sf %>% mutate(prop.mua1=(sum(subset(., Ho=="Mùa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mùa")
mua1_plot <- mua1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mua1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mua1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mua1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mua1_plot$prop.mua1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mùa")
```



```{r, lazy = TRUE}
mua1_sff <- dat_sff %>% mutate(prop.mua1=(sum(subset(., Ho=="Mùa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mùa")
mua1_plotf <- mua1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mua1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mua1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mua1_plotf$prop.mua1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mùa")
```

## Mùi

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mui_sff <- dat_sff %>% mutate(prop.mui=(sum(subset(., Ho=="Mùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mùi")
mui_plot <- mui_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mui, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mui_plot$centroid <- sf::st_transform(mui_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mui <- mui_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tan Hop" & NAME_2=="Moc Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mui=as.numeric(round(prop.mui, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mui, area_km, songuoi_km, lng, lat, distm_km)

mui_peak <- mui_plot %>% filter(NAME_3=="Xa Tan Hop" & NAME_2=="Moc Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
mui_sf <- dat_sf %>% mutate(prop.mui=(sum(subset(., Ho=="Mùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mùi")
mui_plot <- mui_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mui, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mui_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mui_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mui_plot$prop.mui[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mùi")
```



```{r, lazy = TRUE}
mui_sff <- dat_sff %>% mutate(prop.mui=(sum(subset(., Ho=="Mùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mùi")
mui_plotf <- mui_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mui, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mui_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mui_plotf$prop.mui[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mùi")
```

## Nay

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nay_sff <- dat_sff %>% mutate(prop.nay=(sum(subset(., Ho=="Nay")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nay")
nay_plot <- nay_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nay, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nay_plot$centroid <- sf::st_transform(nay_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nay <- nay_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ia Sao" & NAME_2=="Ayun Pa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nay=as.numeric(round(prop.nay, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nay, area_km, songuoi_km, lng, lat, distm_km)

nay_peak <- nay_plot %>% filter(NAME_3=="Xa Ia Sao" & NAME_2=="Ayun Pa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nay_sf <- dat_sf %>% mutate(prop.nay=(sum(subset(., Ho=="Nay")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nay")
nay_plot <- nay_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nay, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nay_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nay_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nay_plot$prop.nay[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nay")
```



```{r, lazy = TRUE}
nay_sff <- dat_sff %>% mutate(prop.nay=(sum(subset(., Ho=="Nay")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nay")
nay_plotf <- nay_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nay, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nay_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nay_plotf$prop.nay[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nay")
```

## Néang

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
neang_sff <- dat_sff %>% mutate(prop.neang=(sum(subset(., Ho=="Néang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Néang")
neang_plot <- neang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.neang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
neang_plot$centroid <- sf::st_transform(neang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

neang <- neang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa O Lam" & NAME_2=="Tri Ton"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.neang=as.numeric(round(prop.neang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.neang, area_km, songuoi_km, lng, lat, distm_km)

neang_peak <- neang_plot %>% filter(NAME_3=="Xa O Lam" & NAME_2=="Tri Ton")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
neang_sf <- dat_sf %>% mutate(prop.neang=(sum(subset(., Ho=="Néang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Néang")
neang_plot <- neang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.neang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=neang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=neang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(neang_plot$prop.neang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Néang")
```



```{r, lazy = TRUE}
neang_sff <- dat_sff %>% mutate(prop.neang=(sum(subset(., Ho=="Néang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Néang")
neang_plotf <- neang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.neang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=neang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(neang_plotf$prop.neang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Néang")
```

## Ngân

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngan_sff <- dat_sff %>% mutate(prop.ngan=(sum(subset(., Ho=="Ngân")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngân")
ngan_plot <- ngan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngan, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ngan_plot$centroid <- sf::st_transform(ngan_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ngan <- ngan_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thanh Son" & NAME_2=="Ba Thuoc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ngan=as.numeric(round(prop.ngan, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngan, area_km, songuoi_km, lng, lat, distm_km)

ngan_peak <- ngan_plot %>% filter(NAME_3=="Xa Thanh Son" & NAME_2=="Ba Thuoc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngan_sf <- dat_sf %>% mutate(prop.ngan=(sum(subset(., Ho=="Ngân")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngân")
ngan_plot <- ngan_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ngan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngan_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ngan_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngan_plot$prop.ngan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngân")
```



```{r, lazy = TRUE}
ngan_sff <- dat_sff %>% mutate(prop.ngan=(sum(subset(., Ho=="Ngân")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngân")
ngan_plotf <- ngan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ngan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngan_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngan_plotf$prop.ngan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngân")
```

## Ngần

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngan1_sff <- dat_sff %>% mutate(prop.ngan1=(sum(subset(., Ho=="Ngần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngần")
ngan1_plot <- ngan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngan1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ngan1_plot$centroid <- sf::st_transform(ngan1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ngan1 <- ngan1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Pu Pin" & NAME_2=="Mai Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ngan1=as.numeric(round(prop.ngan1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngan1, area_km, songuoi_km, lng, lat, distm_km)

ngan1_peak <- ngan1_plot %>% filter(NAME_3=="Xa Pu Pin" & NAME_2=="Mai Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngan1_sf <- dat_sf %>% mutate(prop.ngan1=(sum(subset(., Ho=="Ngần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngần")
ngan1_plot <- ngan1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ngan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngan1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ngan1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngan1_plot$prop.ngan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngần")
```



```{r, lazy = TRUE}
ngan1_sff <- dat_sff %>% mutate(prop.ngan1=(sum(subset(., Ho=="Ngần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngần")
ngan1_plotf <- ngan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ngan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngan1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngan1_plotf$prop.ngan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngần")
```

## Nghiêm

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nghiem_sff <- dat_sff %>% mutate(prop.nghiem=(sum(subset(., Ho=="Nghiêm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nghiêm")
nghiem_plot <- nghiem_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nghiem, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nghiem_plot$centroid <- sf::st_transform(nghiem_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nghiem <- nghiem_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Cho" & NAME_2=="Yen Phong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nghiem=as.numeric(round(prop.nghiem, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nghiem, area_km, songuoi_km, lng, lat, distm_km)

nghiem_peak <- nghiem_plot %>% filter(NAME_3=="Thi tran Cho" & NAME_2=="Yen Phong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nghiem_sf <- dat_sf %>% mutate(prop.nghiem=(sum(subset(., Ho=="Nghiêm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nghiêm")
nghiem_plot <- nghiem_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nghiem, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nghiem_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nghiem_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nghiem_plot$prop.nghiem[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nghiêm")
```



```{r, lazy = TRUE}
nghiem_sff <- dat_sff %>% mutate(prop.nghiem=(sum(subset(., Ho=="Nghiêm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nghiêm")
nghiem_plotf <- nghiem_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nghiem, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nghiem_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nghiem_plotf$prop.nghiem[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nghiêm")
```

## Ngô

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ngo_plot$centroid <- sf::st_transform(ngo_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ngo <- ngo_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ngo=as.numeric(round(prop.ngo, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo, area_km, songuoi_km, lng, lat, distm_km)

ngo_peak <- ngo_plot %>% filter(NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ngo_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngô")
```



```{r, lazy = TRUE}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plotf <- ngo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ngo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngo_plotf$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngô")
```

## Ngọ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngo1_sff <- dat_sff %>% mutate(prop.ngo1=(sum(subset(., Ho=="Ngọ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngọ")
ngo1_plot <- ngo1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ngo1_plot$centroid <- sf::st_transform(ngo1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ngo1 <- ngo1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chau Minh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ngo1=as.numeric(round(prop.ngo1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo1, area_km, songuoi_km, lng, lat, distm_km)

ngo1_peak <- ngo1_plot %>% filter(NAME_3=="Xa Chau Minh" & NAME_2=="Hiep Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngo1_sf <- dat_sf %>% mutate(prop.ngo1=(sum(subset(., Ho=="Ngọ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngọ")
ngo1_plot <- ngo1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ngo1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ngo1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngo1_plot$prop.ngo1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngọ")
```



```{r, lazy = TRUE}
ngo1_sff <- dat_sff %>% mutate(prop.ngo1=(sum(subset(., Ho=="Ngọ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngọ")
ngo1_plotf <- ngo1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ngo1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngo1_plotf$prop.ngo1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngọ")
```

## Ngọc

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngoc_sff <- dat_sff %>% mutate(prop.ngoc=(sum(subset(., Ho=="Ngọc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngọc")
ngoc_plot <- ngoc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngoc, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ngoc_plot$centroid <- sf::st_transform(ngoc_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ngoc <- ngoc_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Long Son" & NAME_2=="Son Dong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ngoc=as.numeric(round(prop.ngoc, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngoc, area_km, songuoi_km, lng, lat, distm_km)

ngoc_peak <- ngoc_plot %>% filter(NAME_3=="Xa Long Son" & NAME_2=="Son Dong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ngoc_sf <- dat_sf %>% mutate(prop.ngoc=(sum(subset(., Ho=="Ngọc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngọc")
ngoc_plot <- ngoc_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ngoc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngoc_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ngoc_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngoc_plot$prop.ngoc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngọc")
```



```{r, lazy = TRUE}
ngoc_sff <- dat_sff %>% mutate(prop.ngoc=(sum(subset(., Ho=="Ngọc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngọc")
ngoc_plotf <- ngoc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ngoc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngoc_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ngoc_plotf$prop.ngoc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngọc")
```

## Ngụy

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nguy_sff <- dat_sff %>% mutate(prop.nguy=(sum(subset(., Ho=="Ngụy")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngụy")
nguy_plot <- nguy_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguy, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nguy_plot$centroid <- sf::st_transform(nguy_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nguy <- nguy_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tu Mai" & NAME_2=="Yen Dung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nguy=as.numeric(round(prop.nguy, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguy, area_km, songuoi_km, lng, lat, distm_km)

nguy_peak <- nguy_plot %>% filter(NAME_3=="Xa Tu Mai" & NAME_2=="Yen Dung")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nguy_sf <- dat_sf %>% mutate(prop.nguy=(sum(subset(., Ho=="Ngụy")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngụy")
nguy_plot <- nguy_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nguy, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguy_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nguy_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nguy_plot$prop.nguy[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngụy")
```



```{r, lazy = TRUE}
nguy_sff <- dat_sff %>% mutate(prop.nguy=(sum(subset(., Ho=="Ngụy")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngụy")
nguy_plotf <- nguy_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nguy, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguy_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nguy_plotf$prop.nguy[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ngụy")
```

## Nguyễn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguyen, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nguyen_plot$centroid <- sf::st_transform(nguyen_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nguyen <- nguyen_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nguyen=as.numeric(round(prop.nguyen, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguyen, area_km, songuoi_km, lng, lat, distm_km)

nguyen_peak <- nguyen_plot %>% filter(NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nguyen_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nguyễn")
```



```{r, lazy = TRUE}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plotf <- nguyen_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nguyen_plotf$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nguyễn")
```

## Nhâm

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nham_sff <- dat_sff %>% mutate(prop.nham=(sum(subset(., Ho=="Nhâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhâm")
nham_plot <- nham_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nham, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nham_plot$centroid <- sf::st_transform(nham_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nham <- nham_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong A" & NAME_2=="Dong Hung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nham=as.numeric(round(prop.nham, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nham, area_km, songuoi_km, lng, lat, distm_km)

nham_peak <- nham_plot %>% filter(NAME_3=="Xa Dong A" & NAME_2=="Dong Hung")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nham_sf <- dat_sf %>% mutate(prop.nham=(sum(subset(., Ho=="Nhâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhâm")
nham_plot <- nham_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nham, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nham_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nham_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nham_plot$prop.nham[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nhâm")
```



```{r, lazy = TRUE}
nham_sff <- dat_sff %>% mutate(prop.nham=(sum(subset(., Ho=="Nhâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhâm")
nham_plotf <- nham_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nham, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nham_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nham_plotf$prop.nham[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nhâm")
```

## Nhan

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nhan_sff <- dat_sff %>% mutate(prop.nhan=(sum(subset(., Ho=="Nhan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhan")
nhan_plot <- nhan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nhan, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nhan_plot$centroid <- sf::st_transform(nhan_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nhan <- nhan_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quoc Phong" & NAME_2=="Quang Uyen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nhan=as.numeric(round(prop.nhan, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nhan, area_km, songuoi_km, lng, lat, distm_km)

nhan_peak <- nhan_plot %>% filter(NAME_3=="Xa Quoc Phong" & NAME_2=="Quang Uyen")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nhan_sf <- dat_sf %>% mutate(prop.nhan=(sum(subset(., Ho=="Nhan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhan")
nhan_plot <- nhan_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nhan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nhan_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nhan_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nhan_plot$prop.nhan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nhan")
```



```{r, lazy = TRUE}
nhan_sff <- dat_sff %>% mutate(prop.nhan=(sum(subset(., Ho=="Nhan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhan")
nhan_plotf <- nhan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nhan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nhan_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nhan_plotf$prop.nhan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nhan")
```

## Nhữ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nhu_sff <- dat_sff %>% mutate(prop.nhu=(sum(subset(., Ho=="Nhữ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhữ")
nhu_plot <- nhu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nhu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nhu_plot$centroid <- sf::st_transform(nhu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nhu <- nhu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thai Hoa" & NAME_2=="Binh Giang"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nhu=as.numeric(round(prop.nhu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nhu, area_km, songuoi_km, lng, lat, distm_km)

nhu_peak <- nhu_plot %>% filter(NAME_3=="Xa Thai Hoa" & NAME_2=="Binh Giang")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nhu_sf <- dat_sf %>% mutate(prop.nhu=(sum(subset(., Ho=="Nhữ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhữ")
nhu_plot <- nhu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nhu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nhu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nhu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nhu_plot$prop.nhu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nhữ")
```



```{r, lazy = TRUE}
nhu_sff <- dat_sff %>% mutate(prop.nhu=(sum(subset(., Ho=="Nhữ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nhữ")
nhu_plotf <- nhu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nhu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nhu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nhu_plotf$prop.nhu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nhữ")
```

## Ninh

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ninh_sff <- dat_sff %>% mutate(prop.ninh=(sum(subset(., Ho=="Ninh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ninh")
ninh_plot <- ninh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ninh, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ninh_plot$centroid <- sf::st_transform(ninh_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ninh <- ninh_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Duc" & NAME_2=="Tien Yen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ninh=as.numeric(round(prop.ninh, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ninh, area_km, songuoi_km, lng, lat, distm_km)

ninh_peak <- ninh_plot %>% filter(NAME_3=="Xa Dai Duc" & NAME_2=="Tien Yen")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ninh_sf <- dat_sf %>% mutate(prop.ninh=(sum(subset(., Ho=="Ninh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ninh")
ninh_plot <- ninh_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ninh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ninh_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ninh_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ninh_plot$prop.ninh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ninh")
```



```{r, lazy = TRUE}
ninh_sff <- dat_sff %>% mutate(prop.ninh=(sum(subset(., Ho=="Ninh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ninh")
ninh_plotf <- ninh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ninh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ninh_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ninh_plotf$prop.ninh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ninh")
```

## Nông

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nong_sff <- dat_sff %>% mutate(prop.nong=(sum(subset(., Ho=="Nông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nông")
nong_plot <- nong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nong_plot$centroid <- sf::st_transform(nong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nong <- nong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Minh Long" & NAME_2=="Ha Lang"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nong=as.numeric(round(prop.nong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nong, area_km, songuoi_km, lng, lat, distm_km)

nong_peak <- nong_plot %>% filter(NAME_3=="Xa Minh Long" & NAME_2=="Ha Lang")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nong_sf <- dat_sf %>% mutate(prop.nong=(sum(subset(., Ho=="Nông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nông")
nong_plot <- nong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nong_plot$prop.nong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nông")
```



```{r, lazy = TRUE}
nong_sff <- dat_sff %>% mutate(prop.nong=(sum(subset(., Ho=="Nông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nông")
nong_plotf <- nong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(nong_plotf$prop.nong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Nông")
```

## Ôn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
on_sff <- dat_sff %>% mutate(prop.on=(sum(subset(., Ho=="Ôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ôn")
on_plot <- on_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.on, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
on_plot$centroid <- sf::st_transform(on_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

on <- on_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ninh Lai" & NAME_2=="Son Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.on=as.numeric(round(prop.on, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.on, area_km, songuoi_km, lng, lat, distm_km)

on_peak <- on_plot %>% filter(NAME_3=="Xa Ninh Lai" & NAME_2=="Son Duong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
on_sf <- dat_sf %>% mutate(prop.on=(sum(subset(., Ho=="Ôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ôn")
on_plot <- on_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.on, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=on_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=on_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(on_plot$prop.on[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ôn")
```



```{r, lazy = TRUE}
on_sff <- dat_sff %>% mutate(prop.on=(sum(subset(., Ho=="Ôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ôn")
on_plotf <- on_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.on, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=on_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(on_plotf$prop.on[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ôn")
```

## Ông

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ong_sff <- dat_sff %>% mutate(prop.ong=(sum(subset(., Ho=="Ông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ông")
ong_plot <- ong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ong_plot$centroid <- sf::st_transform(ong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ong <- ong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Thuy" & NAME_2=="Yen Dung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ong=as.numeric(round(prop.ong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ong, area_km, songuoi_km, lng, lat, distm_km)

ong_peak <- ong_plot %>% filter(NAME_3=="Xa Canh Thuy" & NAME_2=="Yen Dung")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ong_sf <- dat_sf %>% mutate(prop.ong=(sum(subset(., Ho=="Ông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ông")
ong_plot <- ong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ong_plot$prop.ong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ông")
```



```{r, lazy = TRUE}
ong_sff <- dat_sff %>% mutate(prop.ong=(sum(subset(., Ho=="Ông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ông")
ong_plotf <- ong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ong_plotf$prop.ong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ông")
```

## Phạm

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plot <- pham_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.pham, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
pham_plot$centroid <- sf::st_transform(pham_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

pham <- pham_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ba Nam" & NAME_2=="Ba To"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.pham=as.numeric(round(prop.pham, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.pham, area_km, songuoi_km, lng, lat, distm_km)

pham_peak <- pham_plot %>% filter(NAME_3=="Xa Ba Nam" & NAME_2=="Ba To")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plot <- pham_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.pham, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=pham_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=pham_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phạm")
```



```{r, lazy = TRUE}
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plotf <- pham_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.pham, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=pham_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(pham_plotf$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phạm")
```

## Phan

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plot <- phan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phan, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phan_plot$centroid <- sf::st_transform(phan_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phan <- phan_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Bac Trach" & NAME_2=="Bo Trach"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phan=as.numeric(round(prop.phan, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phan, area_km, songuoi_km, lng, lat, distm_km)

phan_peak <- phan_plot %>% filter(NAME_3=="Xa Bac Trach" & NAME_2=="Bo Trach")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plot <- phan_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phan_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phan_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phan_plot$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phan")
```



```{r, lazy = TRUE}
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plotf <- phan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phan_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phan_plotf$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phan")
```

## Phàn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phan1_sff <- dat_sff %>% mutate(prop.phan1=(sum(subset(., Ho=="Phàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phàn")
phan1_plot <- phan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phan1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phan1_plot$centroid <- sf::st_transform(phan1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phan1 <- phan1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Sung Mang" & NAME_2=="Meo Vac"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phan1=as.numeric(round(prop.phan1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phan1, area_km, songuoi_km, lng, lat, distm_km)

phan1_peak <- phan1_plot %>% filter(NAME_3=="Xa Sung Mang" & NAME_2=="Meo Vac")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phan1_sf <- dat_sf %>% mutate(prop.phan1=(sum(subset(., Ho=="Phàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phàn")
phan1_plot <- phan1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phan1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phan1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phan1_plot$prop.phan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phàn")
```



```{r, lazy = TRUE}
phan1_sff <- dat_sff %>% mutate(prop.phan1=(sum(subset(., Ho=="Phàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phàn")
phan1_plotf <- phan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phan1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phan1_plotf$prop.phan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phàn")
```

## Phàng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phang_sff <- dat_sff %>% mutate(prop.phang=(sum(subset(., Ho=="Phàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phàng")
phang_plot <- phang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phang_plot$centroid <- sf::st_transform(phang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phang <- phang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chieng Xuan" & NAME_2=="Van Ho"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phang=as.numeric(round(prop.phang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phang, area_km, songuoi_km, lng, lat, distm_km)

phang_peak <- phang_plot %>% filter(NAME_3=="Xa Chieng Xuan" & NAME_2=="Van Ho")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phang_sf <- dat_sf %>% mutate(prop.phang=(sum(subset(., Ho=="Phàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phàng")
phang_plot <- phang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phang_plot$prop.phang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phàng")
```



```{r, lazy = TRUE}
phang_sff <- dat_sff %>% mutate(prop.phang=(sum(subset(., Ho=="Phàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phàng")
phang_plotf <- phang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phang_plotf$prop.phang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phàng")
```

## Phí

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phi_sff <- dat_sff %>% mutate(prop.phi=(sum(subset(., Ho=="Phí")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phí")
phi_plot <- phi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phi, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phi_plot$centroid <- sf::st_transform(phi_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phi <- phi_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong A" & NAME_2=="Dong Hung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phi=as.numeric(round(prop.phi, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phi, area_km, songuoi_km, lng, lat, distm_km)

phi_peak <- phi_plot %>% filter(NAME_3=="Xa Dong A" & NAME_2=="Dong Hung")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phi_sf <- dat_sf %>% mutate(prop.phi=(sum(subset(., Ho=="Phí")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phí")
phi_plot <- phi_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phi_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phi_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phi_plot$prop.phi[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phí")
```



```{r, lazy = TRUE}
phi_sff <- dat_sff %>% mutate(prop.phi=(sum(subset(., Ho=="Phí")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phí")
phi_plotf <- phi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phi_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phi_plotf$prop.phi[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phí")
```

## Phó

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
pho_sff <- dat_sff %>% mutate(prop.pho=(sum(subset(., Ho=="Phó")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phó")
pho_plot <- pho_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.pho, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
pho_plot$centroid <- sf::st_transform(pho_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

pho <- pho_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Duc" & NAME_2=="Hai Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.pho=as.numeric(round(prop.pho, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.pho, area_km, songuoi_km, lng, lat, distm_km)

pho_peak <- pho_plot %>% filter(NAME_3=="Xa Quang Duc" & NAME_2=="Hai Ha")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
pho_sf <- dat_sf %>% mutate(prop.pho=(sum(subset(., Ho=="Phó")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phó")
pho_plot <- pho_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.pho, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=pho_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=pho_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(pho_plot$prop.pho[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phó")
```



```{r, lazy = TRUE}
pho_sff <- dat_sff %>% mutate(prop.pho=(sum(subset(., Ho=="Phó")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phó")
pho_plotf <- pho_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.pho, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=pho_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(pho_plotf$prop.pho[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phó")
```

## Phù

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phu_sff <- dat_sff %>% mutate(prop.phu=(sum(subset(., Ho=="Phù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phù")
phu_plot <- phu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phu_plot$centroid <- sf::st_transform(phu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phu <- phu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tan Bac" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phu=as.numeric(round(prop.phu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phu, area_km, songuoi_km, lng, lat, distm_km)

phu_peak <- phu_plot %>% filter(NAME_3=="Xa Tan Bac" & NAME_2=="Quang Binh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phu_sf <- dat_sf %>% mutate(prop.phu=(sum(subset(., Ho=="Phù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phù")
phu_plot <- phu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phu_plot$prop.phu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phù")
```



```{r, lazy = TRUE}
phu_sff <- dat_sff %>% mutate(prop.phu=(sum(subset(., Ho=="Phù")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phù")
phu_plotf <- phu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phu_plotf$prop.phu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phù")
```

## Phùng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phung, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phung_plot$centroid <- sf::st_transform(phung_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phung <- phung_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phung=as.numeric(round(prop.phung, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phung, area_km, songuoi_km, lng, lat, distm_km)

phung_peak <- phung_plot %>% filter(NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phung_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phung_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phùng")
```



```{r, lazy = TRUE}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plotf <- phung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phung_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phung_plotf$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phùng")
```

## Phương

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phuong_sff <- dat_sff %>% mutate(prop.phuong=(sum(subset(., Ho=="Phương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phương")
phuong_plot <- phuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phuong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phuong_plot$centroid <- sf::st_transform(phuong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phuong <- phuong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ho Thau" & NAME_2=="Hoang Su Phi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phuong=as.numeric(round(prop.phuong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phuong, area_km, songuoi_km, lng, lat, distm_km)

phuong_peak <- phuong_plot %>% filter(NAME_3=="Xa Ho Thau" & NAME_2=="Hoang Su Phi")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
phuong_sf <- dat_sf %>% mutate(prop.phuong=(sum(subset(., Ho=="Phương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phương")
phuong_plot <- phuong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phuong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phuong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phuong_plot$prop.phuong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phương")
```



```{r, lazy = TRUE}
phuong_sff <- dat_sff %>% mutate(prop.phuong=(sum(subset(., Ho=="Phương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phương")
phuong_plotf <- phuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phuong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(phuong_plotf$prop.phuong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Phương")
```

## Puih

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
puih_sff <- dat_sff %>% mutate(prop.puih=(sum(subset(., Ho=="Puih")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Puih")
puih_plot <- puih_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.puih, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
puih_plot$centroid <- sf::st_transform(puih_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

puih <- puih_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ia Grang" & NAME_2=="Ia Grai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.puih=as.numeric(round(prop.puih, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.puih, area_km, songuoi_km, lng, lat, distm_km)

puih_peak <- puih_plot %>% filter(NAME_3=="Xa Ia Grang" & NAME_2=="Ia Grai")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
puih_sf <- dat_sf %>% mutate(prop.puih=(sum(subset(., Ho=="Puih")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Puih")
puih_plot <- puih_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.puih, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=puih_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=puih_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(puih_plot$prop.puih[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Puih")
```



```{r, lazy = TRUE}
puih_sff <- dat_sff %>% mutate(prop.puih=(sum(subset(., Ho=="Puih")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Puih")
puih_plotf <- puih_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.puih, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=puih_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(puih_plotf$prop.puih[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Puih")
```

## Quách

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plot <- quach_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quach, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
quach_plot$centroid <- sf::st_transform(quach_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

quach <- quach_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa My Thanh" & NAME_2=="Lac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.quach=as.numeric(round(prop.quach, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quach, area_km, songuoi_km, lng, lat, distm_km)

quach_peak <- quach_plot %>% filter(NAME_3=="Xa My Thanh" & NAME_2=="Lac Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quach_sf <- dat_sf %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plot <- quach_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.quach, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quach_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=quach_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quach_plot$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quách")
```



```{r, lazy = TRUE}
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plotf <- quach_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.quach, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quach_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quach_plotf$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quách")
```

## Quan

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quan_sff <- dat_sff %>% mutate(prop.quan=(sum(subset(., Ho=="Quan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quan")
quan_plot <- quan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quan, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
quan_plot$centroid <- sf::st_transform(quan_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

quan <- quan_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tan My" & NAME_2=="Chiem Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.quan=as.numeric(round(prop.quan, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quan, area_km, songuoi_km, lng, lat, distm_km)

quan_peak <- quan_plot %>% filter(NAME_3=="Xa Tan My" & NAME_2=="Chiem Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quan_sf <- dat_sf %>% mutate(prop.quan=(sum(subset(., Ho=="Quan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quan")
quan_plot <- quan_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.quan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quan_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=quan_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quan_plot$prop.quan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quan")
```



```{r, lazy = TRUE}
quan_sff <- dat_sff %>% mutate(prop.quan=(sum(subset(., Ho=="Quan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quan")
quan_plotf <- quan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.quan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quan_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quan_plotf$prop.quan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quan")
```

## Quản

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quan1_sff <- dat_sff %>% mutate(prop.quan1=(sum(subset(., Ho=="Quản")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quản")
quan1_plot <- quan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quan1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
quan1_plot$centroid <- sf::st_transform(quan1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

quan1 <- quan1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thieu Hop" & NAME_2=="Thieu Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.quan1=as.numeric(round(prop.quan1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quan1, area_km, songuoi_km, lng, lat, distm_km)

quan1_peak <- quan1_plot %>% filter(NAME_3=="Xa Thieu Hop" & NAME_2=="Thieu Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quan1_sf <- dat_sf %>% mutate(prop.quan1=(sum(subset(., Ho=="Quản")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quản")
quan1_plot <- quan1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.quan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quan1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=quan1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quan1_plot$prop.quan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quản")
```



```{r, lazy = TRUE}
quan1_sff <- dat_sff %>% mutate(prop.quan1=(sum(subset(., Ho=="Quản")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quản")
quan1_plotf <- quan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.quan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quan1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quan1_plotf$prop.quan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quản")
```

## Quang

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quang_sff <- dat_sff %>% mutate(prop.quang=(sum(subset(., Ho=="Quang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quang")
quang_plot <- quang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
quang_plot$centroid <- sf::st_transform(quang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

quang <- quang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dien Lam" & NAME_2=="Quy Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.quang=as.numeric(round(prop.quang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quang, area_km, songuoi_km, lng, lat, distm_km)

quang_peak <- quang_plot %>% filter(NAME_3=="Xa Dien Lam" & NAME_2=="Quy Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quang_sf <- dat_sf %>% mutate(prop.quang=(sum(subset(., Ho=="Quang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quang")
quang_plot <- quang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.quang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=quang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quang_plot$prop.quang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quang")
```



```{r, lazy = TRUE}
quang_sff <- dat_sff %>% mutate(prop.quang=(sum(subset(., Ho=="Quang")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quang")
quang_plotf <- quang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.quang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quang_plotf$prop.quang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quang")
```

## Quàng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quang1_sff <- dat_sff %>% mutate(prop.quang1=(sum(subset(., Ho=="Quàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quàng")
quang1_plot <- quang1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quang1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
quang1_plot$centroid <- sf::st_transform(quang1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

quang1 <- quang1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Sap Vat" & NAME_2=="Yen Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.quang1=as.numeric(round(prop.quang1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.quang1, area_km, songuoi_km, lng, lat, distm_km)

quang1_peak <- quang1_plot %>% filter(NAME_3=="Xa Sap Vat" & NAME_2=="Yen Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
quang1_sf <- dat_sf %>% mutate(prop.quang1=(sum(subset(., Ho=="Quàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quàng")
quang1_plot <- quang1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.quang1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quang1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=quang1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quang1_plot$prop.quang1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quàng")
```



```{r, lazy = TRUE}
quang1_sff <- dat_sff %>% mutate(prop.quang1=(sum(subset(., Ho=="Quàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quàng")
quang1_plotf <- quang1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.quang1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=quang1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(quang1_plotf$prop.quang1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Quàng")
```

## Rah

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
rah_sff <- dat_sff %>% mutate(prop.rah=(sum(subset(., Ho=="Rah")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rah")
rah_plot <- rah_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.rah, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
rah_plot$centroid <- sf::st_transform(rah_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

rah <- rah_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ia RSai" & NAME_2=="Krong Pa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.rah=as.numeric(round(prop.rah, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.rah, area_km, songuoi_km, lng, lat, distm_km)

rah_peak <- rah_plot %>% filter(NAME_3=="Xa Ia RSai" & NAME_2=="Krong Pa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
rah_sf <- dat_sf %>% mutate(prop.rah=(sum(subset(., Ho=="Rah")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rah")
rah_plot <- rah_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.rah, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=rah_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=rah_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(rah_plot$prop.rah[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Rah")
```



```{r, lazy = TRUE}
rah_sff <- dat_sff %>% mutate(prop.rah=(sum(subset(., Ho=="Rah")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rah")
rah_plotf <- rah_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.rah, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=rah_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(rah_plotf$prop.rah[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Rah")
```

## Rmah

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
rmah_sff <- dat_sff %>% mutate(prop.rmah=(sum(subset(., Ho=="Rmah")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rmah")
rmah_plot <- rmah_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.rmah, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
rmah_plot$centroid <- sf::st_transform(rmah_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

rmah <- rmah_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chu Don" & NAME_2=="Chu Puh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.rmah=as.numeric(round(prop.rmah, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.rmah, area_km, songuoi_km, lng, lat, distm_km)

rmah_peak <- rmah_plot %>% filter(NAME_3=="Xa Chu Don" & NAME_2=="Chu Puh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
rmah_sf <- dat_sf %>% mutate(prop.rmah=(sum(subset(., Ho=="Rmah")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rmah")
rmah_plot <- rmah_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.rmah, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=rmah_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=rmah_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(rmah_plot$prop.rmah[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Rmah")
```



```{r, lazy = TRUE}
rmah_sff <- dat_sff %>% mutate(prop.rmah=(sum(subset(., Ho=="Rmah")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rmah")
rmah_plotf <- rmah_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.rmah, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=rmah_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(rmah_plotf$prop.rmah[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Rmah")
```

## Rơ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ro_sff <- dat_sff %>% mutate(prop.ro=(sum(subset(., Ho=="Rơ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rơ")
ro_plot <- ro_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ro, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ro_plot$centroid <- sf::st_transform(ro_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ro <- ro_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ia Phi" & NAME_2=="Chu Pah"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ro=as.numeric(round(prop.ro, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ro, area_km, songuoi_km, lng, lat, distm_km)

ro_peak <- ro_plot %>% filter(NAME_3=="Xa Ia Phi" & NAME_2=="Chu Pah")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ro_sf <- dat_sf %>% mutate(prop.ro=(sum(subset(., Ho=="Rơ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rơ")
ro_plot <- ro_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ro, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ro_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ro_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ro_plot$prop.ro[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Rơ")
```



```{r, lazy = TRUE}
ro_sff <- dat_sff %>% mutate(prop.ro=(sum(subset(., Ho=="Rơ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Rơ")
ro_plotf <- ro_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ro, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ro_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ro_plotf$prop.ro[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Rơ")
```

## Sa

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
sa_sff <- dat_sff %>% mutate(prop.sa=(sum(subset(., Ho=="Sa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sa")
sa_plot <- sa_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.sa, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
sa_plot$centroid <- sf::st_transform(sa_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

sa <- sa_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Huy Ha" & NAME_2=="Phu Yen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.sa=as.numeric(round(prop.sa, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.sa, area_km, songuoi_km, lng, lat, distm_km)

sa_peak <- sa_plot %>% filter(NAME_3=="Xa Huy Ha" & NAME_2=="Phu Yen")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
sa_sf <- dat_sf %>% mutate(prop.sa=(sum(subset(., Ho=="Sa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sa")
sa_plot <- sa_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.sa, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=sa_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=sa_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(sa_plot$prop.sa[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sa")
```



```{r, lazy = TRUE}
sa_sff <- dat_sff %>% mutate(prop.sa=(sum(subset(., Ho=="Sa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sa")
sa_plotf <- sa_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.sa, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=sa_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(sa_plotf$prop.sa[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sa")
```

## Sầm

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
sam_sff <- dat_sff %>% mutate(prop.sam=(sum(subset(., Ho=="Sầm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sầm")
sam_plot <- sam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.sam, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
sam_plot$centroid <- sf::st_transform(sam_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

sam <- sam_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chau Loc" & NAME_2=="Quy Hop"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.sam=as.numeric(round(prop.sam, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.sam, area_km, songuoi_km, lng, lat, distm_km)

sam_peak <- sam_plot %>% filter(NAME_3=="Xa Chau Loc" & NAME_2=="Quy Hop")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
sam_sf <- dat_sf %>% mutate(prop.sam=(sum(subset(., Ho=="Sầm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sầm")
sam_plot <- sam_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.sam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=sam_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=sam_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(sam_plot$prop.sam[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sầm")
```



```{r, lazy = TRUE}
sam_sff <- dat_sff %>% mutate(prop.sam=(sum(subset(., Ho=="Sầm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sầm")
sam_plotf <- sam_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.sam, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=sam_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(sam_plotf$prop.sam[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sầm")
```

## Siu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
siu_sff <- dat_sff %>% mutate(prop.siu=(sum(subset(., Ho=="Siu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Siu")
siu_plot <- siu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.siu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
siu_plot$centroid <- sf::st_transform(siu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

siu <- siu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Bar Maih" & NAME_2=="Chu Se"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.siu=as.numeric(round(prop.siu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.siu, area_km, songuoi_km, lng, lat, distm_km)

siu_peak <- siu_plot %>% filter(NAME_3=="Xa Bar Maih" & NAME_2=="Chu Se")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
siu_sf <- dat_sf %>% mutate(prop.siu=(sum(subset(., Ho=="Siu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Siu")
siu_plot <- siu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.siu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=siu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=siu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(siu_plot$prop.siu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Siu")
```



```{r, lazy = TRUE}
siu_sff <- dat_sff %>% mutate(prop.siu=(sum(subset(., Ho=="Siu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Siu")
siu_plotf <- siu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.siu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=siu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(siu_plotf$prop.siu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Siu")
```

## Sơn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
son_sff <- dat_sff %>% mutate(prop.son=(sum(subset(., Ho=="Sơn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sơn")
son_plot <- son_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.son, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
son_plot$centroid <- sf::st_transform(son_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

son <- son_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tan" & NAME_2=="Vinh Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.son=as.numeric(round(prop.son, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.son, area_km, songuoi_km, lng, lat, distm_km)

son_peak <- son_plot %>% filter(NAME_3=="Xa Vinh Tan" & NAME_2=="Vinh Chau")

```




```{r, warning=FALSE, message=FALSE, lazy = TRUE}
son_sf <- dat_sf %>% mutate(prop.son=(sum(subset(., Ho=="Sơn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sơn")
son_plot <- son_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.son, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=son_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=son_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(son_plot$prop.son[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sơn")
```



```{r, lazy = TRUE}
son_sff <- dat_sff %>% mutate(prop.son=(sum(subset(., Ho=="Sơn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sơn")
son_plotf <- son_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.son, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=son_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(son_plotf$prop.son[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sơn")
```

## Sồng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
song_sff <- dat_sff %>% mutate(prop.song=(sum(subset(., Ho=="Sồng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sồng")
song_plot <- song_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.song, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
song_plot$centroid <- sf::st_transform(song_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

song <- song_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Suoi To" & NAME_2=="Phu Yen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.song=as.numeric(round(prop.song, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.song, area_km, songuoi_km, lng, lat, distm_km)

song_peak <- song_plot %>% filter(NAME_3=="Xa Suoi To" & NAME_2=="Phu Yen")

```




```{r, warning=FALSE, message=FALSE, lazy = TRUE}
song_sf <- dat_sf %>% mutate(prop.song=(sum(subset(., Ho=="Sồng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sồng")
song_plot <- song_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.song, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=song_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=song_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(song_plot$prop.song[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sồng")
```



```{r, lazy = TRUE}
song_sff <- dat_sff %>% mutate(prop.song=(sum(subset(., Ho=="Sồng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sồng")
song_plotf <- song_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.song, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=song_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(song_plotf$prop.song[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sồng")
```

## Sử

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
su_sff <- dat_sff %>% mutate(prop.su=(sum(subset(., Ho=="Sử")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sử")
su_plot <- su_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.su, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
su_plot$centroid <- sf::st_transform(su_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

su <- su_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Duc Thuan" & NAME_2=="Hong Linh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.su=as.numeric(round(prop.su, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.su, area_km, songuoi_km, lng, lat, distm_km)

su_peak <- su_plot %>% filter(NAME_3=="Phuong Duc Thuan" & NAME_2=="Hong Linh")

```




```{r, warning=FALSE, message=FALSE, lazy = TRUE}
su_sf <- dat_sf %>% mutate(prop.su=(sum(subset(., Ho=="Sử")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sử")
su_plot <- su_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.su, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=su_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=su_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(su_plot$prop.su[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sử")
```



```{r, lazy = TRUE}
su_sff <- dat_sff %>% mutate(prop.su=(sum(subset(., Ho=="Sử")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sử")
su_plotf <- su_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.su, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=su_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(su_plotf$prop.su[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sử")
```

## Sùng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
sung_sff <- dat_sff %>% mutate(prop.sung=(sum(subset(., Ho=="Sùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sùng")
sung_plot <- sung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.sung, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
sung_plot$centroid <- sf::st_transform(sung_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

sung <- sung_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Che Tao" & NAME_2=="Mu Cang Chai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.sung=as.numeric(round(prop.sung, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.sung, area_km, songuoi_km, lng, lat, distm_km)

sung_peak <- sung_plot %>% filter(NAME_3=="Xa Che Tao" & NAME_2=="Mu Cang Chai")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
sung_sf <- dat_sf %>% mutate(prop.sung=(sum(subset(., Ho=="Sùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sùng")
sung_plot <- sung_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.sung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=sung_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=sung_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(sung_plot$prop.sung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sùng")
```



```{r, lazy = TRUE}
sung_sff <- dat_sff %>% mutate(prop.sung=(sum(subset(., Ho=="Sùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sùng")
sung_plotf <- sung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.sung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=sung_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(sung_plotf$prop.sung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Sùng")
```

## Tạ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ta_sff <- dat_sff %>% mutate(prop.ta=(sum(subset(., Ho=="Tạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tạ")
ta_plot <- ta_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ta, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ta_plot$centroid <- sf::st_transform(ta_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ta <- ta_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Di Nau" & NAME_2=="Tam Nong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ta=as.numeric(round(prop.ta, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ta, area_km, songuoi_km, lng, lat, distm_km)

ta_peak <- ta_plot %>% filter(NAME_3=="Xa Di Nau" & NAME_2=="Tam Nong")

```




```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ta_sf <- dat_sf %>% mutate(prop.ta=(sum(subset(., Ho=="Tạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tạ")
ta_plot <- ta_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ta, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ta_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ta_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ta_plot$prop.ta[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tạ")
```



```{r, lazy = TRUE}
ta_sff <- dat_sff %>% mutate(prop.ta=(sum(subset(., Ho=="Tạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tạ")
ta_plotf <- ta_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ta, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ta_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ta_plotf$prop.ta[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tạ")
```

## Tần

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tan_sff <- dat_sff %>% mutate(prop.tan=(sum(subset(., Ho=="Tần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tần")
tan_plot <- tan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tan, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tan_plot$centroid <- sf::st_transform(tan_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tan <- tan_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Van" & NAME_2=="Binh Lieu"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tan=as.numeric(round(prop.tan, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tan, area_km, songuoi_km, lng, lat, distm_km)

tan_peak <- tan_plot %>% filter(NAME_3=="Xa Dong Van" & NAME_2=="Binh Lieu")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tan_sf <- dat_sf %>% mutate(prop.tan=(sum(subset(., Ho=="Tần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tần")
tan_plot <- tan_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tan_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tan_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tan_plot$prop.tan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tần")
```



```{r, lazy = TRUE}
tan_sff <- dat_sff %>% mutate(prop.tan=(sum(subset(., Ho=="Tần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tần")
tan_plotf <- tan_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tan, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tan_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tan_plotf$prop.tan[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tần")
```

## Tẩn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tan1_sff <- dat_sff %>% mutate(prop.tan1=(sum(subset(., Ho=="Tẩn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tẩn")
tan1_plot <- tan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tan1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tan1_plot$centroid <- sf::st_transform(tan1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tan1 <- tan1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Si Lo Lau" & NAME_2=="Phong Tho"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tan1=as.numeric(round(prop.tan1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tan1, area_km, songuoi_km, lng, lat, distm_km)

tan1_peak <- tan1_plot %>% filter(NAME_3=="Xa Si Lo Lau" & NAME_2=="Phong Tho")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tan1_sf <- dat_sf %>% mutate(prop.tan1=(sum(subset(., Ho=="Tẩn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tẩn")
tan1_plot <- tan1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tan1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tan1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tan1_plot$prop.tan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tẩn")
```



```{r, lazy = TRUE}
tan1_sff <- dat_sff %>% mutate(prop.tan1=(sum(subset(., Ho=="Tẩn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tẩn")
tan1_plotf <- tan1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tan1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tan1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tan1_plotf$prop.tan1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tẩn")
```

## Tăng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tang_sff <- dat_sff %>% mutate(prop.tang=(sum(subset(., Ho=="Tăng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tăng")
tang_plot <- tang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tang_plot$centroid <- sf::st_transform(tang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tang <- tang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thanh Lang" & NAME_2=="Thanh Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tang=as.numeric(round(prop.tang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tang, area_km, songuoi_km, lng, lat, distm_km)

tang_peak <- tang_plot %>% filter(NAME_3=="Xa Thanh Lang" & NAME_2=="Thanh Ha")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tang_sf <- dat_sf %>% mutate(prop.tang=(sum(subset(., Ho=="Tăng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tăng")
tang_plot <- tang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tang_plot$prop.tang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tăng")
```



```{r, lazy = TRUE}
tang_sff <- dat_sff %>% mutate(prop.tang=(sum(subset(., Ho=="Tăng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tăng")
tang_plotf <- tang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tang_plotf$prop.tang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tăng")
```

## Tào

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tao_sff <- dat_sff %>% mutate(prop.tao=(sum(subset(., Ho=="Tào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tào")
tao_plot <- tao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tao, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tao_plot$centroid <- sf::st_transform(tao_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tao <- tao_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Hon" & NAME_2=="Tam Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tao=as.numeric(round(prop.tao, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tao, area_km, songuoi_km, lng, lat, distm_km)

tao_peak <- tao_plot %>% filter(NAME_3=="Xa Ban Hon" & NAME_2=="Tam Duong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tao_sf <- dat_sf %>% mutate(prop.tao=(sum(subset(., Ho=="Tào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tào")
tao_plot <- tao_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tao_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tao_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tao_plot$prop.tao[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tào")
```



```{r, lazy = TRUE}
tao_sff <- dat_sff %>% mutate(prop.tao=(sum(subset(., Ho=="Tào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tào")
tao_plotf <- tao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tao_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tao_plotf$prop.tao[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tào")
```

## Thạch

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thach_sff <- dat_sff %>% mutate(prop.thach=(sum(subset(., Ho=="Thạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thạch")
thach_plot <- thach_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thach, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
thach_plot$centroid <- sf::st_transform(thach_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

thach <- thach_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chau Dien" & NAME_2=="Cau Ke"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.thach=as.numeric(round(prop.thach, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thach, area_km, songuoi_km, lng, lat, distm_km)

thach_peak <- thach_plot %>% filter(NAME_3=="Xa Chau Dien" & NAME_2=="Cau Ke")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thach_sf <- dat_sf %>% mutate(prop.thach=(sum(subset(., Ho=="Thạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thạch")
thach_plot <- thach_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.thach, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thach_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=thach_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thach_plot$prop.thach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thạch")
```



```{r, lazy = TRUE}
thach_sff <- dat_sff %>% mutate(prop.thach=(sum(subset(., Ho=="Thạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thạch")
thach_plotf <- thach_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.thach, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thach_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thach_plotf$prop.thach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thạch")
```

## Thái

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thai_sff <- dat_sff %>% mutate(prop.thai=(sum(subset(., Ho=="Thái")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thái")
thai_plot <- thai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thai, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
thai_plot$centroid <- sf::st_transform(thai_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

thai <- thai_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Son" & NAME_2=="Do Luong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.thai=as.numeric(round(prop.thai, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thai, area_km, songuoi_km, lng, lat, distm_km)

thai_peak <- thai_plot %>% filter(NAME_3=="Xa Hoa Son" & NAME_2=="Do Luong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thai_sf <- dat_sf %>% mutate(prop.thai=(sum(subset(., Ho=="Thái")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thái")
thai_plot <- thai_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.thai, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thai_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=thai_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thai_plot$prop.thai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thái")
```



```{r, lazy = TRUE}
thai_sff <- dat_sff %>% mutate(prop.thai=(sum(subset(., Ho=="Thái")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thái")
thai_plotf <- thai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.thai, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thai_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thai_plotf$prop.thai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thái")
```

## Thân

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
than_sff <- dat_sff %>% mutate(prop.than=(sum(subset(., Ho=="Thân")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thân")
than_plot <- than_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.than, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
than_plot$centroid <- sf::st_transform(than_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

than <- than_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hong Thai" & NAME_2=="Viet Yen"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.than=as.numeric(round(prop.than, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.than, area_km, songuoi_km, lng, lat, distm_km)

than_peak <- than_plot %>% filter(NAME_3=="Xa Hong Thai" & NAME_2=="Viet Yen")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
than_sf <- dat_sf %>% mutate(prop.than=(sum(subset(., Ho=="Thân")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thân")
than_plot <- than_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.than, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=than_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=than_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(than_plot$prop.than[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thân")
```



```{r, lazy = TRUE}
than_sff <- dat_sff %>% mutate(prop.than=(sum(subset(., Ho=="Thân")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thân")
than_plotf <- than_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.than, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=than_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(than_plotf$prop.than[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thân")
```

## Thào

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thao_sff <- dat_sff %>% mutate(prop.thao=(sum(subset(., Ho=="Thào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thào")
thao_plot <- thao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thao, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
thao_plot$centroid <- sf::st_transform(thao_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

thao <- thao_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Pa Lau" & NAME_2=="Tram Tau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.thao=as.numeric(round(prop.thao, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thao, area_km, songuoi_km, lng, lat, distm_km)

thao_peak <- thao_plot %>% filter(NAME_3=="Xa Pa Lau" & NAME_2=="Tram Tau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thao_sf <- dat_sf %>% mutate(prop.thao=(sum(subset(., Ho=="Thào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thào")
thao_plot <- thao_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.thao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thao_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=thao_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thao_plot$prop.thao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thào")
```



```{r, lazy = TRUE}
thao_sff <- dat_sff %>% mutate(prop.thao=(sum(subset(., Ho=="Thào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thào")
thao_plotf <- thao_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.thao, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thao_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thao_plotf$prop.thao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thào")
```

## Thèn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
then_sff <- dat_sff %>% mutate(prop.then=(sum(subset(., Ho=="Thèn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thèn")
then_plot <- then_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.then, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
then_plot$centroid <- sf::st_transform(then_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

then <- then_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Nhung" & NAME_2=="Hoang Su Phi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.then=as.numeric(round(prop.then, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.then, area_km, songuoi_km, lng, lat, distm_km)

then_peak <- then_plot %>% filter(NAME_3=="Xa Ban Nhung" & NAME_2=="Hoang Su Phi")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
then_sf <- dat_sf %>% mutate(prop.then=(sum(subset(., Ho=="Thèn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thèn")
then_plot <- then_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.then, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=then_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=then_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(then_plot$prop.then[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thèn")
```



```{r, lazy = TRUE}
then_sff <- dat_sff %>% mutate(prop.then=(sum(subset(., Ho=="Thèn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thèn")
then_plotf <- then_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.then, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=then_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(then_plotf$prop.then[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thèn")
```

## Thi

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thi_sff <- dat_sff %>% mutate(prop.thi=(sum(subset(., Ho=="Thi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thi")
thi_plot <- thi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thi, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
thi_plot$centroid <- sf::st_transform(thi_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

thi <- thi_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Xuan Le" & NAME_2=="Loc Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.thi=as.numeric(round(prop.thi, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thi, area_km, songuoi_km, lng, lat, distm_km)

thi_peak <- thi_plot %>% filter(NAME_3=="Xa Xuan Le" & NAME_2=="Loc Binh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thi_sf <- dat_sf %>% mutate(prop.thi=(sum(subset(., Ho=="Thi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thi")
thi_plot <- thi_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.thi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thi_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=thi_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thi_plot$prop.thi[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thi")
```



```{r, lazy = TRUE}
thi_sff <- dat_sff %>% mutate(prop.thi=(sum(subset(., Ho=="Thi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thi")
thi_plotf <- thi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.thi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thi_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thi_plotf$prop.thi[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thi")
```

## Thị

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thi1_sff <- dat_sff %>% mutate(prop.thi1=(sum(subset(., Ho=="Thị")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thị")
thi1_plot <- thi1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thi1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
thi1_plot$centroid <- sf::st_transform(thi1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

thi1 <- thi1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cam Thinh Tay" & NAME_2=="Cam Ranh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.thi1=as.numeric(round(prop.thi1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thi1, area_km, songuoi_km, lng, lat, distm_km)

thi1_peak <- thi1_plot %>% filter(NAME_3=="Xa Cam Thinh Tay" & NAME_2=="Cam Ranh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thi1_sf <- dat_sf %>% mutate(prop.thi1=(sum(subset(., Ho=="Thị")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thị")
thi1_plot <- thi1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.thi1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thi1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=thi1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thi1_plot$prop.thi1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thị")
```



```{r, lazy = TRUE}
thi1_sff <- dat_sff %>% mutate(prop.thi1=(sum(subset(., Ho=="Thị")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thị")
thi1_plotf <- thi1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.thi1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thi1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thi1_plotf$prop.thi1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thị")
```

## Thiều

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thieu_sff <- dat_sff %>% mutate(prop.thieu=(sum(subset(., Ho=="Thiều")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thiều")
thieu_plot <- thieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thieu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
thieu_plot$centroid <- sf::st_transform(thieu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

thieu <- thieu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Tien" & NAME_2=="Dong Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.thieu=as.numeric(round(prop.thieu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.thieu, area_km, songuoi_km, lng, lat, distm_km)

thieu_peak <- thieu_plot %>% filter(NAME_3=="Xa Dong Tien" & NAME_2=="Dong Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
thieu_sf <- dat_sf %>% mutate(prop.thieu=(sum(subset(., Ho=="Thiều")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thiều")
thieu_plot <- thieu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.thieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thieu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=thieu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thieu_plot$prop.thieu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thiều")
```



```{r, lazy = TRUE}
thieu_sff <- dat_sff %>% mutate(prop.thieu=(sum(subset(., Ho=="Thiều")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thiều")
thieu_plotf <- thieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.thieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=thieu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(thieu_plotf$prop.thieu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thiều")
```

## Thò

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tho_sff <- dat_sff %>% mutate(prop.tho=(sum(subset(., Ho=="Thò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thò")
tho_plot <- tho_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tho, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tho_plot$centroid <- sf::st_transform(tho_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tho <- tho_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Sung Trai" & NAME_2=="Dong Van"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tho=as.numeric(round(prop.tho, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tho, area_km, songuoi_km, lng, lat, distm_km)

tho_peak <- tho_plot %>% filter(NAME_3=="Xa Sung Trai" & NAME_2=="Dong Van")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tho_sf <- dat_sf %>% mutate(prop.tho=(sum(subset(., Ho=="Thò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thò")
tho_plot <- tho_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tho, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tho_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tho_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tho_plot$prop.tho[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thò")
```



```{r, lazy = TRUE}
tho_sff <- dat_sff %>% mutate(prop.tho=(sum(subset(., Ho=="Thò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thò")
tho_plotf <- tho_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tho, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tho_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tho_plotf$prop.tho[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Thò")
```

## Tiêu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tieu_sff <- dat_sff %>% mutate(prop.tieu=(sum(subset(., Ho=="Tiêu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tiêu")
tieu_plot <- tieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tieu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tieu_plot$centroid <- sf::st_transform(tieu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tieu <- tieu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cam Che" & NAME_2=="Thanh Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tieu=as.numeric(round(prop.tieu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tieu, area_km, songuoi_km, lng, lat, distm_km)

tieu_peak <- tieu_plot %>% filter(NAME_3=="Xa Cam Che" & NAME_2=="Thanh Ha")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tieu_sf <- dat_sf %>% mutate(prop.tieu=(sum(subset(., Ho=="Tiêu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tiêu")
tieu_plot <- tieu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tieu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tieu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tieu_plot$prop.tieu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tiêu")
```



```{r, lazy = TRUE}
tieu_sff <- dat_sff %>% mutate(prop.tieu=(sum(subset(., Ho=="Tiêu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tiêu")
tieu_plotf <- tieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tieu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tieu_plotf$prop.tieu[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tiêu")
```

## Tô

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
to_sff <- dat_sff %>% mutate(prop.to=(sum(subset(., Ho=="Tô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tô")
to_plot <- to_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.to, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
to_plot$centroid <- sf::st_transform(to_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

to <- to_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Thai" & NAME_2=="Quang Xuong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.to=as.numeric(round(prop.to, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.to, area_km, songuoi_km, lng, lat, distm_km)

to_peak <- to_plot %>% filter(NAME_3=="Xa Quang Thai" & NAME_2=="Quang Xuong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
to_sf <- dat_sf %>% mutate(prop.to=(sum(subset(., Ho=="Tô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tô")
to_plot <- to_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.to, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=to_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=to_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(to_plot$prop.to[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tô")
```



```{r, lazy = TRUE}
to_sff <- dat_sff %>% mutate(prop.to=(sum(subset(., Ho=="Tô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tô")
to_plotf <- to_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.to, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=to_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(to_plotf$prop.to[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tô")
```

## Tôn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ton_sff <- dat_sff %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plot <- ton_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ton, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ton_plot$centroid <- sf::st_transform(ton_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ton <- ton_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vuong Loc" & NAME_2=="Can Loc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ton=as.numeric(round(prop.ton, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ton, area_km, songuoi_km, lng, lat, distm_km)

ton_peak <- ton_plot %>% filter(NAME_3=="Xa Vuong Loc" & NAME_2=="Can Loc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ton_sf <- dat_sf %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plot <- ton_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ton, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ton_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ton_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ton_plot$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tôn")
```



```{r, lazy = TRUE}
ton_sff <- dat_sff %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plotf <- ton_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ton, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ton_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ton_plotf$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tôn")
```

## Tòng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tong_sff <- dat_sff %>% mutate(prop.tong=(sum(subset(., Ho=="Tòng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tòng")
tong_plot <- tong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tong_plot$centroid <- sf::st_transform(tong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tong <- tong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dom Cang" & NAME_2=="Sop Cop"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tong=as.numeric(round(prop.tong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tong, area_km, songuoi_km, lng, lat, distm_km)

tong_peak <- tong_plot %>% filter(NAME_3=="Xa Dom Cang" & NAME_2=="Sop Cop")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tong_sf <- dat_sf %>% mutate(prop.tong=(sum(subset(., Ho=="Tòng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tòng")
tong_plot <- tong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tong_plot$prop.tong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tòng")
```



```{r, lazy = TRUE}
tong_sff <- dat_sff %>% mutate(prop.tong=(sum(subset(., Ho=="Tòng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tòng")
tong_plotf <- tong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tong_plotf$prop.tong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tòng")
```

## Tống

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tong1_sff <- dat_sff %>% mutate(prop.tong1=(sum(subset(., Ho=="Tống")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tống")
tong1_plot <- tong1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tong1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tong1_plot$centroid <- sf::st_transform(tong1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tong1 <- tong1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ha Bac" & NAME_2=="Ha Trung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tong1=as.numeric(round(prop.tong1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tong1, area_km, songuoi_km, lng, lat, distm_km)

tong1_peak <- tong1_plot %>% filter(NAME_3=="Xa Ha Bac" & NAME_2=="Ha Trung")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tong1_sf <- dat_sf %>% mutate(prop.tong1=(sum(subset(., Ho=="Tống")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tống")
tong1_plot <- tong1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tong1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tong1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tong1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tong1_plot$prop.tong1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tống")
```



```{r, lazy = TRUE}
tong1_sff <- dat_sff %>% mutate(prop.tong1=(sum(subset(., Ho=="Tống")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tống")
tong1_plotf <- tong1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tong1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tong1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tong1_plotf$prop.tong1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tống")
```

## Trà

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tra_sff <- dat_sff %>% mutate(prop.tra=(sum(subset(., Ho=="Trà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trà")
tra_plot <- tra_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tra, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tra_plot$centroid <- sf::st_transform(tra_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tra <- tra_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Binh Dinh Bac" & NAME_2=="Thang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tra=as.numeric(round(prop.tra, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tra, area_km, songuoi_km, lng, lat, distm_km)

tra_peak <- tra_plot %>% filter(NAME_3=="Xa Binh Dinh Bac" & NAME_2=="Thang Binh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tra_sf <- dat_sf %>% mutate(prop.tra=(sum(subset(., Ho=="Trà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trà")
tra_plot <- tra_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tra, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tra_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tra_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tra_plot$prop.tra[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trà")
```



```{r, lazy = TRUE}
tra_sff <- dat_sff %>% mutate(prop.tra=(sum(subset(., Ho=="Trà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trà")
tra_plotf <- tra_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tra, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tra_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tra_plotf$prop.tra[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trà")
```

## Trần

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tran, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tran_plot$centroid <- sf::st_transform(tran_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tran <- tran_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tran=as.numeric(round(prop.tran, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tran, area_km, songuoi_km, lng, lat, distm_km)

tran_peak <- tran_plot %>% filter(NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tran_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tran_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trần")
```



```{r, lazy = TRUE}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plotf <- tran_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tran, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tran_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tran_plotf$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trần")
```

## Tráng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trang_sff <- dat_sff %>% mutate(prop.trang=(sum(subset(., Ho=="Tráng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tráng")
trang_plot <- trang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
trang_plot$centroid <- sf::st_transform(trang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

trang <- trang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ta Van Chu" & NAME_2=="Bac Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.trang=as.numeric(round(prop.trang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trang, area_km, songuoi_km, lng, lat, distm_km)

trang_peak <- trang_plot %>% filter(NAME_3=="Xa Ta Van Chu" & NAME_2=="Bac Ha")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trang_sf <- dat_sf %>% mutate(prop.trang=(sum(subset(., Ho=="Tráng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tráng")
trang_plot <- trang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.trang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=trang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trang_plot$prop.trang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tráng")
```



```{r, lazy = TRUE}
trang_sff <- dat_sff %>% mutate(prop.trang=(sum(subset(., Ho=="Tráng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tráng")
trang_plotf <- trang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.trang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trang_plotf$prop.trang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tráng")
```

## Triệu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trieu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
trieu_plot$centroid <- sf::st_transform(trieu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

trieu <- trieu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.trieu=as.numeric(round(prop.trieu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trieu, area_km, songuoi_km, lng, lat, distm_km)

trieu_peak <- trieu_plot %>% filter(NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trieu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=trieu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Triệu")
```



```{r, lazy = TRUE}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plotf <- trieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.trieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trieu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trieu_plotf$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Triệu")
```

## Trinh

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trinh")
trinh_plot <- trinh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trinh, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
trinh_plot$centroid <- sf::st_transform(trinh_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

trinh <- trinh_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Nga Van" & NAME_2=="Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.trinh=as.numeric(round(prop.trinh, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trinh, area_km, songuoi_km, lng, lat, distm_km)

trinh_peak <- trinh_plot %>% filter(NAME_3=="Xa Nga Van" & NAME_2=="Nga Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trinh")
trinh_plot <- trinh_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.trinh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trinh_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=trinh_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trinh_plot$prop.trinh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trinh")
```



```{r, lazy = TRUE}
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trinh")
trinh_plotf <- trinh_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.trinh, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trinh_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trinh_plotf$prop.trinh[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trinh")
```

## Trình

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trinh1_sff <- dat_sff %>% mutate(prop.trinh1=(sum(subset(., Ho=="Trình")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trình")
trinh1_plot <- trinh1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trinh1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
trinh1_plot$centroid <- sf::st_transform(trinh1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

trinh1 <- trinh1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Lam Loi" & NAME_2=="Ha Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.trinh1=as.numeric(round(prop.trinh1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trinh1, area_km, songuoi_km, lng, lat, distm_km)

trinh1_peak <- trinh1_plot %>% filter(NAME_3=="Xa Lam Loi" & NAME_2=="Ha Hoa")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trinh1_sf <- dat_sf %>% mutate(prop.trinh1=(sum(subset(., Ho=="Trình")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trình")
trinh1_plot <- trinh1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.trinh1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trinh1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=trinh1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trinh1_plot$prop.trinh1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trình")
```



```{r, lazy = TRUE}
trinh1_sff <- dat_sff %>% mutate(prop.trinh1=(sum(subset(., Ho=="Trình")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trình")
trinh1_plotf <- trinh1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.trinh1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trinh1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trinh1_plotf$prop.trinh1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trình")
```

## Trịnh

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trinh2_sff <- dat_sff %>% mutate(prop.trinh2=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh2_plot <- trinh2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trinh2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
trinh2_plot$centroid <- sf::st_transform(trinh2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

trinh2 <- trinh2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tho Truong" & NAME_2=="Tho Xuan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.trinh2=as.numeric(round(prop.trinh2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trinh2, area_km, songuoi_km, lng, lat, distm_km)

trinh2_peak <- trinh2_plot %>% filter(NAME_3=="Xa Tho Truong" & NAME_2=="Tho Xuan")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trinh2_sf <- dat_sf %>% mutate(prop.trinh2=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh2_plot <- trinh2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.trinh2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trinh2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=trinh2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trinh2_plot$prop.trinh2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trịnh")
```



```{r, lazy = TRUE}
trinh2_sff <- dat_sff %>% mutate(prop.trinh2=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh2_plotf <- trinh2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.trinh2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trinh2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(trinh2_plotf$prop.trinh2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trịnh")
```

## Trương

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plot <- truong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.truong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
truong_plot$centroid <- sf::st_transform(truong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

truong <- truong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ha Trung" & NAME_2=="Ba Thuoc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.truong=as.numeric(round(prop.truong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.truong, area_km, songuoi_km, lng, lat, distm_km)

truong_peak <- truong_plot %>% filter(NAME_3=="Xa Ha Trung" & NAME_2=="Ba Thuoc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plot <- truong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.truong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=truong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=truong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(truong_plot$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trương")
```



```{r, lazy = TRUE}
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plotf <- truong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.truong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=truong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(truong_plotf$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Trương")
```

## Từ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tu_sff <- dat_sff %>% mutate(prop.tu=(sum(subset(., Ho=="Từ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Từ")
tu_plot <- tu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tu_plot$centroid <- sf::st_transform(tu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tu <- tu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Kim" & NAME_2=="Quang Trach"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tu=as.numeric(round(prop.tu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tu, area_km, songuoi_km, lng, lat, distm_km)

tu_peak <- tu_plot %>% filter(NAME_3=="Xa Quang Kim" & NAME_2=="Quang Trach")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tu_sf <- dat_sf %>% mutate(prop.tu=(sum(subset(., Ho=="Từ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Từ")
tu_plot <- tu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tu_plot$prop.tu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Từ")
```



```{r, lazy = TRUE}
tu_sff <- dat_sff %>% mutate(prop.tu=(sum(subset(., Ho=="Từ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Từ")
tu_plotf <- tu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tu_plotf$prop.tu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Từ")
```

## Tưởng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tuong_sff <- dat_sff %>% mutate(prop.tuong=(sum(subset(., Ho=="Tưởng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tưởng")
tuong_plot <- tuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tuong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tuong_plot$centroid <- sf::st_transform(tuong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tuong <- tuong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Tung" & NAME_2=="Quang Trach"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tuong=as.numeric(round(prop.tuong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tuong, area_km, songuoi_km, lng, lat, distm_km)

tuong_peak <- tuong_plot %>% filter(NAME_3=="Xa Quang Tung" & NAME_2=="Quang Trach")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tuong_sf <- dat_sf %>% mutate(prop.tuong=(sum(subset(., Ho=="Tưởng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tưởng")
tuong_plot <- tuong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tuong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tuong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tuong_plot$prop.tuong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tưởng")
```



```{r, lazy = TRUE}
tuong_sff <- dat_sff %>% mutate(prop.tuong=(sum(subset(., Ho=="Tưởng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tưởng")
tuong_plotf <- tuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tuong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(tuong_plotf$prop.tuong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Tưởng")
```

## Ung

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ung_sff <- dat_sff %>% mutate(prop.ung=(sum(subset(., Ho=="Ung")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ung")
ung_plot <- ung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ung, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ung_plot$centroid <- sf::st_transform(ung_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ung <- ung_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Nhi Son" & NAME_2=="Muong Lat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ung=as.numeric(round(prop.ung, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ung, area_km, songuoi_km, lng, lat, distm_km)

ung_peak <- ung_plot %>% filter(NAME_3=="Xa Nhi Son" & NAME_2=="Muong Lat")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ung_sf <- dat_sf %>% mutate(prop.ung=(sum(subset(., Ho=="Ung")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ung")
ung_plot <- ung_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ung_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ung_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ung_plot$prop.ung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ung")
```



```{r, lazy = TRUE}
ung_sff <- dat_sff %>% mutate(prop.ung=(sum(subset(., Ho=="Ung")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ung")
ung_plotf <- ung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ung_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ung_plotf$prop.ung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ung")
```

## Uông

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
uong_sff <- dat_sff %>% mutate(prop.uong=(sum(subset(., Ho=="Uông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Uông")
uong_plot <- uong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.uong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
uong_plot$centroid <- sf::st_transform(uong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

uong <- uong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Son Phuc" & NAME_2=="Huong Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.uong=as.numeric(round(prop.uong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.uong, area_km, songuoi_km, lng, lat, distm_km)

uong_peak <- uong_plot %>% filter(NAME_3=="Xa Son Phuc" & NAME_2=="Huong Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
uong_sf <- dat_sf %>% mutate(prop.uong=(sum(subset(., Ho=="Uông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Uông")
uong_plot <- uong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.uong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=uong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=uong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(uong_plot$prop.uong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Uông")
```



```{r, lazy = TRUE}
uong_sff <- dat_sff %>% mutate(prop.uong=(sum(subset(., Ho=="Uông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Uông")
uong_plotf <- uong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.uong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=uong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(uong_plotf$prop.uong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Uông")
```

## Và

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
va_sff <- dat_sff %>% mutate(prop.va=(sum(subset(., Ho=="Và")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Và")
va_plot <- va_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.va, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
va_plot$centroid <- sf::st_transform(va_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

va <- va_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Na U" & NAME_2=="Dien Bien"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.va=as.numeric(round(prop.va, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.va, area_km, songuoi_km, lng, lat, distm_km)

va_peak <- va_plot %>% filter(NAME_3=="Xa Na U" & NAME_2=="Dien Bien")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
va_sf <- dat_sf %>% mutate(prop.va=(sum(subset(., Ho=="Và")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Và")
va_plot <- va_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.va, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=va_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=va_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(va_plot$prop.va[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Và")
```



```{r, lazy = TRUE}
va_sff <- dat_sff %>% mutate(prop.va=(sum(subset(., Ho=="Và")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Và")
va_plotf <- va_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.va, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=va_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(va_plotf$prop.va[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Và")
```

## Văn

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
van_sff <- dat_sff %>% mutate(prop.van=(sum(subset(., Ho=="Văn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Văn")
van_plot <- van_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.van, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
van_plot$centroid <- sf::st_transform(van_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

van <- van_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thanh Khai" & NAME_2=="Thanh Chuong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.van=as.numeric(round(prop.van, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.van, area_km, songuoi_km, lng, lat, distm_km)

van_peak <- van_plot %>% filter(NAME_3=="Xa Thanh Khai" & NAME_2=="Thanh Chuong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
van_sf <- dat_sf %>% mutate(prop.van=(sum(subset(., Ho=="Văn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Văn")
van_plot <- van_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.van, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=van_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=van_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(van_plot$prop.van[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Văn")
```



```{r, lazy = TRUE}
van_sff <- dat_sff %>% mutate(prop.van=(sum(subset(., Ho=="Văn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Văn")
van_plotf <- van_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.van, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=van_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(van_plotf$prop.van[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Văn")
```

## Vàng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vang_sff <- dat_sff %>% mutate(prop.vang=(sum(subset(., Ho=="Vàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vàng")
vang_plot <- vang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vang_plot$centroid <- sf::st_transform(vang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vang <- vang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hang Lia" & NAME_2=="Dien Bien Dong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vang=as.numeric(round(prop.vang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vang, area_km, songuoi_km, lng, lat, distm_km)

vang_peak <- vang_plot %>% filter(NAME_3=="Xa Hang Lia" & NAME_2=="Dien Bien Dong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vang_sf <- dat_sf %>% mutate(prop.vang=(sum(subset(., Ho=="Vàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vàng")
vang_plot <- vang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vang_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vang_plot$prop.vang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vàng")
```



```{r, lazy = TRUE}
vang_sff <- dat_sff %>% mutate(prop.vang=(sum(subset(., Ho=="Vàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vàng")
vang_plotf <- vang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vang_plotf$prop.vang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vàng")
```

## Vi

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vi_sff <- dat_sff %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
vi_plot <- vi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vi, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vi_plot$centroid <- sf::st_transform(vi_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vi <- vi_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Thanh" & NAME_2=="Thanh Ba"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vi=as.numeric(round(prop.vi, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vi, area_km, songuoi_km, lng, lat, distm_km)

vi_peak <- vi_plot %>% filter(NAME_3=="Xa Dong Thanh" & NAME_2=="Thanh Ba")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vi_sf <- dat_sf %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
vi_plot <- vi_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vi_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vi_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vi_plot$prop.vi[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vi")
```



```{r, lazy = TRUE}
vi_sff <- dat_sff %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
vi_plotf <- vi_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vi, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vi_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vi_plotf$prop.vi[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vi")
```

## Vì

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vi1_sff <- dat_sff %>% mutate(prop.vi1=(sum(subset(., Ho=="Vì")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vì")
vi1_plot <- vi1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vi1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vi1_plot$centroid <- sf::st_transform(vi1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vi1 <- vi1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chieng On" & NAME_2=="Yen Chau"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vi1=as.numeric(round(prop.vi1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vi1, area_km, songuoi_km, lng, lat, distm_km)

vi1_peak <- vi1_plot %>% filter(NAME_3=="Xa Chieng On" & NAME_2=="Yen Chau")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vi1_sf <- dat_sf %>% mutate(prop.vi1=(sum(subset(., Ho=="Vì")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vì")
vi1_plot <- vi1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vi1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vi1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vi1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vi1_plot$prop.vi1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vì")
```



```{r, lazy = TRUE}
vi1_sff <- dat_sff %>% mutate(prop.vi1=(sum(subset(., Ho=="Vì")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vì")
vi1_plotf <- vi1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vi1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vi1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vi1_plotf$prop.vi1[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vì")
```

## Võ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plot <- vo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vo, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vo_plot$centroid <- sf::st_transform(vo_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vo <- vo_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thien Loc" & NAME_2=="Can Loc"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vo=as.numeric(round(prop.vo, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vo, area_km, songuoi_km, lng, lat, distm_km)

vo_peak <- vo_plot %>% filter(NAME_3=="Xa Thien Loc" & NAME_2=="Can Loc")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plot <- vo_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vo_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vo_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vo_plot$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Võ")
```



```{r, lazy = TRUE}
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plotf <- vo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vo_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vo_plotf$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Võ")
```

## Vòng

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vong_sff <- dat_sff %>% mutate(prop.vong=(sum(subset(., Ho=="Vòng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vòng")
vong_plot <- vong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vong_plot$centroid <- sf::st_transform(vong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vong <- vong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quang Son" & NAME_2=="Hai Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vong=as.numeric(round(prop.vong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vong, area_km, songuoi_km, lng, lat, distm_km)

vong_peak <- vong_plot %>% filter(NAME_3=="Xa Quang Son" & NAME_2=="Hai Ha")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vong_sf <- dat_sf %>% mutate(prop.vong=(sum(subset(., Ho=="Vòng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vòng")
vong_plot <- vong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vong_plot$prop.vong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vòng")
```



```{r, lazy = TRUE}
vong_sff <- dat_sff %>% mutate(prop.vong=(sum(subset(., Ho=="Vòng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vòng")
vong_plotf <- vong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vong_plotf$prop.vong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vòng")
```

## Vu

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vu1_sff <- dat_sff %>% mutate(prop.vu1=(sum(subset(., Ho=="Vu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vu")
vu1_plot <- vu1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vu1, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vu1_plot$centroid <- sf::st_transform(vu1_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vu1 <- vu1_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thai Tho" & NAME_2=="Thai Thuy"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vu1=as.numeric(round(prop.vu1, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vu1, area_km, songuoi_km, lng, lat, distm_km)

vu1_peak <- vu1_plot %>% filter(NAME_3=="Xa Thai Tho" & NAME_2=="Thai Thuy")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vu1_sf <- dat_sf %>% mutate(prop.vu1=(sum(subset(., Ho=="Vu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vu")
vu1_plot <- vu1_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vu1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vu1_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vu1_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vu1_plot$prop.vu1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vu")
```



```{r, lazy = TRUE}
vu1_sff <- dat_sff %>% mutate(prop.vu1=(sum(subset(., Ho=="Vu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vu")
vu1_plotf <- vu1_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vu1, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vu1_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vu1_plotf$prop.vu1[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vu")
```

## Vũ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plot <- vu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vu_plot$centroid <- sf::st_transform(vu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vu <- vu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Chi Lang Bac" & NAME_2=="Thanh Mien"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vu=as.numeric(round(prop.vu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vu, area_km, songuoi_km, lng, lat, distm_km)

vu_peak <- vu_plot %>% filter(NAME_3=="Xa Chi Lang Bac" & NAME_2=="Thanh Mien")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plot <- vu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vu_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vu_plot$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vũ")
```



```{r, lazy = TRUE}
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plotf <- vu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vu_plotf$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vũ")
```

## Vừ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vu2_sff <- dat_sff %>% mutate(prop.vu2=(sum(subset(., Ho=="Vừ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vừ")
vu2_plot <- vu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vu2, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vu2_plot$centroid <- sf::st_transform(vu2_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vu2 <- vu2_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tay Son" & NAME_2=="Ky Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vu2=as.numeric(round(prop.vu2, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vu2, area_km, songuoi_km, lng, lat, distm_km)

vu2_peak <- vu2_plot %>% filter(NAME_3=="Xa Tay Son" & NAME_2=="Ky Son")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vu2_sf <- dat_sf %>% mutate(prop.vu2=(sum(subset(., Ho=="Vừ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vừ")
vu2_plot <- vu2_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vu2_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vu2_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vu2_plot$prop.vu2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vừ")
```



```{r, lazy = TRUE}
vu2_sff <- dat_sff %>% mutate(prop.vu2=(sum(subset(., Ho=="Vừ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vừ")
vu2_plotf <- vu2_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vu2, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vu2_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vu2_plotf$prop.vu2[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vừ")
```

## Vương

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vuong_sff <- dat_sff %>% mutate(prop.vuong=(sum(subset(., Ho=="Vương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vương")
vuong_plot <- vuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vuong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
vuong_plot$centroid <- sf::st_transform(vuong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

vuong <- vuong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cong Hoa" & NAME_2=="Quoc Oai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.vuong=as.numeric(round(prop.vuong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.vuong, area_km, songuoi_km, lng, lat, distm_km)

vuong_peak <- vuong_plot %>% filter(NAME_3=="Xa Cong Hoa" & NAME_2=="Quoc Oai")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
vuong_sf <- dat_sf %>% mutate(prop.vuong=(sum(subset(., Ho=="Vương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vương")
vuong_plot <- vuong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.vuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vuong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=vuong_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vuong_plot$prop.vuong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vương")
```



```{r, lazy = TRUE}
vuong_sff <- dat_sff %>% mutate(prop.vuong=(sum(subset(., Ho=="Vương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vương")
vuong_plotf <- vuong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.vuong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=vuong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(vuong_plotf$prop.vuong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Vương")
```

## Xa

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
xa_sff <- dat_sff %>% mutate(prop.xa=(sum(subset(., Ho=="Xa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Xa")
xa_plot <- xa_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.xa, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
xa_plot$centroid <- sf::st_transform(xa_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

xa <- xa_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Chum" & NAME_2=="Da Bac"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.xa=as.numeric(round(prop.xa, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.xa, area_km, songuoi_km, lng, lat, distm_km)

xa_peak <- xa_plot %>% filter(NAME_3=="Xa Dong Chum" & NAME_2=="Da Bac")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
xa_sf <- dat_sf %>% mutate(prop.xa=(sum(subset(., Ho=="Xa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Xa")
xa_plot <- xa_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.xa, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=xa_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=xa_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(xa_plot$prop.xa[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Xa")
```



```{r, lazy = TRUE}
xa_sff <- dat_sff %>% mutate(prop.xa=(sum(subset(., Ho=="Xa")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Xa")
xa_plotf <- xa_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.xa, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=xa_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(xa_plotf$prop.xa[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Xa")
```

## Y

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
y_sff <- dat_sff %>% mutate(prop.y=(sum(subset(., Ho=="Y")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Y")
y_plot <- y_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.y, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
y_plot$centroid <- sf::st_transform(y_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

y <- y_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Mang Ri" & NAME_2=="Tu Mo Rong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.y=as.numeric(round(prop.y, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.y, area_km, songuoi_km, lng, lat, distm_km)

y_peak <- y_plot %>% filter(NAME_3=="Xa Mang Ri" & NAME_2=="Tu Mo Rong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
y_sf <- dat_sf %>% mutate(prop.y=(sum(subset(., Ho=="Y")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Y")
y_plot <- y_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.y, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=y_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=y_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(y_plot$prop.y[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Y")
```



```{r, lazy = TRUE}
y_sff <- dat_sff %>% mutate(prop.y=(sum(subset(., Ho=="Y")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Y")
y_plotf <- y_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.y, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=y_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(y_plotf$prop.y[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Y")
```

## Ya

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ya_sff <- dat_sff %>% mutate(prop.ya=(sum(subset(., Ho=="Ya")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ya")
ya_plot <- ya_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ya, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ya_plot$centroid <- sf::st_transform(ya_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ya <- ya_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ta Nang" & NAME_2=="Duc Trong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ya=as.numeric(round(prop.ya, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ya, area_km, songuoi_km, lng, lat, distm_km)

ya_peak <- ya_plot %>% filter(NAME_3=="Xa Ta Nang" & NAME_2=="Duc Trong")

```



```{r, warning=FALSE, message=FALSE, lazy = TRUE}
ya_sf <- dat_sf %>% mutate(prop.ya=(sum(subset(., Ho=="Ya")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ya")
ya_plot <- ya_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ya, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ya_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ya_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ya_plot$prop.ya[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ya")
```



```{r, lazy = TRUE}
ya_sff <- dat_sff %>% mutate(prop.ya=(sum(subset(., Ho=="Ya")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ya")
ya_plotf <- ya_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ya, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ya_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(ya_plotf$prop.ya[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Ya")
```










